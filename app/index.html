<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>StenoAI</title>
    <!-- Distinctive typography - refined, professional -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
    (function() {
        var t = localStorage.getItem('theme') || 'system';
        var eff = t === 'system'
            ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
            : t;
        if (eff === 'light') document.documentElement.setAttribute('data-theme', 'light');
    })();
    </script>
    <style>
        :root {
            /* Refined color palette - softer contrast */
            --bg-deep: #0a0a0b;
            --bg-primary: #111113;
            --bg-elevated: #18181b;
            --bg-surface: #1f1f23;
            --border-subtle: #27272a;
            --border-default: #3f3f46;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-primary: #818cf8;
            --accent-glow: rgba(129, 140, 248, 0.15);
            --recording-red: #ef4444;
            --recording-glow: rgba(239, 68, 68, 0.2);
            --success-green: #22c55e;
            --warning-amber: #f59e0b;
        }

        [data-theme="light"] {
            --bg-deep: #e9ecf0;
            --bg-primary: #f1f3f6;
            --bg-elevated: #e1e5ea;
            --bg-surface: #d8dce3;
            --border-subtle: #cdd2d9;
            --border-default: #a8b0b9;
            --text-primary: #1a1d21;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --accent-primary: #5b5fc7;
            --accent-glow: rgba(91, 95, 199, 0.12);
            --recording-red: #dc3545;
            --recording-glow: rgba(220, 53, 69, 0.15);
            --success-green: #198754;
            --warning-amber: #d97706;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Subtle noise texture for depth */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
        }
        
        /* Window drag area - make the top portion draggable */
        .drag-area {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 28px;
            -webkit-app-region: drag;
            z-index: 100;
        }
        
        /* Make interactive elements non-draggable */
        .no-drag, .btn, .session-input, .settings-btn, button, input, select, textarea {
            -webkit-app-region: no-drag;
            pointer-events: auto;
        }
        
        /* Header with record controls */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 28px 20px 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: padding-top 0.3s ease;
            background: linear-gradient(180deg, var(--bg-elevated) 0%, var(--bg-primary) 100%);
            -webkit-app-region: drag;
        }

        .header.with-announcement-banner {
            padding-top: 76px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            -webkit-app-region: no-drag;
        }

        .brand svg {
            transition: all 0.3s ease;
        }

        .brand:hover svg {
            filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.5));
            transform: scale(1.05);
        }

        .brand h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #6366f1, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Prominent recording timer */
        .recording-timer {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--recording-red);
            background: rgba(239, 68, 68, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(239, 68, 68, 0.2);
            letter-spacing: 0.05em;
        }

        .header-actions {
            display: flex;
            align-items: center;
        }

        .settings-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .settings-btn:hover {
            background: var(--bg-surface);
            border-color: var(--border-default);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .settings-btn:active {
            transform: translateY(0);
        }

        .record-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .session-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text-primary);
            padding: 6px 4px;
            font-size: 14px;
            font-family: inherit;
            min-width: 180px;
            outline: none;
            transition: all 0.2s ease;
        }

        .session-input:hover {
            border-bottom-color: var(--border-subtle);
        }

        .session-input:focus {
            border-bottom-color: var(--accent-primary);
            background: transparent;
            box-shadow: none;
        }

        .session-input::placeholder {
            color: var(--text-muted);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s ease;
        }

        .status-dot.ready {
            background: var(--success-green);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
        }
        .status-dot.recording {
            background: var(--recording-red);
            box-shadow: 0 0 12px var(--recording-glow), 0 0 24px var(--recording-glow);
            animation: recordingPulse 1.5s ease-in-out infinite;
        }
        .status-dot.processing {
            background: var(--warning-amber);
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes recordingPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 12px var(--recording-glow), 0 0 24px var(--recording-glow);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 16px var(--recording-glow), 0 0 32px var(--recording-glow);
            }
        }

        /* Audio waveform animation for recording state */
        .waveform {
            display: none;
            align-items: center;
            gap: 2px;
            height: 16px;
            margin-left: 8px;
        }

        .recording .waveform {
            display: flex;
        }

        .waveform-bar {
            width: 3px;
            background: var(--recording-red);
            border-radius: 2px;
            animation: waveform 0.8s ease-in-out infinite;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; height: 8px; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; height: 12px; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; height: 16px; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; height: 10px; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; height: 6px; }

        @keyframes waveform {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        .btn {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            padding: 6px 14px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 7px;
            font-family: inherit;
        }

        .btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-default);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-color: var(--border-default);
            font-weight: 600;
        }

        .btn-primary:hover {
            background: var(--bg-surface);
            border-color: var(--border-default);
        }

        .btn-danger {
            background: var(--recording-red);
            border-color: var(--recording-red);
            box-shadow: 0 0 20px var(--recording-glow);
        }

        .btn-danger:hover {
            background: var(--recording-red);
            filter: brightness(0.9);
            box-shadow: 0 0 28px var(--recording-glow);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Unified Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -480px;
            width: 480px;
            height: 100vh;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-subtle);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .settings-close:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .settings-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .settings-nav {
            width: 140px;
            background: var(--bg-elevated);
            border-right: 1px solid var(--border-subtle);
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex-shrink: 0;
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            border-left: 2px solid transparent;
        }

        .settings-nav-item:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .settings-nav-item.active {
            background: var(--bg-surface);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
        }

        .settings-nav-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-tab {
            display: none;
        }

        .settings-tab.active {
            display: block;
        }

        .settings-section {
            margin-bottom: 28px;
        }

        .settings-section h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-section h4 {
            margin: 16px 0 8px 0;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .settings-section p {
            margin: 0 0 12px 0;
            color: var(--text-muted);
            font-size: 13px;
            line-height: 1.5;
        }

        /* Settings row layout */
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .settings-row:last-of-type,
        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-row-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .settings-row-text span {
            font-size: 13px;
            color: var(--text-primary);
        }

        .settings-row-text small {
            font-size: 12px;
            color: var(--text-muted);
        }

        .settings-action-btn {
            background: var(--bg-surface);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 12px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .settings-action-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .settings-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .settings-toggle {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }

        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .settings-toggle .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-default);
            border-radius: 11px;
            transition: background 0.2s ease;
        }

        .settings-toggle .toggle-slider:before {
            content: "";
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .settings-toggle input:checked + .toggle-slider {
            background: var(--accent-primary);
        }

        .settings-toggle input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        /* Full-width developer tab: hide nav */
        .settings-body.developer-active .settings-nav {
            display: none;
        }

        .dev-tab-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .dev-back-btn {
            background: none;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s ease;
        }

        .dev-back-btn:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-color: var(--border-default);
        }

        /* Debug console in developer tab */
        .debug-console {
            flex: 1;
            background: var(--bg-deep);
            color: var(--text-muted);
            padding: 16px;
            font-family: 'JetBrains Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 11px;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            min-height: 300px;
            max-height: calc(100vh - 200px);
        }

        .debug-console::-webkit-scrollbar {
            width: 8px;
        }

        .debug-console::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .debug-console::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        .debug-console::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .settings-version {
            margin-top: 20px;
            padding-top: 16px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Model list in AI tab */
        .model-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: var(--border-subtle);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }

        .model-list-loading {
            padding: 12px;
            color: var(--text-muted);
            font-size: 13px;
            background: var(--bg-elevated);
        }

        .model-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-elevated);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .model-item:hover {
            background: var(--bg-surface);
        }

        .model-item.active {
            background: rgba(129, 140, 248, 0.08);
        }

        .model-item-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
            flex: 1;
        }

        .model-item-name {
            font-size: 13px;
            font-weight: 500;
            font-family: 'JetBrains Mono', Monaco, monospace;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .model-item-name .model-tag {
            font-size: 10px;
            font-weight: 500;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-muted);
            background: var(--bg-deep);
            padding: 1px 5px;
            border-radius: 3px;
        }

        .model-item-name .model-active-badge {
            font-size: 10px;
            font-weight: 600;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--accent-primary);
        }

        .model-item-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .model-item-action {
            flex-shrink: 0;
            margin-left: 12px;
        }

        .model-item .model-progress {
            display: none;
            margin-top: 4px;
        }

        .model-item .progress-text {
            font-size: 10px;
            color: var(--success-green);
            font-family: 'JetBrains Mono', Monaco, monospace;
        }

        /* Model list scrollbar */
        .model-list::-webkit-scrollbar {
            width: 8px;
        }

        .model-list::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .model-list::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        .model-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Main content area */
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Sidebar with meetings list */
        .sidebar {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            width: 0;
            min-width: 0;
        }

        .sidebar.collapsed .sidebar-header,
        .sidebar.collapsed .meetings-list {
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-toggle {
            position: fixed;
            left: 319px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 48px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-left: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 12px;
            z-index: 100;
            transition: left 0.3s ease, background 0.2s ease;
        }

        .sidebar-toggle:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .sidebar-toggle.collapsed {
            left: 0;
        }

        .sidebar-toggle-icon {
            transition: transform 0.3s ease;
        }

        .sidebar-toggle.collapsed .sidebar-toggle-icon {
            transform: rotate(180deg);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .sidebar-header h2 {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        
        .search-input {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
            outline: none;
            margin: 12px 0 8px 0;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            background: var(--bg-elevated);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .sidebar-header p {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .meetings-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        
        .meeting-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .meeting-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-surface);
            border: none;
            color: var(--text-muted);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }

        .meeting-item:hover .meeting-delete {
            opacity: 1;
        }

        .meeting-delete:hover {
            background: var(--recording-red);
            color: var(--text-primary);
        }

        .meeting-item:hover {
            background: var(--bg-surface);
            border-color: var(--border-default);
            transform: translateX(2px);
        }

        .meeting-item.active {
            background: var(--bg-surface);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 1px var(--accent-primary), 0 0 20px var(--accent-glow);
        }

        /* Staggered fade-in animation for meeting items */
        .meeting-item {
            animation: fadeSlideIn 0.3s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .meeting-item:nth-child(1) { animation-delay: 0.02s; }
        .meeting-item:nth-child(2) { animation-delay: 0.04s; }
        .meeting-item:nth-child(3) { animation-delay: 0.06s; }
        .meeting-item:nth-child(4) { animation-delay: 0.08s; }
        .meeting-item:nth-child(5) { animation-delay: 0.10s; }
        .meeting-item:nth-child(6) { animation-delay: 0.12s; }
        .meeting-item:nth-child(7) { animation-delay: 0.14s; }
        .meeting-item:nth-child(8) { animation-delay: 0.16s; }
        .meeting-item:nth-child(9) { animation-delay: 0.18s; }
        .meeting-item:nth-child(10) { animation-delay: 0.20s; }

        /* Action items badge on meeting cards */
        .meeting-badges {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }

        .meeting-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 4px;
            background: var(--bg-deep);
            color: var(--text-muted);
        }

        .meeting-badge.actions {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .meeting-badge.participants {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success-green);
        }
        
        .meeting-item.processing {
            background: var(--bg-elevated);
            border-color: var(--warning-amber);
            opacity: 0.7;
            position: relative;
        }
        
        .meeting-item.processing .processing-overlay {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: var(--bg-deep);
            border-radius: 4px;
            padding: 4px 8px;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning-amber);
            font-size: 12px;
            font-weight: 500;
        }
        
        .processing-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-surface);
            border-top: 2px solid var(--warning-amber);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .meeting-item h3 {
            font-size: 13px;
            font-weight: 600;
            color: color-mix(in srgb, var(--text-primary) 40%, var(--text-secondary));
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .meeting-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .meeting-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .meeting-duration {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--bg-deep);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .meeting-preview {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Main content area */
        .content {
            flex: 1;
            background: var(--bg-deep);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            color: var(--text-muted);
            padding: 40px;
        }

        .content-empty-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.3;
            filter: grayscale(0.5);
        }

        .content-empty h3 {
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .content-empty p {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .shortcut-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 8px;
        }

        .shortcut-hint span {
            color: var(--text-muted);
            font-size: 13px;
        }

        .kbd {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-bottom-width: 2px;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* Meeting detail view */
        .meeting-detail {
            padding: 32px;
            height: 100%;
            overflow-y: auto;
            display: none;
        }
        
        .meeting-detail.show {
            display: block;
        }
        
        .meeting-header {
            margin-bottom: 36px;
            padding-bottom: 28px;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .meeting-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .meeting-title {
            font-size: 26px;
            font-weight: 700;
            color: color-mix(in srgb, var(--text-primary) 40%, var(--text-secondary));
            margin: 0;
            flex: 1;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }
        
        .reprocess-btn {
            background: var(--bg-surface);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .reprocess-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .reprocess-btn:active {
            transform: translateY(0);
        }

        .reprocess-btn:disabled {
            background: var(--bg-surface);
            color: var(--text-muted);
            border-color: var(--border-subtle);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .reprocess-btn.processing {
            background: var(--warning-amber);
            color: var(--bg-deep);
            border-color: var(--warning-amber);
        }
        
        .reprocess-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .transcript-container {
            position: relative;
        }
        
        .copy-transcript-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-transcript-btn:hover {
            background: var(--bg-elevated);
            opacity: 1;
            transform: translateY(-1px);
        }
        
        .copy-transcript-btn:active {
            transform: translateY(0);
        }
        
        .copy-transcript-btn.copied {
            background: var(--success-green);
            border-color: var(--success-green);
            opacity: 1;
        }

        .copy-notes-btn {
            background: var(--bg-surface);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 4px 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .copy-notes-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .copy-notes-btn:active {
            transform: translateY(1px);
        }

        .copy-notes-btn.copied {
            background: var(--success-green);
            border-color: var(--success-green);
            color: var(--bg-primary);
        }

        .meeting-title-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0;
            max-width: fit-content;
        }

        .meeting-title {
            margin: 0;
            color: color-mix(in srgb, var(--text-primary) 40%, var(--text-secondary));
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 600px;
        }

        .meeting-title-input {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 24px;
            font-weight: 600;
            outline: none;
            flex: 1;
        }

        .meeting-title-input:focus {
            border-color: var(--text-muted);
            background: var(--bg-surface);
        }

        .edit-title-btn {
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-muted);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }

        .meeting-title-container:hover .edit-title-btn {
            opacity: 1;
        }

        .edit-title-btn:hover {
            background: var(--bg-surface);
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        .title-edit-actions {
            display: flex;
            gap: 8px;
        }

        .save-title-btn, .cancel-title-btn {
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            border: 1px solid;
        }

        .save-title-btn {
            background: var(--success-green);
            border-color: var(--success-green);
            color: var(--bg-primary);
        }

        .save-title-btn:hover {
            background: var(--success-green);
            filter: brightness(0.9);
        }

        .cancel-title-btn {
            background: transparent;
            border-color: var(--border-default);
            color: var(--text-muted);
        }

        .cancel-title-btn:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .meeting-info {
            display: flex;
            gap: 24px;
            align-items: center;
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 10px;
        }
        
        .meeting-section {
            margin-bottom: 36px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: -0.01em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-content {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 15px;
        }
        
        .key-points-list {
            list-style: none;
            padding: 0;
        }

        .key-points-list li {
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .key-points-list li:before {
            content: "";
            position: absolute;
            left: 0;
            top: 14px;
            width: 5px;
            height: 5px;
            background: var(--accent-primary);
            border-radius: 50%;
        }

        .action-items-list {
            list-style: none;
            padding: 0;
        }

        .action-items-list li {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--accent-primary);
            border-radius: 0 8px 8px 0;
            padding: 14px 16px;
            margin-bottom: 10px;
            color: var(--text-secondary);
            line-height: 1.6;
            transition: all 0.2s ease;
        }

        .action-items-list li:hover {
            background: var(--bg-surface);
            border-left-color: var(--success-green);
        }
        
        /* Transcript section */
        .transcript-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 24px;
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.8;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* File drop area */
        .drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .drop-zone.active {
            display: flex;
        }
        
        .drop-message {
            text-align: center;
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Announcement Banner */
        .announcement-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            color: white;
            padding: 12px 20px 12px 80px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 1500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
        }

        .announcement-banner.type-info {
            background: linear-gradient(135deg, #0ea5e9, #06b6d4);
        }

        .announcement-banner.type-release {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
        }

        .announcement-banner.type-warning {
            background: linear-gradient(135deg, #d97706, #f59e0b);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromBottom {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOutToBottom {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        .announcement-banner.show {
            display: flex;
        }

        .announcement-info {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .announcement-icon {
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .announcement-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .announcement-text {
            font-size: 14px;
            min-width: 0;
        }

        .announcement-text .announcement-title {
            font-weight: 600;
        }

        .announcement-text .announcement-message {
            opacity: 0.9;
            margin-left: 6px;
        }

        .announcement-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .announcement-btn {
            background: white;
            border: none;
            color: #4F46E5;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .type-info .announcement-btn {
            color: #0e7490;
        }

        .type-warning .announcement-btn {
            color: #92400e;
        }

        .announcement-btn:hover {
            background: #f3f4f6;
        }

        .dismiss-announcement {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 2px;
            transition: color 0.2s;
        }

        .dismiss-announcement:hover {
            color: white;
        }

        /* Setup Modal */
        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .setup-content {
            background: var(--bg-primary);
            border: 1px solid var(--bg-surface);
            border-radius: 12px;
            padding: 32px;
            width: 600px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .setup-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .setup-header .btn-primary {
            margin-top: 20px;
            font-size: 16px;
            padding: 12px 24px;
        }
        
        .setup-header h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .setup-header p {
            font-size: 16px;
            color: var(--text-muted);
        }
        
        .setup-steps {
            margin-bottom: 32px;
        }
        
        .setup-step {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            margin-bottom: 12px;
            background: var(--bg-elevated);
            border: 1px solid var(--bg-surface);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .setup-step.active {
            border-color: var(--border-default);
            background: var(--bg-surface);
        }
        
        .setup-step.completed {
            border-color: var(--success-green);
            background: rgba(34, 197, 94, 0.08);
        }

        .setup-step.failed {
            border-color: var(--recording-red);
            background: rgba(239, 68, 68, 0.08);
        }
        
        .step-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }
        
        .step-content {
            flex: 1;
        }
        
        .step-content h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .step-content p {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .step-status {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-surface);
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--warning-amber);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }
        
        .setup-step.completed .progress-fill {
            background: var(--success-green);
            width: 100%;
        }
        
        .setup-step.active .step-status {
            color: var(--warning-amber);
        }

        .setup-step.completed .step-status {
            color: var(--success-green);
        }

        .setup-step.failed .step-status {
            color: var(--recording-red);
        }
        
        .setup-actions {
            display: flex;
            justify-content: space-between;
            gap: 12px;
        }
        
        .setup-actions .btn {
            flex: 1;
        }

        /* AI Query Popup */
        .ai-query-popup {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            display: none;
            justify-content: center;
            padding: 24px;
            pointer-events: none;
        }

        .ai-query-popup.show {
            display: flex;
        }

        .ai-query-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
            width: 100%;
            max-width: 600px;
            pointer-events: auto;
            animation: slideUp 0.2s ease-out;
            backdrop-filter: blur(12px);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .ai-query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .ai-query-header span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-query-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .ai-query-close:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .ai-query-input-row {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
        }

        #ai-query-input {
            flex: 1;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: all 0.2s ease;
        }

        #ai-query-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        #ai-query-input::placeholder {
            color: var(--text-muted);
        }

        .ai-query-submit {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-query-submit:hover {
            background: var(--accent-primary);
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .ai-query-submit:active {
            transform: translateY(0);
        }

        .ai-query-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-query-response {
            padding: 0 20px 20px;
            display: none;
        }

        .ai-query-response.show {
            display: block;
        }

        .ai-query-response-content {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 16px;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .ai-query-response-content.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-muted);
            padding: 24px;
        }

        .ai-query-response-content.error {
            color: var(--recording-red);
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .ai-query-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ask AI Button */
        .ask-ai-btn {
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.15) 0%, rgba(99, 102, 241, 0.15) 100%);
            border: 1px solid rgba(129, 140, 248, 0.3);
            color: var(--accent-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ask-ai-btn:hover {
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.25) 0%, rgba(99, 102, 241, 0.25) 100%);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .ask-ai-btn kbd {
            background: rgba(129, 140, 248, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-family: inherit;
            margin-left: 4px;
        }

        /* Light mode specific overrides */
        [data-theme="light"] .brand h1 {
            background: linear-gradient(135deg, #4338ca, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        [data-theme="light"] .brand svg rect:first-child {
            fill: #e0e7ff;
        }
        [data-theme="light"] .brand svg path {
            fill: #4338ca;
        }

        [data-theme="light"] body {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }

        [data-theme="light"] .announcement-banner.type-info {
            background: linear-gradient(135deg, #0284c7, #0891b2);
        }
        [data-theme="light"] .announcement-banner.type-release {
            background: linear-gradient(135deg, #4338ca, #6366f1);
        }
        [data-theme="light"] .announcement-banner.type-warning {
            background: linear-gradient(135deg, #c2410c, #d97706);
        }

        [data-theme="light"] .ai-query-container {
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="light"] .setup-content {
            background: var(--bg-primary);
            border-color: var(--border-subtle);
        }

        [data-theme="light"] .setup-step.completed {
            border-color: var(--success-green);
            background: rgba(25, 135, 84, 0.06);
        }
        [data-theme="light"] .setup-step.failed {
            border-color: var(--recording-red);
            background: rgba(220, 53, 69, 0.06);
        }

        [data-theme="light"] ::-webkit-scrollbar-track {
            background: var(--bg-elevated);
        }
        [data-theme="light"] ::-webkit-scrollbar-thumb {
            background: var(--border-default);
        }

        /* Theme select dropdown */
        .theme-select {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            flex-shrink: 0;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2371717a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 26px;
        }

        .theme-select:hover {
            border-color: var(--accent-primary);
        }

        .theme-select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
    </style>
</head>
<body>
    <!-- Window drag area -->
    <div class="drag-area"></div>
    
    <!-- Announcement Banner -->
    <div class="announcement-banner" id="announcement-banner">
        <div class="announcement-info">
            <div class="announcement-icon" id="announcement-icon"></div>
            <div class="announcement-text">
                <span class="announcement-title" id="announcement-title"></span>
                <span class="announcement-message" id="announcement-message"></span>
            </div>
        </div>
        <div class="announcement-actions">
            <button class="announcement-btn" id="announcement-action-btn" style="display:none;">Learn More</button>
            <button class="dismiss-announcement" id="dismiss-announcement-btn" title="Dismiss">&#x2715;</button>
        </div>
    </div>

    <!-- Header with recording controls -->
    <div class="header">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="32" height="32" rx="8" fill="#0f172a"/>
                <rect width="30" height="30" x="1" y="1" rx="7" stroke="rgba(255,255,255,0.1)"/>
                <path d="M16 10c-1.1 0-2 .9-2 2v4c0 1.1.9 2 2 2s2-.9 2-2v-4c0-1.1-.9-2-2-2z" fill="white"/>
                <path d="M12 15v1c0 2.2 1.8 4 4 4s4-1.8 4-4v-1h1v1c0 2.7-1.9 4.9-4.5 5.4v1.6h2v1h-5v-1h2v-1.6c-2.6-.5-4.5-2.7-4.5-5.4v-1h1z" fill="white"/>
            </svg>
            <h1>StenoAI</h1>
        </div>
        
        <div class="record-controls">
            <div class="status" id="status-container">
                <div class="status-dot ready" id="status-dot"></div>
                <span id="status-text" style="font-size: 13px; color: var(--text-secondary);">Ready</span>
                <div class="waveform" id="waveform">
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                </div>
            </div>
            
            <input type="text" class="session-input" id="session-name" placeholder="Name this session...">
            
            <button class="btn btn-primary" id="start-btn">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="5"/></svg> Record
            </button>

            <button class="btn btn-danger" id="stop-btn" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="1" y="1" width="10" height="10" rx="1.5"/></svg> Stop
            </button>

            <button class="btn" id="pause-btn" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="1.5" y="1" width="3" height="10" rx="1"/><rect x="7.5" y="1" width="3" height="10" rx="1"/></svg> Pause
            </button>
        </div>
        
        <div class="header-actions">
            <button class="settings-btn" id="settings-btn" title="Settings (Cmd+,)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Main content area -->
    <div class="main">
        <!-- Sidebar toggle (outside sidebar so it's always visible) -->
        <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
            <span class="sidebar-toggle-icon"></span>
        </button>

        <!-- Sidebar with meetings -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <h2>Meetings</h2>
                </div>
                <input type="text" class="search-input" id="search-input" placeholder="Search meetings...">
            </div>
            
            <div class="meetings-list" id="meetings-list">
                <!-- Meetings will be loaded here -->
            </div>
        </div>

        <!-- Main content -->
        <div class="content">
            <!-- Empty state -->
            <div class="content-empty" id="empty-state">
                <h3>Ready to capture your meeting</h3>
                <p>Select a meeting from the sidebar or start recording</p>
                <div class="shortcut-hint">
                    <span>Quick start:</span>
                    <kbd class="kbd"></kbd>
                    <kbd class="kbd"></kbd>
                    <kbd class="kbd">R</kbd>
                    <span>anywhere</span>
                </div>
            </div>

            <!-- Meeting detail view -->
            <div class="meeting-detail" id="meeting-detail">
                <div class="meeting-header">
                    <div class="meeting-header-top">
                        <div class="meeting-title-container">
                            <h1 class="meeting-title" id="detail-title">Meeting Title</h1>
                            <button class="edit-title-btn" id="edit-title-btn" title="Edit meeting name">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="ask-ai-btn" id="ask-ai-btn" title="Ask AI about this meeting (Cmd+K)">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                Ask AI
                                <kbd>K</kbd>
                            </button>
                            <button class="copy-notes-btn" id="copy-notes-btn" title="Copy meeting notes">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <button class="reprocess-btn" id="reprocess-btn" title="Reprocess meeting">
                                
                            </button>
                        </div>
                    </div>
                    <div class="meeting-info">
                        <span id="detail-date">Date</span>
                        <span id="detail-duration">Duration</span>
                    </div>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Summary
                    </h2>
                    <div class="section-content" id="detail-summary">
                        Meeting summary will appear here...
                    </div>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Participants
                    </h2>
                    <div class="section-content" id="detail-participants">
                        <!-- Participants will be loaded here -->
                    </div>
                </div>

                <div class="meeting-section" id="discussion-areas-section">
                    <h2 class="section-title">
                        <span></span> Key Topics
                    </h2>
                    <div class="discussion-areas-container" id="detail-discussion-areas">
                        <!-- Key topics will be loaded here -->
                    </div>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Key Points
                    </h2>
                    <ul class="key-points-list" id="detail-key-points">
                        <!-- Key points will be loaded here -->
                    </ul>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Action Items
                    </h2>
                    <ul class="action-items-list" id="detail-action-items">
                        <!-- Action items will be loaded here -->
                    </ul>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Full Transcript
                    </h2>
                    <div class="transcript-container">
                        <div class="transcript-content" id="detail-transcript">
                            Full transcript will appear here...
                        </div>
                        <button class="copy-transcript-btn" id="copy-transcript-btn" title="Copy transcript to clipboard">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drop zone for files -->
    <div class="drop-zone" id="drop-zone">
        <div class="drop-message">
            Drop audio file to process
        </div>
    </div>

    <!-- AI Query Popup -->
    <div class="ai-query-popup" id="ai-query-popup">
        <div class="ai-query-container">
            <div class="ai-query-header">
                <span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Ask Steno about this meeting
                </span>
                <button class="ai-query-close" id="ai-query-close">&times;</button>
            </div>
            <div class="ai-query-input-row">
                <input type="text" id="ai-query-input" placeholder="What was discussed about...">
                <button class="ai-query-submit" id="ai-query-submit">
                    Ask
                </button>
            </div>
            <div class="ai-query-response" id="ai-query-response">
                <div class="ai-query-response-content" id="ai-query-response-content"></div>
            </div>
        </div>
    </div>

    <!-- Setup overlay -->
    <div class="setup-modal" id="setup-overlay" style="display: none;">
        <div class="setup-content">
            <div class="setup-header">
                <h2> Welcome to StenoAI</h2>
                <p>Setting up your system for meeting transcription...</p>
                <p style="font-size: 14px; color: var(--text-muted); margin-top: 12px;"> Scroll down to see logs</p>
            </div>

            <div class="setup-steps" id="setup-steps">
                <div class="setup-step" id="step-microphone">
                    <div class="step-icon"></div>
                    <div class="step-content">
                        <h3>Microphone Access</h3>
                        <p>Grant microphone permission for meeting recording</p>
                        <div class="step-status" id="microphone-status">Pending...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="microphone-progress"></div>
                        </div>
                    </div>
                </div>

                <div class="setup-step" id="step-system">
                    <div class="step-icon"></div>
                    <div class="step-content">
                        <h3>System Check</h3>
                        <p>Checking Python and system requirements...</p>
                        <div class="step-status" id="system-status">Pending...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="system-progress"></div>
                        </div>
                    </div>
                </div>

                
                <div class="setup-step" id="step-python">
                    <div class="step-icon"></div>
                    <div class="step-content">
                        <h3>Python Dependencies</h3>
                        <p>Installing audio libraries</p>
                        <div class="step-status" id="python-status">Pending...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="python-progress"></div>
                        </div>
                    </div>
                </div>
                
                <div class="setup-step" id="step-whisper">
                    <div class="step-icon"></div>
                    <div class="step-content">
                        <h3>Install Whisper</h3>
                        <p>OpenAI's speech recognition engine</p>
                        <div class="step-status" id="whisper-status">Pending...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="whisper-progress"></div>
                        </div>
                    </div>
                </div>
                
                <div class="setup-step" id="step-ollama">
                    <div class="step-icon"></div>
                    <div class="step-content">
                        <h3>Install Ollama + AI Model</h3>
                        <p>Homebrew (if needed)  Ollama  Llama 3.2 model (~2GB)</p>
                        <div class="step-status" id="ollama-status">Pending...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="ollama-progress"></div>
                        </div>
                    </div>
                </div>
                
                <div class="setup-step" id="step-ffmpeg">
                    <div class="step-icon"></div>
                    <div class="step-content">
                        <h3>Install ffmpeg</h3>
                        <p>Audio/video processing toolkit for advanced audio handling</p>
                        <div class="step-status" id="ffmpeg-status">Pending...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="ffmpeg-progress"></div>
                        </div>
                    </div>
                </div>
                
                <div class="setup-step" id="step-test">
                    <div class="step-icon"></div>
                    <div class="step-content">
                        <h3>Test System</h3>
                        <p>Verifying everything works</p>
                        <div class="step-status" id="test-status">Pending...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="test-progress"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="setup-debug" style="margin: 24px 0;">
                <h3 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px; font-size: 16px;">
                    <span> Debug Console</span>
                    <button onclick="toggleDebugConsole()" style="background: none; border: 1px solid var(--bg-surface); color: var(--text-muted); padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">Toggle</button>
                </h3>
                <div id="debug-console" style="background: var(--bg-deep); border: 1px solid var(--bg-surface); border-radius: 6px; padding: 12px; font-family: 'Monaco', 'Menlo', monospace; font-size: 11px; line-height: 1.4; color: var(--text-secondary); height: 200px; overflow-y: auto; white-space: pre-wrap;">Welcome to StenoAI Setup Debug Console
Commands and output will appear here...

</div>
            </div>

            <div class="setup-actions">
                <button class="btn btn-primary" id="setup-auto-start">Begin First-Time Setup</button>
                <button class="btn btn-primary" id="setup-continue" style="display: none;">Continue to App</button>
            </div>
        </div>
    </div>

    <!-- Unified Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="settings-close" onclick="toggleSettings()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="settings-body">
            <nav class="settings-nav">
                <button class="settings-nav-item active" data-tab="general">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    General
                </button>
                <button class="settings-nav-item" data-tab="ai">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a4 4 0 0 1 4 4c0 1.1-.9 2-2 2h-4c-1.1 0-2-.9-2-2a4 4 0 0 1 4-4z"></path>
                        <path d="M12 8v2"></path>
                        <path d="M8 14h8"></path>
                        <path d="M9 18h6"></path>
                        <path d="M10 22h4"></path>
                        <path d="M12 10v4"></path>
                    </svg>
                    AI
                </button>
                <button class="settings-nav-item" data-tab="developer" id="developer-nav-item" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="16 18 22 12 16 6"></polyline>
                        <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    Developer
                </button>
            </nav>
            <div class="settings-content">
                <!-- General Tab -->
                <div class="settings-tab active" id="tab-general">
                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Appearance</span>
                            <small>Choose light, dark, or match your system</small>
                        </div>
                        <select class="theme-select" id="theme-select">
                            <option value="system">System</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Desktop notifications</span>
                            <small>Notify when meetings finish processing</small>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="notifications-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Check for updates</span>
                            <small>Updates and announcements</small>
                        </div>
                        <button class="settings-action-btn" id="test-update-btn" onclick="testUpdateCheck()">Check</button>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Setup wizard</span>
                            <small>Reinstall dependencies or fix configuration</small>
                        </div>
                        <button class="settings-action-btn" id="run-setup-btn" onclick="runSetupFromSettings()">Run</button>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Clear recording state</span>
                            <small>Fix stuck recordings or processing</small>
                        </div>
                        <button class="settings-action-btn" id="clear-state-btn" onclick="clearSystemState()">Clear</button>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Developer mode</span>
                            <small>Show debug logs and developer tools</small>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="developer-mode-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Anonymous usage analytics</span>
                            <small>Help improve StenoAI -- no meeting content is ever sent</small>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="telemetry-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="settings-version">
                        StenoAI <span id="app-version">Loading...</span>
                    </div>
                </div>

                <!-- AI Tab -->
                <div class="settings-tab" id="tab-ai">
                    <div class="settings-section">
                        <h3>Model</h3>
                        <div id="model-list" class="model-list">
                            <div class="model-list-loading">Loading models...</div>
                        </div>
                    </div>

                </div>

                <!-- Developer Tab -->
                <div class="settings-tab" id="tab-developer">
                    <div class="dev-tab-header">
                        <button class="dev-back-btn" id="dev-back-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Back
                        </button>
                        <h3 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0;">Debug Console</h3>
                    </div>
                    <div class="settings-section" style="margin-bottom: 0;">
                        <p>Real-time log output from the backend processes.</p>
                        <div class="debug-console" id="debug-console-panel">StenoAI Debug Console
Session started - waiting for activity...

</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // UI Elements
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const sessionNameInput = document.getElementById('session-name');

        // Sidebar toggle functionality
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');

        // Restore sidebar state from localStorage
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar.classList.add('collapsed');
            sidebarToggle.classList.add('collapsed');
        }

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            sidebarToggle.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });

        // Brand click - return to home state
        document.querySelector('.brand').addEventListener('click', () => {
            selectedMeeting = null;
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('meeting-detail').classList.remove('show');
            document.querySelectorAll('.meeting-item').forEach(item => item.classList.remove('active'));
        });

        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const meetingsList = document.getElementById('meetings-list');
        const emptyState = document.getElementById('empty-state');
        const meetingDetail = document.getElementById('meeting-detail');
        const dropZone = document.getElementById('drop-zone');
        
        // Announcement elements
        const announcementBanner = document.getElementById('announcement-banner');
        const announcementIcon = document.getElementById('announcement-icon');
        const announcementTitle = document.getElementById('announcement-title');
        const announcementMessage = document.getElementById('announcement-message');
        const announcementActionBtn = document.getElementById('announcement-action-btn');
        const dismissAnnouncementBtn = document.getElementById('dismiss-announcement-btn');
        
        // Detail elements
        const detailTitle = document.getElementById('detail-title');
        const detailDate = document.getElementById('detail-date');
        const detailDuration = document.getElementById('detail-duration');
        const detailSummary = document.getElementById('detail-summary');
        const detailParticipants = document.getElementById('detail-participants');
        const detailKeyPoints = document.getElementById('detail-key-points');
        const detailActionItems = document.getElementById('detail-action-items');
        const detailTranscript = document.getElementById('detail-transcript');
        const reprocessBtn = document.getElementById('reprocess-btn');
        const copyTranscriptBtn = document.getElementById('copy-transcript-btn');
        const copyNotesBtn = document.getElementById('copy-notes-btn');
        const editTitleBtn = document.getElementById('edit-title-btn');

        // AI Query elements
        const askAiBtn = document.getElementById('ask-ai-btn');
        const aiQueryPopup = document.getElementById('ai-query-popup');
        const aiQueryClose = document.getElementById('ai-query-close');
        const aiQueryInput = document.getElementById('ai-query-input');
        const aiQuerySubmit = document.getElementById('ai-query-submit');
        const aiQueryResponse = document.getElementById('ai-query-response');
        const aiQueryResponseContent = document.getElementById('ai-query-response-content');

        // Setup elements
        const setupOverlay = document.getElementById('setup-overlay');
        const setupAutoStart = document.getElementById('setup-auto-start');
        const setupContinue = document.getElementById('setup-continue');
        
        let uiState = 'ready'; // ready, recording, processing, setup-needed
        let meetings = [];
        let filteredMeetings = [];
        let selectedMeeting = null;
        let recordingProcess = null;
        let statusCheckInterval = null;
        let processingMeeting = null; // Track which meeting is currently being reprocessed
        let searchQuery = '';
        let recordingStartTime = null;
        let recordingTimer = null;
        let pausedElapsedTime = 0; // Track elapsed time when paused
        let processingMeetings = new Set();
        let meetingsLastLoaded = 0; // Cache timestamp
        
        // Announcement system variables
        let currentAnnouncement = null;
        let announcementCheckInterval = null;
        
        // Utility functions
        function log(message) {
            console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
        }
        
        function generateMeetingHash() {
            // Generate short hash for meeting names
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function setStatus(status, message) {
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = message;
            // Toggle waveform visibility for recording state
            const statusContainer = document.getElementById('status-container');
            if (status === 'recording') {
                statusContainer.classList.add('recording');
            } else {
                statusContainer.classList.remove('recording');
            }
            log(`Status: ${message}`);
        }
        
        function startRecordingTimer(resume = false) {
            // If resuming, adjust start time to account for already elapsed time
            if (resume && pausedElapsedTime > 0) {
                recordingStartTime = Date.now() - (pausedElapsedTime * 1000);
            } else {
                recordingStartTime = Date.now();
                pausedElapsedTime = 0;
            }
            recordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                setStatus('recording', `Recording... ${timeStr}`);
            }, 1000);
        }

        function pauseRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            // Save elapsed time before pausing
            if (recordingStartTime) {
                pausedElapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
            }
        }

        function stopRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            recordingStartTime = null;
            pausedElapsedTime = 0;
        }
        
        function setUIState(state) {
            uiState = state;
            log(`UI State: ${state}`);

            // Update UI elements based on state
            switch(state) {
                case 'ready':
                    startBtn.style.display = 'inline-flex';
                    stopBtn.style.display = 'none';
                    pauseBtn.style.display = 'none';
                    startBtn.disabled = false;
                    sessionNameInput.disabled = false;
                    stopRecordingTimer();
                    setStatus('ready', 'Ready');
                    break;

                case 'recording':
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-flex';
                    pauseBtn.style.display = 'inline-flex';
                    pauseBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="1.5" y="1" width="3" height="10" rx="1"/><rect x="7.5" y="1" width="3" height="10" rx="1"/></svg> Pause';
                    startBtn.disabled = true;
                    sessionNameInput.disabled = true;
                    stopBtn.disabled = false;
                    pauseBtn.disabled = false;
                    // Check if resuming from paused state (pausedElapsedTime > 0)
                    startRecordingTimer(pausedElapsedTime > 0);
                    break;

                case 'paused':
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-flex';
                    pauseBtn.style.display = 'inline-flex';
                    pauseBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><polygon points="2,1 11,6 2,11"/></svg> Resume';
                    startBtn.disabled = true;
                    sessionNameInput.disabled = true;
                    stopBtn.disabled = false;
                    pauseBtn.disabled = false;
                    pauseRecordingTimer();
                    // Show paused status with the frozen time
                    const minutes = Math.floor(pausedElapsedTime / 60);
                    const seconds = pausedElapsedTime % 60;
                    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    setStatus('recording', `Paused ${timeStr}`);
                    break;

                case 'processing':
                    startBtn.style.display = 'inline-flex';
                    stopBtn.style.display = 'none';
                    pauseBtn.style.display = 'none';
                    startBtn.disabled = true;
                    sessionNameInput.disabled = true;
                    stopRecordingTimer();
                    setStatus('processing', 'Processing...');
                    break;
            }
        }
        
        function startStatusMonitoring() {
            // Only check status when we think we're recording
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            
            statusCheckInterval = setInterval(async () => {
                if (uiState === 'recording') {
                    try {
                        // Check if microphone permission was revoked during recording
                        const micResult = await ipcRenderer.invoke('check-microphone-permission');
                        if (!micResult.success || micResult.status !== 'granted') {
                            log(' Microphone permission revoked during recording - stopping');
                            alert(' Microphone access was revoked! Recording stopped.\n\nPlease grant microphone permission to continue recording.');
                            setUIState('ready');
                            stopStatusMonitoring();
                            showSetupOverlay([]);
                            return;
                        }
                        
                        const result = await ipcRenderer.invoke('get-status');
                        if (result.success && !result.status.includes('RECORDING')) {
                            // Backend says not recording but UI thinks it is - sync up
                            log('Backend/UI state mismatch - syncing');
                            setUIState('ready');
                            stopStatusMonitoring();
                        }
                    } catch (error) {
                        log(`Status check failed: ${error.message}`);
                    }
                }
            }, 10000); // Check every 10 seconds only when recording
        }
        
        function stopStatusMonitoring() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }
        
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return 'Unknown date';
            }
        }
        
        function formatDuration(startTime, endTime) {
            if (!startTime || !endTime) return 'Unknown';
            try {
                const start = new Date(startTime);
                const end = new Date(endTime);
                const minutes = Math.round((end - start) / 60000);
                return `${minutes} min`;
            } catch {
                return 'Unknown';
            }
        }
        
        // Delete meeting function
        async function deleteMeeting(index, event) {
            event.stopPropagation(); // Prevent selecting the meeting
            
            const meeting = filteredMeetings[index];
            if (!meeting) return;
            
            const confirmed = confirm(`Delete meeting "${meeting.session_info?.name || 'Untitled Meeting'}"?\n\nThis will delete the transcript, summary, and all associated files.`);
            if (!confirmed) return;
            
            try {
                // Pass the entire meeting object to the backend
                const result = await ipcRenderer.invoke('delete-meeting', meeting);
                
                if (result.success) {
                    log(`Meeting deleted: ${result.message}`);
                    
                    // Remove meeting from local arrays
                    meetings = meetings.filter(m => m !== meeting);
                    filteredMeetings = filteredMeetings.filter(m => m !== meeting);
                    
                    // Re-render the meetings list
                    filterMeetings();
                    
                    // Clear selected meeting if it was deleted
                    if (selectedMeeting === meeting) {
                        selectedMeeting = null;
                        emptyState.style.display = 'flex';
                        meetingDetail.classList.remove('show');
                    }
                } else {
                    log(`Failed to delete meeting: ${result.error}`);
                    alert(`Failed to delete meeting: ${result.error}`);
                }
            } catch (error) {
                log(`Error deleting meeting: ${error.message}`);
                alert(`Error deleting meeting: ${error.message}`);
            }
        }
        
        // Filter meetings based on search query
        function filterMeetings() {
            if (!searchQuery.trim()) {
                filteredMeetings = [...meetings];
            } else {
                const query = searchQuery.toLowerCase();
                filteredMeetings = meetings.filter(meeting => {
                    const name = (meeting.session_info?.name || '').toLowerCase();
                    const summary = (meeting.summary || '').toLowerCase();
                    const keyPoints = (meeting.key_points || []).join(' ').toLowerCase();
                    const actionItems = (meeting.action_items || []).join(' ').toLowerCase();
                    
                    return name.includes(query) || 
                           summary.includes(query) || 
                           keyPoints.includes(query) || 
                           actionItems.includes(query);
                });
            }
            renderMeetingsList();
        }
        
        // Load meetings from backend with caching
        async function loadMeetings(forceRefresh = false) {
            const now = Date.now();
            
            // Use cache if data is less than 30 seconds old and not forced refresh
            if (!forceRefresh && meetings.length > 0 && (now - meetingsLastLoaded) < 30000) {
                log('Using cached meetings data');
                filterMeetings();
                return;
            }
            
            // Show loading state only if we don't have cached data
            if (meetings.length === 0) {
                meetingsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <p>Loading meetings...</p>
                    </div>
                `;
            }
            
            try {
                const result = await ipcRenderer.invoke('list-meetings');
                if (result.success) {
                    meetings = result.meetings || [];
                    meetingsLastLoaded = now;
                    filterMeetings(); // Apply current search filter
                    log(`Loaded ${meetings.length} meetings`);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                log(`Failed to load meetings: ${error.message}`);
                // Only show error if we don't have cached data
                if (meetings.length === 0) {
                    meetingsList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                            <div style="font-size: 24px; margin-bottom: 8px;"></div>
                            <p>Failed to load meetings</p>
                            <p style="font-size: 12px; margin-top: 4px;">Using cached data if available</p>
                        </div>
                    `;
                } else {
                    // We have cached data, just log the error
                    log('Using cached meetings data due to load failure');
                    filterMeetings();
                }
            }
        }
        
        // Render meetings list
        function renderMeetingsList() {
            if (filteredMeetings.length === 0 && searchQuery.trim()) {
                meetingsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <p>No meetings match "${searchQuery}"</p>
                        <p style="font-size: 12px; margin-top: 4px;">Try a different search term</p>
                    </div>
                `;
                return;
            }
            
            if (meetings.length === 0) {
                meetingsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <p>No meetings recorded yet</p>
                        <p style="font-size: 12px; margin-top: 4px;">Start recording to see your meetings here</p>
                    </div>
                `;
                return;
            }
            
            meetingsList.innerHTML = filteredMeetings.map((meeting, index) => {
                const isProcessing = processingMeetings.has(meeting.session_info?.name);
                const actionCount = (meeting.action_items || []).length;
                const participantCount = (meeting.participants || []).length;
                return `
                <div class="meeting-item ${isProcessing ? 'processing' : ''}" data-index="${index}">
                    ${isProcessing ? '<div class="processing-overlay"><div class="processing-indicator"><div class="processing-spinner"></div>Processing...</div></div>' : ''}
                    <button class="meeting-delete" onclick="deleteMeeting(${index}, event)" title="Delete meeting"></button>
                    <h3>${meeting.session_info?.name || 'Untitled Meeting'}</h3>
                    <div class="meeting-meta">
                        <span class="meeting-date">${formatDate(meeting.session_info?.processed_at)}</span>
                    </div>
                    <div class="meeting-preview">
                        ${(meeting.summary || 'No summary available').substring(0, 100)}...
                    </div>
                    <div class="meeting-badges">
                        ${actionCount > 0 ? `<span class="meeting-badge actions"> ${actionCount} action${actionCount > 1 ? 's' : ''}</span>` : ''}
                    </div>
                </div>
                `;
            }).join('');
            
            // Add click handlers
            document.querySelectorAll('.meeting-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectMeeting(index);
                });
            });
        }
        
        // Select and display meeting details
        function selectMeeting(index) {
            selectedMeeting = filteredMeetings[index];
            if (!selectedMeeting) return;
            
            // Update active state
            document.querySelectorAll('.meeting-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
            
            // Show meeting details
            emptyState.style.display = 'none';
            meetingDetail.classList.add('show');
            
            // Populate details
            detailTitle.textContent = selectedMeeting.session_info?.name || 'Untitled Meeting';
            detailDate.textContent = formatDate(selectedMeeting.session_info?.processed_at);
            const durationText = selectedMeeting.session_info?.duration_seconds ? 
                (() => {
                    const totalSecs = selectedMeeting.session_info.duration_seconds;
                    const hours = Math.floor(totalSecs / 3600);
                    const mins = Math.floor((totalSecs % 3600) / 60);
                    const secs = totalSecs % 60;
                    
                    if (hours > 0) return `Meeting Duration: ${hours}h ${mins}m`;
                    if (mins > 0) return `Meeting Duration: ${mins}m ${secs}s`;
                    return `Meeting Duration: ${secs}s`;
                })() :
                (selectedMeeting.session_info?.duration_minutes ?
                    `Meeting Duration: ${selectedMeeting.session_info.duration_minutes} minutes` : 'Processed');
            detailDuration.textContent = durationText;
            
            detailSummary.textContent = selectedMeeting.summary || 'No summary available';
            
            // Participants
            if (selectedMeeting.participants && selectedMeeting.participants.length > 0) {
                detailParticipants.textContent = selectedMeeting.participants.join(', ');
            } else {
                detailParticipants.innerHTML = '<span style="color: var(--text-muted);">No participants identified</span>';
            }

            // Key topics
            const detailDiscussionAreas = document.getElementById('detail-discussion-areas');
            const discussionAreasSection = document.getElementById('discussion-areas-section');
            detailDiscussionAreas.innerHTML = '';
            if (selectedMeeting.discussion_areas && selectedMeeting.discussion_areas.length > 0) {
                discussionAreasSection.style.display = 'block';
                selectedMeeting.discussion_areas.forEach(area => {
                    const areaDiv = document.createElement('div');
                    areaDiv.style.marginBottom = '15px';
                    areaDiv.style.padding = '12px';
                    areaDiv.style.background = 'var(--bg-elevated)';
                    areaDiv.style.borderRadius = '6px';
                    areaDiv.style.borderLeft = '3px solid var(--accent-primary)';

                    const title = document.createElement('h4');
                    title.textContent = area.title || 'Discussion Topic';
                    title.style.margin = '0 0 8px 0';
                    title.style.color = 'var(--accent-primary)';
                    title.style.fontSize = '14px';
                    title.style.fontWeight = '600';

                    const analysis = document.createElement('p');
                    analysis.textContent = area.analysis || '';
                    analysis.style.margin = '0';
                    analysis.style.color = 'var(--text-secondary)';
                    analysis.style.lineHeight = '1.5';

                    areaDiv.appendChild(title);
                    areaDiv.appendChild(analysis);
                    detailDiscussionAreas.appendChild(areaDiv);
                });
            } else {
                discussionAreasSection.style.display = 'none';
            }

            // Key points
            detailKeyPoints.innerHTML = '';
            if (selectedMeeting.key_points && selectedMeeting.key_points.length > 0) {
                selectedMeeting.key_points.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    detailKeyPoints.appendChild(li);
                });
            } else {
                detailKeyPoints.innerHTML = '<li style="color: var(--text-muted);">No key points identified</li>';
            }
            
            // Action items
            detailActionItems.innerHTML = '';
            if (selectedMeeting.action_items && selectedMeeting.action_items.length > 0) {
                selectedMeeting.action_items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    detailActionItems.appendChild(li);
                });
            } else {
                detailActionItems.innerHTML = '<li style="color: var(--text-muted);">No action items identified</li>';
            }
            
            // Transcript
            detailTranscript.textContent = selectedMeeting.transcript || 'No transcript available';
            
            // Set reprocess button state based on whether this meeting is currently processing
            const isCurrentlyProcessing = processingMeeting && processingMeeting.session_info?.summary_file === selectedMeeting.session_info?.summary_file;
            
            if (isCurrentlyProcessing) {
                // Restore processing state
                reprocessBtn.disabled = true;
                reprocessBtn.classList.add('processing');
                reprocessBtn.innerHTML = '<div class="reprocess-spinner"></div>Processing...';
            } else {
                // Normal state
                reprocessBtn.disabled = false;
                reprocessBtn.classList.remove('processing');
                reprocessBtn.innerHTML = 'Reprocess';
            }
            
            // TEMPORARY: Show reprocess button for all meetings (for testing)
            reprocessBtn.style.display = 'flex';
            
            /* ORIGINAL LOGIC (commented out for testing):
            // Show/hide reprocess button based on meeting quality
            const hasFailedSummary = (
                !selectedMeeting.summary || 
                selectedMeeting.summary.includes('No transcript was generated') ||
                selectedMeeting.summary.includes('detailed analysis failed') ||
                selectedMeeting.summary.includes('not fully supported') ||
                (selectedMeeting.overview && (
                    selectedMeeting.overview.includes('No transcript was generated') ||
                    selectedMeeting.overview.includes('detailed analysis failed') ||
                    selectedMeeting.overview.includes('not fully supported')
                ))
            );
            
            const hasNoParticipants = !selectedMeeting.participants || selectedMeeting.participants.length === 0;
            const hasNoKeyPoints = !selectedMeeting.key_points || selectedMeeting.key_points.length === 0;
            
            // Show reprocess button if meeting appears to have failed summarization
            if (hasFailedSummary || (hasNoParticipants && hasNoKeyPoints && selectedMeeting.transcript && selectedMeeting.transcript.length > 100)) {
                reprocessBtn.style.display = 'flex';
            } else {
                reprocessBtn.style.display = 'none';
            }
            */
        }
        
        
        // Manual start/stop recording functions
        startBtn.addEventListener('click', async () => {
            // Check microphone permission before allowing recording
            try {
                const micResult = await ipcRenderer.invoke('check-microphone-permission');
                if (!micResult.success || micResult.status !== 'granted') {
                    log(' Cannot start recording - microphone permission denied');
                    
                    // Show clear error message
                    const micStatus = micResult.status || 'unknown';
                    alert(` Recording blocked: Microphone permission is ${micStatus}.\n\nStenoAI requires microphone access to record meetings. Please grant permission and try again.`);
                    
                    // Force show setup wizard to fix the issue
                    showSetupOverlay([]);
                    return;
                }
            } catch (error) {
                log(` Failed to check microphone permission: ${error.message}`);
                alert(' Cannot verify microphone permission. Please ensure the app has proper access.');
                return;
            }
            
            // Generate session name if empty or use Meeting-HASH format
            let sessionName = sessionNameInput.value.trim();
            if (!sessionName || sessionName === 'Meeting') {
                sessionName = `Meeting-${generateMeetingHash()}`;
                sessionNameInput.value = sessionName;
            }
            
            log(` Starting recording: ${sessionName}`);
            setUIState('recording');
            
            try {
                const result = await ipcRenderer.invoke('start-recording-ui', sessionName);
                if (result.success) {
                    log(`Recording started: ${result.message}`);
                    startStatusMonitoring();
                } else {
                    log(`Failed to start: ${result.error}`);
                    setUIState('ready');
                }
            } catch (error) {
                log(` Start error: ${error.message}`);
                setUIState('ready');
            }
        });
        
        stopBtn.addEventListener('click', async () => {
            log(' Stopping recording...');
            setUIState('processing');
            stopStatusMonitoring();
            
            // Add current session to processing list immediately
            const currentSessionName = sessionNameInput.value.trim() || 'Meeting';
            processingMeetings.add(currentSessionName);
            
            // Add a temporary meeting entry to show processing
            const tempMeeting = {
                session_info: {
                    name: currentSessionName,
                    processed_at: new Date().toISOString(),
                    duration_seconds: null
                },
                summary: 'Pending...',
                key_points: [],
                action_items: [],
                transcript: ''
            };
            
            // Add to beginning of meetings array temporarily
            meetings.unshift(tempMeeting);
            filterMeetings(); // Update UI to show processing state
            
            try {
                const result = await ipcRenderer.invoke('stop-recording-ui');
                if (result.success) {
                    log(`Recording stopped: ${result.message}`);
                    log(' Processing audio - transcription and summarization running in background');
                    log(' Meeting list will refresh automatically when processing completes');
                    
                    // Return to ready state quickly so user can start another recording if needed
                    setTimeout(() => {
                        setUIState('ready');
                        sessionNameInput.value = '';
                    }, 5000); // 5 seconds
                    
                } else {
                    log(`Failed to stop: ${result.error}`);
                    setUIState('ready');
                    processingMeetings.delete(currentSessionName);
                    renderMeetingsList();
                }
            } catch (error) {
                log(` Stop error: ${error.message}`);
                setUIState('ready');
                processingMeetings.delete(currentSessionName);
                renderMeetingsList();
            }
        });

        pauseBtn.addEventListener('click', async () => {
            if (uiState === 'recording') {
                // Pause recording
                log(' Pausing recording...');
                try {
                    const result = await ipcRenderer.invoke('pause-recording-ui');
                    if (result.success) {
                        setUIState('paused');
                    } else {
                        log(`Failed to pause: ${result.error}`);
                    }
                } catch (error) {
                    log(` Pause error: ${error.message}`);
                }
            } else if (uiState === 'paused') {
                // Resume recording
                log(' Resuming recording...');
                try {
                    const result = await ipcRenderer.invoke('resume-recording-ui');
                    if (result.success) {
                        setUIState('recording');
                    } else {
                        log(`Failed to resume: ${result.error}`);
                    }
                } catch (error) {
                    log(` Resume error: ${error.message}`);
                }
            }
        });

        // Search functionality
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value;
            filterMeetings();
        });
        
        
        // File drop handling
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });
        
        document.addEventListener('dragleave', (e) => {
            if (!e.relatedTarget) {
                dropZone.classList.remove('active');
            }
        });
        
        document.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('audio/') || file.name.match(/\.(wav|mp3|m4a|aac)$/i)) {
                    log(`Processing dropped file: ${file.name}`);
                    setStatus('processing', 'Processing file...');
                    
                    try {
                        const sessionName = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
                        processingMeetings.add(sessionName);
                        renderMeetingsList(); // Update UI to show processing state
                        const result = await ipcRenderer.invoke('process-recording', file.path, sessionName);
                        
                        if (result.success) {
                            log('File processed successfully');
                            setStatus('ready', 'Complete');
                            processingMeetings.delete(sessionName);
                            
                            // Force refresh meetings list after processing
                            setTimeout(() => {
                                loadMeetings(true);
                            }, 1000);
                        } else {
                            log(`Processing failed: ${result.error}`);
                            setStatus('ready', 'Processing failed');
                            processingMeetings.delete(sessionName);
                            renderMeetingsList();
                        }
                    } catch (error) {
                        log(`Processing error: ${error.message}`);
                        setStatus('ready', 'Error');
                        processingMeetings.delete(sessionName);
                        renderMeetingsList();
                    }
                } else {
                    log('Invalid file type. Please drop an audio file.');
                }
            }
        });
        
        // Check initial recording status once
        async function checkInitialStatus() {
            try {
                const result = await ipcRenderer.invoke('get-status');
                if (result.success && result.status.includes('RECORDING')) {
                    log('Found active recording session - syncing UI state');
                    setUIState('recording');
                    startStatusMonitoring();
                } else {
                    setUIState('ready');
                }
            } catch (error) {
                log(`Failed to check initial status: ${error.message}`);
                setUIState('ready');
            }
        }

        // Auto-clear state on startup
        async function initializeApp() {
            // Clear debug logs for fresh start
            clearDebugLog();
            
            log('Initializing Steno Recorder...');
            
            // Request notification permission early (non-blocking)
            if (Notification.permission === 'default') {
                Notification.requestPermission().catch(() => {}); // Don't wait for this
            }
            
            // Parallel startup: Load meetings first (user sees content immediately),
            // then clear state and check status in background
            const startTime = Date.now();
            
            try {
                // Start loading meetings immediately (most important for user experience)
                const meetingsPromise = loadMeetings();
                
                // Do maintenance tasks in parallel
                const maintenancePromise = Promise.all([
                    ipcRenderer.invoke('clear-state').catch(err =>
                        log(`State clear failed: ${err.message}`)
                    ),
                    checkInitialStatus().catch(err =>
                        log(`Status check failed: ${err.message}`)
                    ),
                    loadNotificationSettings().catch(err =>
                        log(`Notification settings load failed: ${err.message}`)
                    ),
                    loadTelemetrySettings().catch(err =>
                        log(`Telemetry settings load failed: ${err.message}`)
                    )
                ]);
                
                // Wait for meetings to load (priority), maintenance can finish in background
                await meetingsPromise;
                log(`Meetings loaded (${Date.now() - startTime}ms)`);
                
                // Wait for maintenance to complete
                await maintenancePromise;
                
            } catch (error) {
                log(`Initialization error: ${error.message}`);
                // Continue anyway - app should still be usable
            }
            
            log(`Steno Recorder ready (${Date.now() - startTime}ms total)`);
        }

        // Startup setup flow
        let setupInProgress = false;
        
        setupAutoStart.addEventListener('click', async () => {
            if (setupInProgress) return;
            await runSetupProcess();
        });
        
        setupContinue.addEventListener('click', () => {
            setupOverlay.style.display = 'none';
            // Refresh meetings after setup completion to ensure fresh data
            loadMeetings(true);
        });
        
        // Settings button click handler
        settingsBtn.addEventListener('click', () => {
            toggleSettings();
        });
        
        // Reprocess button click handler
        reprocessBtn.addEventListener('click', async () => {
            if (!selectedMeeting) return;
            
            const summaryFile = selectedMeeting.session_info?.summary_file;
            if (!summaryFile) {
                log(' No summary file found for reprocessing');
                return;
            }
            
            // Track which meeting is being processed
            processingMeeting = selectedMeeting;
            
            // Show processing state
            reprocessBtn.disabled = true;
            reprocessBtn.classList.add('processing');
            reprocessBtn.innerHTML = '<div class="reprocess-spinner"></div>Processing...';
            
            const meetingBeingProcessed = selectedMeeting; // Capture the meeting being processed
            log(` Reprocessing meeting: ${meetingBeingProcessed.session_info?.name}`);
            
            try {
                // Call main process to reprocess the meeting
                const result = await ipcRenderer.invoke('reprocess-meeting', summaryFile);
                
                if (result.success) {
                    log(' Meeting reprocessed successfully');
                    
                    // Send notification for reprocessing completion
                    showDesktopNotification('StenoAI - Reprocessing Complete', {
                        body: `"${meetingBeingProcessed.session_info?.name || 'Meeting'}" has been reanalyzed`,
                        requireInteraction: false
                    });
                    
                    // Reload meetings to show updated data
                    await loadMeetings(true);
                    // Re-select the current meeting to show updated content
                    const updatedMeetingIndex = filteredMeetings.findIndex(m => 
                        m.session_info?.summary_file === summaryFile
                    );
                    if (updatedMeetingIndex !== -1) {
                        selectMeeting(updatedMeetingIndex);
                    }
                } else {
                    log(` Reprocessing failed: ${result.error}`);
                }
            } catch (error) {
                log(` Reprocessing error: ${error.message}`);
            } finally {
                // Clear processing tracker
                processingMeeting = null;
                
                // Reset button state only if we're still viewing the same meeting
                if (selectedMeeting && selectedMeeting.session_info?.summary_file === summaryFile) {
                    reprocessBtn.disabled = false;
                    reprocessBtn.classList.remove('processing');
                    reprocessBtn.innerHTML = 'Reprocess';
                }
            }
        });

        // AI Query functionality
        function showAiQueryPopup() {
            if (!selectedMeeting) {
                log('No meeting selected for AI query');
                return;
            }
            aiQueryPopup.classList.add('show');
            aiQueryInput.value = '';
            aiQueryResponse.classList.remove('show');
            aiQueryResponseContent.textContent = '';
            aiQueryResponseContent.classList.remove('loading', 'error');
            setTimeout(() => aiQueryInput.focus(), 100);
        }

        function hideAiQueryPopup() {
            aiQueryPopup.classList.remove('show');
            aiQueryInput.value = '';
            aiQueryResponse.classList.remove('show');
        }

        function formatAiResponse(text) {
            // Escape HTML
            const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Bold **text**
            let html = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Bullet points: lines starting with * or -
            html = html.replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>');
            // Wrap consecutive <li> in <ul>
            html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            // Line breaks for remaining newlines
            html = html.replace(/\n/g, '<br>');
            // Clean up <br> inside/around <ul>
            html = html.replace(/<br><ul>/g, '<ul>');
            html = html.replace(/<\/ul><br>/g, '</ul>');
            html = html.replace(/<ul><br>/g, '<ul>');
            return html;
        }

        async function submitAiQuery() {
            const question = aiQueryInput.value.trim();
            if (!question) return;
            if (!selectedMeeting) {
                log('No meeting selected for AI query');
                return;
            }

            const summaryFile = selectedMeeting.session_info?.summary_file;
            if (!summaryFile) {
                log('No summary file found for AI query');
                return;
            }

            // Show loading state
            aiQuerySubmit.disabled = true;
            aiQueryResponse.classList.add('show');
            aiQueryResponseContent.classList.add('loading');
            aiQueryResponseContent.classList.remove('error');
            aiQueryResponseContent.innerHTML = '<div class="ai-query-spinner"></div>Thinking...';

            log(`Asking AI: ${question.substring(0, 50)}...`);

            try {
                const result = await ipcRenderer.invoke('query-transcript', summaryFile, question);

                if (result.success) {
                    aiQueryResponseContent.classList.remove('loading');
                    aiQueryResponseContent.innerHTML = formatAiResponse(result.answer);
                    log('AI response received');
                } else {
                    aiQueryResponseContent.classList.remove('loading');
                    aiQueryResponseContent.classList.add('error');
                    aiQueryResponseContent.textContent = result.error || 'Failed to get response from AI';
                    log(`AI query failed: ${result.error}`);
                }
            } catch (error) {
                aiQueryResponseContent.classList.remove('loading');
                aiQueryResponseContent.classList.add('error');
                aiQueryResponseContent.textContent = 'Failed to query AI: ' + error.message;
                log(`AI query error: ${error.message}`);
            } finally {
                aiQuerySubmit.disabled = false;
            }
        }

        // Ask AI button click handler
        askAiBtn.addEventListener('click', showAiQueryPopup);

        // AI Query close button
        aiQueryClose.addEventListener('click', hideAiQueryPopup);

        // AI Query submit button
        aiQuerySubmit.addEventListener('click', submitAiQuery);

        // AI Query input - submit on Enter
        aiQueryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitAiQuery();
            }
            if (e.key === 'Escape') {
                hideAiQueryPopup();
            }
        });

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd+K or Ctrl+K to open AI query
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                if (aiQueryPopup.classList.contains('show')) {
                    hideAiQueryPopup();
                } else if (selectedMeeting) {
                    showAiQueryPopup();
                }
            }
            // Cmd+, or Ctrl+, to toggle settings
            if ((e.metaKey || e.ctrlKey) && e.key === ',') {
                e.preventDefault();
                toggleSettings();
            }
            // Escape to close panels
            if (e.key === 'Escape') {
                if (aiQueryPopup.classList.contains('show')) {
                    hideAiQueryPopup();
                } else if (settingsVisible) {
                    toggleSettings();
                }
            }
        });

        // Close AI query popup when clicking outside
        aiQueryPopup.addEventListener('click', (e) => {
            if (e.target === aiQueryPopup) {
                hideAiQueryPopup();
            }
        });

        // Copy transcript to clipboard
        copyTranscriptBtn.addEventListener('click', async () => {
            try {
                const transcriptText = detailTranscript.textContent || '';
                if (!transcriptText || transcriptText === 'No transcript available') {
                    log(' No transcript available to copy');
                    return;
                }
                
                await navigator.clipboard.writeText(transcriptText);
                
                // Visual feedback
                copyTranscriptBtn.classList.add('copied');
                copyTranscriptBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                `;
                
                // Reset after 2 seconds
                setTimeout(() => {
                    copyTranscriptBtn.classList.remove('copied');
                    copyTranscriptBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    `;
                }, 2000);
                
                log(' Transcript copied to clipboard');
            } catch (error) {
                log(` Failed to copy transcript: ${error.message}`);
            }
        });

        // Copy all meeting notes to clipboard
        copyNotesBtn.addEventListener('click', async () => {
            try {
                if (!selectedMeeting) {
                    log(' No meeting selected to copy');
                    return;
                }

                // Format meeting notes as text
                const meetingName = selectedMeeting.session_info?.name || 'Untitled Meeting';
                const date = formatDate(selectedMeeting.session_info?.processed_at);
                const duration = selectedMeeting.session_info?.duration_seconds ?
                    `${Math.floor(selectedMeeting.session_info.duration_seconds / 60)}m ${selectedMeeting.session_info.duration_seconds % 60}s` :
                    'Unknown';

                let notesText = `${meetingName}\n`;
                notesText += `Date: ${date}\n`;
                notesText += `Duration: ${duration}\n`;
                notesText += `\n`;

                // Summary
                if (selectedMeeting.summary) {
                    notesText += `SUMMARY\n`;
                    notesText += `${selectedMeeting.summary}\n\n`;
                }

                // Participants
                if (selectedMeeting.participants && selectedMeeting.participants.length > 0) {
                    notesText += `PARTICIPANTS\n`;
                    selectedMeeting.participants.forEach(participant => {
                        notesText += `- ${participant}\n`;
                    });
                    notesText += `\n`;
                }

                // Key Topics (Discussion Areas)
                if (selectedMeeting.discussion_areas && selectedMeeting.discussion_areas.length > 0) {
                    notesText += `KEY TOPICS\n`;
                    selectedMeeting.discussion_areas.forEach(area => {
                        notesText += `\n${area.title}\n`;
                        notesText += `${area.analysis}\n`;
                    });
                    notesText += `\n`;
                }

                // Key Points
                if (selectedMeeting.key_points && selectedMeeting.key_points.length > 0) {
                    notesText += `KEY POINTS\n`;
                    selectedMeeting.key_points.forEach(point => {
                        notesText += `- ${point}\n`;
                    });
                    notesText += `\n`;
                }

                // Action Items
                if (selectedMeeting.action_items && selectedMeeting.action_items.length > 0) {
                    notesText += `ACTION ITEMS\n`;
                    selectedMeeting.action_items.forEach(item => {
                        notesText += `- ${item}\n`;
                    });
                }

                await navigator.clipboard.writeText(notesText);

                // Visual feedback
                copyNotesBtn.classList.add('copied');
                const originalHTML = copyNotesBtn.innerHTML;
                copyNotesBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                    Copied!
                `;

                // Reset after 2 seconds
                setTimeout(() => {
                    copyNotesBtn.classList.remove('copied');
                    copyNotesBtn.innerHTML = originalHTML;
                }, 2000);

                log(' Meeting notes copied to clipboard');
            } catch (error) {
                log(` Failed to copy notes: ${error.message}`);
            }
        });

        // Edit meeting title - define as a reusable function
        function startEditingTitle() {
            if (!selectedMeeting) return;

            const titleElement = document.getElementById('detail-title');
            const editBtn = document.getElementById('edit-title-btn');
            const currentTitle = titleElement.textContent;

            // Hide title and edit button
            titleElement.style.display = 'none';
            editBtn.style.display = 'none';

            // Create input and buttons
            const titleContainer = document.querySelector('.meeting-title-container');
            const inputHTML = `
                <input type="text" class="meeting-title-input" id="title-input" value="${currentTitle}">
                <div class="title-edit-actions">
                    <button class="save-title-btn" id="save-title-btn">Save</button>
                    <button class="cancel-title-btn" id="cancel-title-btn">Cancel</button>
                </div>
            `;
            titleContainer.insertAdjacentHTML('beforeend', inputHTML);

            const titleInput = document.getElementById('title-input');
            const saveTitleBtn = document.getElementById('save-title-btn');
            const cancelTitleBtn = document.getElementById('cancel-title-btn');

            // Focus and select the input
            titleInput.focus();
            titleInput.select();

            // Save on Enter key
            titleInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveTitleBtn.click();
                } else if (e.key === 'Escape') {
                    cancelTitleBtn.click();
                }
            });

            // Cancel function
            const cancelEdit = () => {
                titleInput.remove();
                document.querySelector('.title-edit-actions').remove();
                titleElement.style.display = '';
                editBtn.style.display = '';
            };

            // Save function
            const saveTitle = async () => {
                const newTitle = titleInput.value.trim();
                if (!newTitle || newTitle === currentTitle) {
                    cancelEdit();
                    return;
                }

                try {
                    const result = await ipcRenderer.invoke('update-meeting',
                        selectedMeeting.session_info.summary_file,
                        { name: newTitle }
                    );

                    if (result.success) {
                        // Update local data
                        selectedMeeting.session_info.name = newTitle;

                        // Update the SAME title element (keeps detailTitle reference valid)
                        titleElement.textContent = newTitle;

                        // Remove input and show title again
                        titleInput.remove();
                        document.querySelector('.title-edit-actions').remove();
                        titleElement.style.display = '';
                        editBtn.style.display = '';

                        // Reload meetings list to show updated name
                        await loadMeetings(true);

                        log(` Meeting name updated to: ${newTitle}`);
                    } else {
                        log(` Failed to update meeting name: ${result.error}`);
                        cancelEdit();
                    }
                } catch (error) {
                    log(` Error updating meeting name: ${error.message}`);
                    cancelEdit();
                }
            };

            cancelTitleBtn.addEventListener('click', cancelEdit);
            saveTitleBtn.addEventListener('click', saveTitle);
        }

        // Attach the initial event listener
        editTitleBtn.addEventListener('click', startEditingTitle);

        // Listen for debug messages from backend
        ipcRenderer.on('debug-log', (event, message) => {
            debugLog(message);
        });

        // Listen for global hotkey toggle recording
        ipcRenderer.on('toggle-recording-hotkey', () => {
            log('Global hotkey received: toggle recording');
            if (uiState === 'recording') {
                // Stop recording
                stopBtn.click();
            } else if (uiState === 'ready') {
                // Start recording
                startBtn.click();
            }
            // Ignore if in 'processing' state
        });
        
        async function runSetupProcess() {
            setupInProgress = true;
            setupAutoStart.style.display = 'none';
            
            // Clear and initialize debug console
            const debugConsole = document.getElementById('debug-console');
            debugConsole.textContent = 'StenoAI Setup Debug Console - Setup Started\n';
            debugLog('='.repeat(50));
            debugLog('Starting First-Time Setup Process');
            debugLog('='.repeat(50));
            
            const steps = [
                { id: 'step-microphone', handler: 'request-microphone-permission', name: 'Microphone Access' },
                { id: 'step-system', handler: 'setup-system-check', name: 'System Check' },
                { id: 'step-python', handler: 'setup-python', name: 'Python Dependencies' },
                { id: 'step-whisper', handler: 'setup-whisper', name: 'Whisper Installation' },
                { id: 'step-ollama', handler: 'setup-ollama-and-model', name: 'Ollama + AI Model' },
                { id: 'step-ffmpeg', handler: 'setup-ffmpeg', name: 'ffmpeg Installation' },
                { id: 'step-test', handler: 'setup-test', name: 'System Test' }
            ];
            
            for (const step of steps) {
                const element = document.getElementById(step.id);
                const statusElement = document.getElementById(step.id.replace('step-', '') + '-status');
                
                // Mark as active
                element.classList.remove('completed', 'failed');
                element.classList.add('active');
                statusElement.textContent = 'Running...';
                
                // Log to debug console
                debugLog(`\n>>> Starting: ${step.name}`);
                debugLog(`Command: ${step.handler}`);

                try {
                    const result = await ipcRenderer.invoke(step.handler);

                    if (result.success) {
                        element.classList.remove('active');
                        element.classList.add('completed');
                        statusElement.textContent = result.message || 'Completed';
                        debugLog(` SUCCESS: ${result.message || 'Completed'}`);

                        // Special handling for microphone permission completion
                        if (step.id === 'step-microphone') {
                            statusElement.textContent = 'Permission granted!';
                            debugLog('Microphone permission granted - can proceed with other setup steps');
                        }
                        
                    } else {
                        element.classList.remove('active');
                        element.classList.add('failed');
                        statusElement.textContent = result.error || 'Failed';
                        
                        debugLog(` FAILED: ${result.error || 'Failed'}`);
                        
                        // Show detailed error in debug console if available
                        if (result.details) {
                            debugLog('--- Error Details ---');
                            debugLog(result.details);
                            debugLog('--- End Error Details ---');
                        }
                        
                        // Show retry button on failure
                        setupAutoStart.textContent = 'Retry Setup';
                        setupAutoStart.style.display = 'block';
                        setupInProgress = false;
                        return;
                    }
                } catch (error) {
                    element.classList.remove('active');
                    element.classList.add('failed');
                    statusElement.textContent = 'Failed';
                    
                    debugLog(` EXCEPTION: ${error.message}`);
                    debugLog(`Stack trace: ${error.stack}`);
                    
                    // Show retry button on failure
                    setupAutoStart.textContent = 'Retry Setup';
                    setupAutoStart.style.display = 'block';
                    setupInProgress = false;
                    return;
                }
                
                // Small delay between steps
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log(' Setup completed successfully!');
            debugLog('\n' + '='.repeat(50));
            debugLog(' Setup completed successfully!');
            debugLog('All components installed and tested.');
            debugLog('='.repeat(50));
            
            setupContinue.style.display = 'block';
            setupInProgress = false;
        }
        
        // Smooth startup with automatic setup detection
        async function runStartupCheck() {
            log(' Checking system setup...');
            
            try {
                // Check microphone permission and system setup together
                const micResult = await ipcRenderer.invoke('check-microphone-permission');
                const micGranted = micResult.success && micResult.status === 'granted';
                
                const result = await ipcRenderer.invoke('startup-setup-check');
                const systemReady = result.success && result.allGood;
                
                if (micGranted && systemReady) {
                    // Everything is ready - continue to main app
                    log('System ready!');
                    return;
                } else {
                    // Show unified setup wizard (includes microphone + system setup)
                    log(' Setup needed - showing unified setup wizard');
                    showSetupOverlay(result.checks || []);
                }
            } catch (error) {
                log(`Setup check failed: ${error.message}`);
                // Show setup overlay as fallback
                log(' First time setup detected');
                showSetupOverlay([]);
            }
        }
        
        async function showSetupOverlay(checks) {
            setupOverlay.style.display = 'flex';
            
            // Show ALL steps and reset their state
            document.querySelectorAll('.setup-step').forEach(step => {
                step.style.display = 'flex'; // Make sure all steps are visible
                step.classList.remove('active', 'completed', 'failed');
            });
            
            // Check and update microphone permission status
            try {
                const micResult = await ipcRenderer.invoke('check-microphone-permission');
                const micStep = document.getElementById('step-microphone');
                const micStatus = document.getElementById('microphone-status');
                
                if (micResult.success && micResult.status === 'granted') {
                    micStep.classList.add('completed');
                    micStatus.textContent = 'Permission granted';
                } else {
                    micStep.classList.add('failed');
                    micStatus.textContent = 'Requesting microphone permission...';
                    
                    // Automatically request microphone permission if missing
                    log(' Microphone permission missing - automatically requesting...');
                    setTimeout(async () => {
                        try {
                            const requestResult = await ipcRenderer.invoke('request-microphone-permission');
                            if (requestResult.success && requestResult.granted) {
                                micStep.classList.remove('failed');
                                micStep.classList.add('completed');
                                micStatus.textContent = 'Permission granted!';
                                log(' Microphone permission granted automatically');
                            } else {
                                micStatus.textContent = 'Permission denied - please grant in System Preferences';
                                log(' Microphone permission denied by user');
                            }
                        } catch (error) {
                            micStatus.textContent = 'Failed to request permission';
                            log(` Error requesting microphone permission: ${error.message}`);
                        }
                    }, 1000); // Small delay to show the status message
                }
            } catch (error) {
                console.error('Failed to check microphone permission:', error);
            }
            
            // Update other step statuses based on backend check
            checks.forEach(check => {
                const [status, detail] = check;
                updateStepStatus(status, detail);
            });
            
            // Show appropriate button
            const hasFailures = checks.length === 0 || checks.some(([status]) => status.startsWith(''));
            if (hasFailures || checks.length === 0) {
                setupAutoStart.style.display = 'block';
                setupAutoStart.textContent = checks.length === 0 ? 'Begin First-Time Setup' : 'Install Missing Dependencies';
                setupContinue.style.display = 'none';
            } else {
                setupContinue.style.display = 'block';
                setupAutoStart.style.display = 'none';
            }
        }
        
        function updateStepStatus(status, detail) {
            // Map backend check results to UI steps - only show setup for missing installations
            if (status.includes('Python')) {
                updateStep('step-system', status.startsWith('') ? 'completed' : 'failed', detail);
            } else if (status.includes('sounddevice')) {
                updateStep('step-python', status.startsWith('') ? 'completed' : 'failed', detail);
            } else if (status.includes('whisper')) {
                updateStep('step-whisper', status.startsWith('') ? 'completed' : 'failed', detail);
            } else if (status.includes('Ollama') || status.includes('Llama')) {
                // Only show as failed if actually missing, not just service down
                if (detail.includes('not installed') || detail.includes('missing')) {
                    updateStep('step-ollama', status.startsWith('') ? 'completed' : 'failed', detail);
                } else if (status.startsWith('')) {
                    updateStep('step-ollama', 'completed', detail);
                }
            }
        }
        
        function updateStep(stepId, state, message) {
            const element = document.getElementById(stepId);
            const statusElement = document.getElementById(stepId.replace('step-', '') + '-status');
            
            element.classList.remove('active', 'completed', 'failed');
            element.classList.add(state);
            statusElement.textContent = message;
        }

        // Listen for automatic meetings refresh from backend (legacy - kept for compatibility)
        ipcRenderer.on('meetings-refreshed', (event, meetingsData) => {
            log('Processing complete! Meeting list automatically refreshed');
            meetings = meetingsData || [];
            filterMeetings(); // Apply current search filter and render
        });
        
        // Listen for model pull progress
        ipcRenderer.on('model-pull-progress', (event, data) => {
            updateModelProgress(data.model, data.progress);
        });

        // Listen for model pull completion
        ipcRenderer.on('model-pull-complete', (event, data) => {
            hideModelDownloading(data.model);

            if (data.success) {
                showModelNotification(`Successfully downloaded ${data.model}!`, 'success');
                loadModels(); // Reload to show as installed
            } else {
                showModelNotification(`Failed to download ${data.model}: ${data.error}`, 'error');
            }
        });

        // Listen for processing completion events
        ipcRenderer.on('processing-complete', (event, data) => {
            log(`Processing complete for: ${data.sessionName}`);
            processingMeetings.delete(data.sessionName);
            
            if (data.success) {
                if (data.meetingData) {
                    // Update the specific meeting with processed data
                    const tempMeetingIndex = meetings.findIndex(meeting => 
                        meeting.session_info?.name === data.sessionName && meeting.summary === 'Pending...'
                    );
                    
                    if (tempMeetingIndex !== -1) {
                        // Replace temporary meeting with processed data
                        meetings[tempMeetingIndex] = data.meetingData;
                        meetingsLastLoaded = Date.now(); // Update cache timestamp
                    } else {
                        // Add new meeting if temp entry not found
                        meetings.unshift(data.meetingData);
                        meetingsLastLoaded = Date.now(); // Update cache timestamp
                    }
                    
                    // Re-render the meetings list with updated data
                    filterMeetings();
                } else {
                    // No meetingData provided - force refresh from backend
                    log('No meeting data in completion event - forcing refresh');
                    loadMeetings(true);
                }
                
                // Show native notification
                showDesktopNotification('StenoAI - Meeting Notes Ready', {
                    body: `"${data.sessionName}" has been transcribed and summarized`,
                    requireInteraction: false
                });
                
                setStatus('ready', 'Processing complete');
                setTimeout(() => setStatus('ready', 'Ready'), 3000);
            } else {
                // Remove temporary meeting entry on failure
                meetings = meetings.filter(meeting =>
                    !(meeting.session_info?.name === data.sessionName && meeting.summary === 'Pending...')
                );

                setStatus('ready', 'Processing failed');
                setTimeout(() => setStatus('ready', 'Ready'), 5000);
                log(`Processing failed: ${data.error}`);
                filterMeetings();
            }
        });
        
        // Unified settings panel functionality
        let settingsVisible = false;

        function toggleSettings() {
            const settingsPanel = document.getElementById('settings-panel');
            settingsVisible = !settingsVisible;

            if (settingsVisible) {
                // Prepare content before slide-in to avoid stagger
                switchSettingsTab('general');
                restoreDeveloperMode();
                // Force layout calc so tab state is committed before transition
                settingsPanel.offsetHeight;
                settingsPanel.classList.add('open');
                loadSettingsVersionInfo();
            } else {
                settingsPanel.classList.remove('open');
            }
        }

        // Tab switching logic
        function switchSettingsTab(tabName) {
            // Update nav active state
            document.querySelectorAll('.settings-nav-item').forEach(n => n.classList.remove('active'));
            const navItem = document.querySelector(`.settings-nav-item[data-tab="${tabName}"]`);
            if (navItem) navItem.classList.add('active');
            // Update tab visibility
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            // Full-width mode for developer tab
            const settingsBody = document.querySelector('.settings-body');
            if (tabName === 'developer') {
                settingsBody.classList.add('developer-active');
            } else {
                settingsBody.classList.remove('developer-active');
            }
            // Load tab-specific data
            if (tabName === 'ai') {
                loadModels();
            }
        }

        document.querySelectorAll('.settings-nav-item').forEach(navItem => {
            navItem.addEventListener('click', () => switchSettingsTab(navItem.dataset.tab));
        });

        // Developer tab back button
        document.getElementById('dev-back-btn').addEventListener('click', () => {
            switchSettingsTab('general');
        });

        // Developer mode toggle
        function restoreDeveloperMode() {
            const devToggle = document.getElementById('developer-mode-toggle');
            const devNavItem = document.getElementById('developer-nav-item');
            const enabled = localStorage.getItem('developerMode') === 'true';
            devToggle.checked = enabled;
            devNavItem.style.display = enabled ? '' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const devToggle = document.getElementById('developer-mode-toggle');
            if (devToggle) {
                devToggle.addEventListener('change', (e) => {
                    const enabled = e.target.checked;
                    localStorage.setItem('developerMode', enabled);
                    const devNavItem = document.getElementById('developer-nav-item');
                    devNavItem.style.display = enabled ? '' : 'none';
                    // If disabling and currently on developer tab, switch to general
                    if (!enabled) {
                        const activeTab = document.querySelector('.settings-nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'developer') {
                            switchSettingsTab('general');
                        }
                    }
                });
            }
        });

        async function loadSettingsVersionInfo() {
            try {
                const versionInfo = await ipcRenderer.invoke('get-app-version');
                const versionElement = document.getElementById('app-version');
                if (versionInfo.success) {
                    versionElement.textContent = `v${versionInfo.version}`;
                } else {
                    versionElement.textContent = 'Unknown';
                }
            } catch (error) {
                document.getElementById('app-version').textContent = 'Unknown';
            }
        }
        

        // Model management functions
        async function loadModels() {
            try {
                const result = await ipcRenderer.invoke('list-models');

                if (result.success) {
                    displayModelList(result.supported_models, result.current_model);
                } else {
                    document.getElementById('model-list').innerHTML = '<div class="model-list-loading" style="color: var(--recording-red);">Failed to load models</div>';
                }
            } catch (error) {
                console.error('Error loading models:', error);
                document.getElementById('model-list').innerHTML = '<div class="model-list-loading" style="color: var(--recording-red);">Error loading models</div>';
            }
        }

        function displayCurrentModel(modelName) {
            // No longer a separate display - handled inline in model list
        }

        function displayModelList(models, currentModel) {
            const modelListDiv = document.getElementById('model-list');
            modelListDiv.innerHTML = '';

            for (const [modelName, modelInfo] of Object.entries(models)) {
                const isCurrentModel = modelName === currentModel;

                const modelItem = document.createElement('div');
                modelItem.className = 'model-item' + (isCurrentModel ? ' active' : '');
                modelItem.setAttribute('data-model-name', modelName);
                modelItem.setAttribute('data-model-size', modelInfo.size);

                const tagMatch = modelInfo.description.match(/\((default|recommended)\)/i);
                const tagHtml = tagMatch ? `<span class="model-tag">${tagMatch[1]}</span>` : '';
                const activeHtml = isCurrentModel ? '<span class="model-active-badge">Active</span>' : '';

                modelItem.innerHTML = `
                    <div class="model-item-info">
                        <div class="model-item-name">
                            ${modelName}${tagHtml}${activeHtml}
                        </div>
                        <div class="model-item-meta">${modelInfo.size} &middot; ${modelInfo.speed} speed &middot; ${modelInfo.quality} quality</div>
                        <div class="model-progress">
                            <div class="progress-text">Downloading...</div>
                        </div>
                    </div>
                    <div class="model-item-action">
                        ${isCurrentModel
                            ? ''
                            : '<button class="settings-action-btn" onclick="event.stopPropagation(); selectModel(\'' + modelName + '\')">Select</button>'
                        }
                    </div>
                `;

                if (!isCurrentModel) {
                    modelItem.addEventListener('click', () => selectModel(modelName));
                }

                modelListDiv.appendChild(modelItem);
            }
        }

        async function selectModel(modelName) {
            try {
                // Check if model is already installed
                const checkResult = await ipcRenderer.invoke('check-model-installed', modelName);

                if (!checkResult.success) {
                    alert(`Error checking model status: ${checkResult.error}`);
                    return;
                }

                const isInstalled = checkResult.installed;
                let confirmMsg;

                if (isInstalled) {
                    confirmMsg = `Switch to model: ${modelName}?\n\nThis model is already installed and ready to use.`;
                } else {
                    confirmMsg = `Switch to model: ${modelName}?\n\nThis model will be downloaded (${getModelSize(modelName)}).\n\n WARNING: Model downloads will pause any active summarization.\nWait for current processing to finish before downloading.`;
                }

                if (!confirm(confirmMsg)) {
                    return;
                }

                // Set the model preference
                const result = await ipcRenderer.invoke('set-model', modelName);

                if (!result.success) {
                    alert(`Failed to set model: ${result.error}`);
                    return;
                }

                // If already installed, just reload and show success
                if (isInstalled) {
                    showModelNotification(`Switched to ${modelName}!`, 'success');
                    loadModels();
                    return;
                }

                // Model needs to be downloaded - start non-blocking pull
                showModelDownloading(modelName);

                // Start download (non-blocking - returns immediately)
                ipcRenderer.invoke('pull-model', modelName).catch(error => {
                    console.error('Error starting model pull:', error);
                    hideModelDownloading(modelName);
                    showModelNotification(`Failed to start download: ${error.message}`, 'error');
                });

            } catch (error) {
                console.error('Error selecting model:', error);
                alert(`Error selecting model: ${error.message}`);
            }
        }

        function getModelSize(modelName) {
            const modelList = document.getElementById('model-list');
            const modelCards = modelList.querySelectorAll('[data-model-name]');
            for (const card of modelCards) {
                if (card.dataset.modelName === modelName) {
                    const sizeText = card.dataset.modelSize;
                    return sizeText || 'unknown size';
                }
            }
            return 'unknown size';
        }

        function showModelDownloading(modelName) {
            const modelCard = document.querySelector(`[data-model-name="${modelName}"]`);
            if (!modelCard) return;

            const progressDiv = modelCard.querySelector('.model-progress');
            if (progressDiv) {
                progressDiv.style.display = 'block';
                progressDiv.querySelector('.progress-text').textContent = 'Starting download...';
            }
        }

        function hideModelDownloading(modelName) {
            const modelCard = document.querySelector(`[data-model-name="${modelName}"]`);
            if (!modelCard) return;

            const progressDiv = modelCard.querySelector('.model-progress');
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
        }

        function updateModelProgress(modelName, progressText) {
            const modelCard = document.querySelector(`[data-model-name="${modelName}"]`);
            if (!modelCard) return;

            const progressDiv = modelCard.querySelector('.model-progress');
            if (progressDiv) {
                progressDiv.querySelector('.progress-text').textContent = progressText;
            }
        }

        function showModelNotification(message, type = 'info') {
            // In-app notification toast (bottom-right, matches app theme)
            const cs = getComputedStyle(document.documentElement);
            const bgColor = type === 'success'
                ? cs.getPropertyValue('--success-green').trim()
                : type === 'error'
                    ? cs.getPropertyValue('--recording-red').trim()
                    : cs.getPropertyValue('--accent-primary').trim();
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${bgColor};
                color: white;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                max-width: 350px;
                animation: slideInFromBottom 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            const duration = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                notification.style.animation = 'slideOutToBottom 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        async function loadNotificationSettings() {
            try {
                const result = await ipcRenderer.invoke('get-notifications');
                const toggle = document.getElementById('notifications-toggle');

                if (result.success) {
                    toggle.checked = result.notifications_enabled;
                } else {
                    console.error('Failed to load notification settings:', result.error);
                    toggle.checked = true; // Default to enabled
                }
            } catch (error) {
                console.error('Error loading notification settings:', error);
                document.getElementById('notifications-toggle').checked = true;
            }
        }

        async function loadTelemetrySettings() {
            try {
                const result = await ipcRenderer.invoke('get-telemetry');
                const toggle = document.getElementById('telemetry-toggle');

                if (result.success) {
                    toggle.checked = result.telemetry_enabled;
                } else {
                    console.error('Failed to load telemetry settings:', result.error);
                    toggle.checked = true; // Default to enabled
                }
            } catch (error) {
                console.error('Error loading telemetry settings:', error);
                document.getElementById('telemetry-toggle').checked = true;
            }
        }

        async function showDesktopNotification(title, options) {
            // Check if desktop notifications are enabled in settings
            try {
                const result = await ipcRenderer.invoke('get-notifications');
                const notificationsEnabled = result.success ? result.notifications_enabled : true;

                if (Notification.permission === 'granted' && notificationsEnabled) {
                    new Notification(title, options);
                }
            } catch (error) {
                console.error('Error checking notification settings:', error);
                // Default to showing if error
                if (Notification.permission === 'granted') {
                    new Notification(title, options);
                }
            }
        }

        // Setup notification toggle event listener
        document.addEventListener('DOMContentLoaded', () => {
            const notificationsToggle = document.getElementById('notifications-toggle');
            if (notificationsToggle) {
                notificationsToggle.addEventListener('change', async (e) => {
                    try {
                        const enabled = e.target.checked;
                        const result = await ipcRenderer.invoke('set-notifications', enabled);

                        if (result.success) {
                            showModelNotification(
                                `Desktop notifications ${enabled ? 'enabled' : 'disabled'}`,
                                'success'
                            );
                        } else {
                            console.error('Failed to save notification setting:', result.error);
                            showModelNotification('Failed to save setting', 'error');
                            // Revert toggle
                            e.target.checked = !enabled;
                        }
                    } catch (error) {
                        console.error('Error saving notification setting:', error);
                        showModelNotification('Failed to save setting', 'error');
                        e.target.checked = !e.target.checked;
                    }
                });
            }

            const telemetryToggle = document.getElementById('telemetry-toggle');
            if (telemetryToggle) {
                telemetryToggle.addEventListener('change', async (e) => {
                    try {
                        const enabled = e.target.checked;
                        const result = await ipcRenderer.invoke('set-telemetry', enabled);

                        if (result.success) {
                            showModelNotification(
                                `Usage analytics ${enabled ? 'enabled' : 'disabled'}`,
                                'success'
                            );
                        } else {
                            console.error('Failed to save telemetry setting:', result.error);
                            showModelNotification('Failed to save setting', 'error');
                            e.target.checked = !enabled;
                        }
                    } catch (error) {
                        console.error('Error saving telemetry setting:', error);
                        showModelNotification('Failed to save setting', 'error');
                        e.target.checked = !e.target.checked;
                    }
                });
            }
        });

        async function runSetupFromSettings() {
            const btn = document.getElementById('run-setup-btn');
            btn.textContent = 'Running...';
            btn.disabled = true;

            try {
                // Show setup overlay in main window
                document.getElementById('setup-overlay').style.display = 'flex';

                // Run the setup process
                await runSetupProcess();

                btn.textContent = 'Done';
                setTimeout(() => {
                    btn.textContent = 'Run';
                    btn.disabled = false;
                }, 3000);
            } catch (error) {
                console.error('Setup failed:', error);
                btn.textContent = 'Failed';
                btn.disabled = false;
                setTimeout(() => { btn.textContent = 'Run'; }, 3000);
            }
        }
        
        function toggleDebugConsole() {
            const console = document.getElementById('debug-console');
            if (console.style.display === 'none') {
                console.style.display = 'block';
            } else {
                console.style.display = 'none';
            }
        }
        
        function clearDebugLog() {
            // Clear both debug consoles
            const setupConsole = document.getElementById('debug-console');
            if (setupConsole) {
                setupConsole.textContent = 'StenoAI Setup Debug Console\nCommands and output will appear here...\n\n';
            }
            
            const debugPanel = document.getElementById('debug-console-panel');
            if (debugPanel) {
                debugPanel.textContent = 'StenoAI Debug Console\nSession started - ready for activity...\n\n';
            }
        }

        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const formattedMessage = `[${timestamp}] ${message}\n`;
            
            // Log to setup wizard console if it exists (during setup)
            const setupConsole = document.getElementById('debug-console');
            if (setupConsole) {
                setupConsole.textContent += formattedMessage;
                setupConsole.scrollTop = setupConsole.scrollHeight;
            }
            
            // Always log to debug panel
            const debugPanel = document.getElementById('debug-console-panel');
            if (debugPanel) {
                debugPanel.textContent += formattedMessage;
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }
        }
        
        
        async function clearSystemState() {
            const btn = document.getElementById('clear-state-btn');
            btn.textContent = 'Clearing...';
            btn.disabled = true;

            try {
                const result = await ipcRenderer.invoke('clear-state');
                if (result.success) {
                    btn.textContent = 'Done';
                    log('Manual state clear successful');
                } else {
                    btn.textContent = 'Failed';
                    log('Manual state clear failed: ' + result.error);
                }

                setTimeout(() => {
                    btn.textContent = 'Clear';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Clear state failed:', error);
                btn.textContent = 'Failed';
                btn.disabled = false;
                setTimeout(() => {
                    btn.textContent = 'Clear';
                }, 2000);
            }
        }
        
        async function testUpdateCheck() {
            const btn = document.getElementById('test-update-btn');
            btn.textContent = 'Checking...';
            btn.disabled = true;

            try {
                // Clear dismissals to force showing banner
                const keys = Object.keys(localStorage);
                keys.forEach(k => { if (k.startsWith('announcement-dismissed-')) localStorage.removeItem(k); });

                await runAnnouncementChecks();

                btn.textContent = 'Done';
                setTimeout(() => {
                    btn.textContent = 'Check';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Announcement check test failed:', error);
                btn.textContent = 'Failed';
                btn.disabled = false;
                setTimeout(() => {
                    btn.textContent = 'Check';
                }, 2000);
            }
        }

        // Announcement system -- unified banner for updates + remote announcements

        const ANNOUNCEMENT_ICONS = {
            info: '<svg viewBox="0 0 20 20" fill="white"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>',
            release: '<svg viewBox="0 0 20 20" fill="white"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/></svg>',
            warning: '<svg viewBox="0 0 20 20" fill="white"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>'
        };

        const ANNOUNCEMENT_PRIORITY = { warning: 3, release: 2, info: 1 };

        function compareVersions(a, b) {
            const pa = a.split('.').map(Number);
            const pb = b.split('.').map(Number);
            for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
                const na = pa[i] || 0;
                const nb = pb[i] || 0;
                if (na < nb) return -1;
                if (na > nb) return 1;
            }
            return 0;
        }

        async function fetchRemoteAnnouncements() {
            try {
                const result = await ipcRenderer.invoke('check-announcements');
                if (result.success) {
                    return { announcements: result.announcements, currentVersion: result.currentVersion };
                }
            } catch (error) {
                log(`Announcements fetch error: ${error.message}`);
            }
            return { announcements: [], currentVersion: null };
        }

        async function fetchUpdateAnnouncement() {
            try {
                log('Checking for updates...');
                const result = await ipcRenderer.invoke('check-for-updates');
                if (result.success && result.updateAvailable) {
                    log(`Update available: v${result.latestVersion}`);
                    return {
                        id: `update-${result.latestVersion}`,
                        type: 'release',
                        title: `Update available: v${result.latestVersion}`,
                        message: result.releaseName || 'A new version is available.',
                        action_url: result.releaseUrl || null,
                        action_label: 'Download Update',
                        min_version: null,
                        max_version: null,
                        created_at: new Date().toISOString(),
                        expires_at: null
                    };
                } else if (result.success) {
                    log(`Up to date: v${result.currentVersion}`);
                }
            } catch (error) {
                log(`Update check error: ${error.message}`);
            }
            return null;
        }

        function isAnnouncementDismissed(id) {
            return localStorage.getItem(`announcement-dismissed-${id}`) === 'true';
        }

        function dismissAnnouncement(id) {
            localStorage.setItem(`announcement-dismissed-${id}`, 'true');
        }

        function isAnnouncementExpired(ann) {
            if (!ann.expires_at) return false;
            return new Date(ann.expires_at) < new Date();
        }

        function isAnnouncementInVersionRange(ann, currentVersion) {
            if (!currentVersion) return true;
            if (ann.min_version && compareVersions(currentVersion, ann.min_version) < 0) return false;
            if (ann.max_version && compareVersions(currentVersion, ann.max_version) > 0) return false;
            return true;
        }

        function resolveAnnouncement(allAnnouncements, currentVersion) {
            const eligible = allAnnouncements.filter(ann => {
                if (isAnnouncementDismissed(ann.id)) return false;
                if (isAnnouncementExpired(ann)) return false;
                if (!isAnnouncementInVersionRange(ann, currentVersion)) return false;
                return true;
            });

            // Sort by priority (highest first), then by created_at (newest first)
            eligible.sort((a, b) => {
                const pa = ANNOUNCEMENT_PRIORITY[a.type] || 0;
                const pb = ANNOUNCEMENT_PRIORITY[b.type] || 0;
                if (pb !== pa) return pb - pa;
                return new Date(b.created_at) - new Date(a.created_at);
            });

            return eligible.length > 0 ? eligible[0] : null;
        }

        function showAnnouncementBanner(ann) {
            currentAnnouncement = ann;

            // Set type class
            announcementBanner.className = 'announcement-banner show type-' + ann.type;

            // Set icon
            announcementIcon.innerHTML = ANNOUNCEMENT_ICONS[ann.type] || ANNOUNCEMENT_ICONS.info;

            // Set text
            announcementTitle.textContent = ann.title;
            announcementMessage.textContent = ann.message;

            // Set action button
            if (ann.action_url) {
                announcementActionBtn.textContent = ann.action_label || 'Learn More';
                announcementActionBtn.style.display = '';
            } else {
                announcementActionBtn.style.display = 'none';
            }

            document.querySelector('.header').classList.add('with-announcement-banner');
            log(`Showing announcement: [${ann.type}] ${ann.title}`);
        }

        function hideAnnouncementBanner() {
            announcementBanner.className = 'announcement-banner';
            document.querySelector('.header').classList.remove('with-announcement-banner');

            if (currentAnnouncement) {
                dismissAnnouncement(currentAnnouncement.id);
            }
            currentAnnouncement = null;
        }

        async function runAnnouncementChecks() {
            const [remoteData, updateAnn] = await Promise.all([
                fetchRemoteAnnouncements(),
                fetchUpdateAnnouncement()
            ]);

            const allAnnouncements = [...remoteData.announcements];
            // Only use auto-detected update if no eligible remote announcements
            const hasEligibleRemote = remoteData.announcements.some(a =>
                !isAnnouncementDismissed(a.id) && !isAnnouncementExpired(a)
            );
            if (updateAnn && !hasEligibleRemote) {
                allAnnouncements.push(updateAnn);
            }

            const winner = resolveAnnouncement(allAnnouncements, remoteData.currentVersion);
            if (winner) {
                showAnnouncementBanner(winner);
            } else {
                hideAnnouncementBanner();
            }
        }

        function startPeriodicAnnouncementCheck() {
            announcementCheckInterval = setInterval(runAnnouncementChecks, 6 * 60 * 60 * 1000);
        }

        function stopPeriodicAnnouncementCheck() {
            if (announcementCheckInterval) {
                clearInterval(announcementCheckInterval);
                announcementCheckInterval = null;
            }
        }

        // Announcement button event listeners
        announcementActionBtn.addEventListener('click', async () => {
            if (currentAnnouncement && currentAnnouncement.action_url) {
                try {
                    await ipcRenderer.invoke('open-release-page', currentAnnouncement.action_url);
                    log('Opened announcement action URL');
                    hideAnnouncementBanner();
                } catch (error) {
                    log(`Failed to open announcement URL: ${error.message}`);
                }
            }
        });

        dismissAnnouncementBtn.addEventListener('click', () => {
            hideAnnouncementBanner();
            log('Announcement dismissed');
        });

        // Theme functions
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(pref) {
            const eff = pref === 'system' ? getSystemTheme() : pref;
            if (eff === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }

        function initTheme() {
            const saved = localStorage.getItem('theme') || 'system';
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = saved;
                themeSelect.addEventListener('change', (e) => {
                    const value = e.target.value;
                    localStorage.setItem('theme', value);
                    applyTheme(value);
                });
            }
            applyTheme(saved);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if ((localStorage.getItem('theme') || 'system') === 'system') {
                    applyTheme('system');
                }
            });
        }

        // Initialize theme early
        initTheme();

        // Initialize
        initializeApp().then(() => {
            runStartupCheck().then(() => {
                // Check for announcements and updates after app initialization
                setTimeout(() => {
                    runAnnouncementChecks();
                }, 2000);

                // Start periodic checks
                startPeriodicAnnouncementCheck();
            });
        });
    </script>
</body>
</html>
