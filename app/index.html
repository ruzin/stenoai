<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>StenoAI</title>
    <!-- Distinctive typography - refined, professional -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
    (function() {
        var t = localStorage.getItem('theme') || 'system';
        var eff = t === 'system'
            ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
            : t;
        if (eff === 'light') document.documentElement.setAttribute('data-theme', 'light');
    })();
    </script>
    <style>
        :root {
            /* Refined color palette - softer contrast */
            --bg-deep: #0a0a0b;
            --bg-primary: #111113;
            --bg-elevated: #18181b;
            --bg-surface: #1f1f23;
            --border-subtle: #27272a;
            --border-default: #3f3f46;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-primary: #818cf8;
            --accent-glow: rgba(129, 140, 248, 0.15);
            --recording-red: #ef4444;
            --recording-glow: rgba(239, 68, 68, 0.2);
            --success-green: #22c55e;
            --warning-amber: #f59e0b;
        }

        [data-theme="light"] {
            --bg-deep: #e9ecf0;
            --bg-primary: #f1f3f6;
            --bg-elevated: #e1e5ea;
            --bg-surface: #d8dce3;
            --border-subtle: #cdd2d9;
            --border-default: #a8b0b9;
            --text-primary: #1a1d21;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --accent-primary: #5b5fc7;
            --accent-glow: rgba(91, 95, 199, 0.12);
            --recording-red: #dc3545;
            --recording-glow: rgba(220, 53, 69, 0.15);
            --success-green: #198754;
            --warning-amber: #d97706;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Subtle noise texture for depth */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
        }
        
        /* Window drag area - make the top portion draggable */
        .drag-area {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 28px;
            -webkit-app-region: drag;
            z-index: 100;
        }
        
        /* Make interactive elements non-draggable */
        .no-drag, .btn, .session-input, .settings-btn, button, input, select, textarea {
            -webkit-app-region: no-drag;
            pointer-events: auto;
        }
        
        /* Header with record controls */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 28px 20px 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: padding-top 0.3s ease;
            background: linear-gradient(180deg, var(--bg-elevated) 0%, var(--bg-primary) 100%);
            -webkit-app-region: drag;
        }

        .header.with-announcement-banner {
            padding-top: 76px;
            -webkit-app-region: no-drag;
        }

        .announcement-visible .drag-area {
            display: none;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            -webkit-app-region: no-drag;
        }

        .brand svg {
            transition: all 0.3s ease;
        }

        .brand:hover svg {
            filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.5));
            transform: scale(1.05);
        }

        .brand h1 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, #6366f1, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Prominent recording timer */
        .recording-timer {
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--recording-red);
            background: rgba(239, 68, 68, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid rgba(239, 68, 68, 0.2);
            letter-spacing: 0.05em;
        }

        .header-actions {
            display: flex;
            align-items: center;
        }

        .settings-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .settings-btn:hover {
            background: var(--bg-surface);
            border-color: var(--border-default);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .settings-btn:active {
            transform: translateY(0);
        }

        .record-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .session-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text-primary);
            padding: 6px 4px;
            font-size: 14px;
            font-family: inherit;
            min-width: 180px;
            outline: none;
            transition: all 0.2s ease;
        }

        .session-input:hover {
            border-bottom-color: var(--border-subtle);
        }

        .session-input:focus {
            border-bottom-color: var(--accent-primary);
            background: transparent;
            box-shadow: none;
        }

        .session-input::placeholder {
            color: var(--text-muted);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s ease;
        }

        .status-dot.ready {
            background: var(--success-green);
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.4);
        }
        .status-dot.recording {
            background: var(--recording-red);
            box-shadow: 0 0 12px var(--recording-glow), 0 0 24px var(--recording-glow);
            animation: recordingPulse 1.5s ease-in-out infinite;
        }
        .status-dot.processing {
            background: var(--warning-amber);
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes recordingPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 12px var(--recording-glow), 0 0 24px var(--recording-glow);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 16px var(--recording-glow), 0 0 32px var(--recording-glow);
            }
        }

        /* Audio waveform animation for recording state */
        .waveform {
            display: none;
            align-items: center;
            gap: 2px;
            height: 16px;
            margin-left: 8px;
        }

        .recording .waveform {
            display: flex;
        }

        .waveform-bar {
            width: 3px;
            background: var(--recording-red);
            border-radius: 2px;
            animation: waveform 0.8s ease-in-out infinite;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; height: 8px; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; height: 12px; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; height: 16px; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; height: 10px; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; height: 6px; }

        @keyframes waveform {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        .btn {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            padding: 6px 14px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 7px;
            font-family: inherit;
        }

        .btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-default);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-color: var(--border-default);
            font-weight: 600;
        }

        .btn-primary:hover {
            background: var(--bg-surface);
            border-color: var(--border-default);
        }

        .btn-danger {
            background: var(--recording-red);
            border-color: var(--recording-red);
            box-shadow: 0 0 20px var(--recording-glow);
        }

        .btn-danger:hover {
            background: var(--recording-red);
            filter: brightness(0.9);
            box-shadow: 0 0 28px var(--recording-glow);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Unified Settings Panel */
        .settings-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
            display: none;
        }

        .settings-backdrop.open {
            display: block;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -480px;
            width: 480px;
            height: 100vh;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-subtle);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .settings-close:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .settings-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .settings-nav {
            width: 140px;
            background: var(--bg-elevated);
            border-right: 1px solid var(--border-subtle);
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex-shrink: 0;
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.15s ease;
            text-align: left;
            border-left: 2px solid transparent;
        }

        .settings-nav-item:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .settings-nav-item.active {
            background: var(--bg-surface);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
        }

        .settings-nav-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-tab {
            display: none;
        }

        .settings-tab.active {
            display: block;
        }

        .settings-section {
            margin-bottom: 28px;
        }

        .settings-section h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-section h4 {
            margin: 16px 0 8px 0;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .settings-section p {
            margin: 0 0 12px 0;
            color: var(--text-muted);
            font-size: 13px;
            line-height: 1.5;
        }

        /* Settings row layout */
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .settings-row:last-of-type,
        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-row-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            min-width: 0;
        }

        .settings-row-text span {
            font-size: 13px;
            color: var(--text-primary);
        }

        .settings-row-text small {
            font-size: 12px;
            color: var(--text-muted);
        }

        .settings-action-btn {
            background: var(--bg-surface);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 12px;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            margin-left: 12px;
        }

        .settings-action-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .settings-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .settings-toggle {
            position: relative;
            width: 40px;
            height: 22px;
            flex-shrink: 0;
        }

        .settings-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .settings-toggle .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border-default);
            border-radius: 11px;
            transition: background 0.2s ease;
        }

        .settings-toggle .toggle-slider:before {
            content: "";
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: transform 0.2s ease;
        }

        .settings-toggle input:checked + .toggle-slider {
            background: var(--accent-primary);
        }

        .settings-toggle input:checked + .toggle-slider:before {
            transform: translateX(18px);
        }

        /* Full-width developer tab: hide nav */
        .settings-body.developer-active .settings-nav {
            display: none;
        }

        .dev-tab-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .dev-back-btn {
            background: none;
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s ease;
        }

        .dev-back-btn:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
            border-color: var(--border-default);
        }

        /* Debug console in developer tab */
        .debug-console {
            flex: 1;
            background: var(--bg-deep);
            color: var(--text-muted);
            padding: 16px;
            font-family: 'JetBrains Mono', 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 11px;
            line-height: 1.4;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            min-height: 300px;
            max-height: calc(100vh - 200px);
        }

        .debug-console::-webkit-scrollbar {
            width: 8px;
        }

        .debug-console::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        .debug-console::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        .debug-console::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .settings-version {
            margin-top: 20px;
            padding-top: 16px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Model list in AI tab */
        .model-list {
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: var(--border-subtle);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }

        .model-list-loading {
            padding: 12px;
            color: var(--text-muted);
            font-size: 13px;
            background: var(--bg-elevated);
        }

        .model-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-elevated);
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .model-item:hover {
            background: var(--bg-surface);
        }

        .model-item.active {
            background: rgba(129, 140, 248, 0.08);
        }

        .model-item-info {
            display: flex;
            flex-direction: column;
            gap: 1px;
            min-width: 0;
            flex: 1;
        }

        .model-item-name {
            font-size: 13px;
            font-weight: 500;
            font-family: 'JetBrains Mono', Monaco, monospace;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .model-item-name .model-tag {
            font-size: 10px;
            font-weight: 500;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-muted);
            background: var(--bg-deep);
            padding: 1px 5px;
            border-radius: 3px;
        }

        .model-item-name .model-active-badge {
            font-size: 10px;
            font-weight: 600;
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--accent-primary);
        }

        .model-item-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .model-item-action {
            flex-shrink: 0;
            margin-left: 12px;
        }

        .model-item .model-progress {
            display: none;
            margin-top: 4px;
        }

        .model-item .progress-text {
            font-size: 10px;
            color: var(--success-green);
            font-family: 'JetBrains Mono', Monaco, monospace;
        }

        /* Model list scrollbar */
        .model-list::-webkit-scrollbar {
            width: 8px;
        }

        .model-list::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 4px;
        }

        .model-list::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        .model-list::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Main content area */
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Sidebar with meetings list */
        .sidebar {
            width: 320px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sidebar.collapsed {
            width: 0;
            min-width: 0;
        }

        .sidebar > .sidebar-header,
        .sidebar > .folder-list,
        .sidebar > .folder-actions,
        .sidebar > .folder-separator,
        .sidebar > .meetings-list {
            opacity: 1;
            transition: opacity 0.2s ease 0.1s;
        }

        .sidebar.collapsed .sidebar-header,
        .sidebar.collapsed .folder-list,
        .sidebar.collapsed .folder-actions,
        .sidebar.collapsed .folder-separator,
        .sidebar.collapsed .meetings-list {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.1s ease;
        }

        .sidebar-toggle {
            position: fixed;
            left: 319px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 48px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-left: none;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 12px;
            z-index: 100;
            transition: left 0.3s ease, background 0.2s ease;
        }

        .sidebar-toggle:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .sidebar-toggle.collapsed {
            left: 0;
        }

        .sidebar-toggle-icon {
            transition: transform 0.3s ease;
        }

        .sidebar-toggle.collapsed .sidebar-toggle-icon {
            transform: rotate(180deg);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .sidebar-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .sidebar-header h2 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, #6366f1, #818cf8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        
        .search-wrapper {
            position: relative;
            margin: 8px 0 4px 0;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            padding: 10px 14px 10px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            width: 100%;
            outline: none;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            background: var(--bg-elevated);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .sidebar-header p {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .meetings-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px 8px;
        }

        /* Folder list above meetings */
        .folder-list {
            padding: 4px 8px 0;
            max-height: 180px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .folder-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12.5px;
            color: var(--text-secondary);
            transition: background 0.15s, color 0.15s;
            user-select: none;
            letter-spacing: 0.01em;
        }

        .folder-item:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .folder-item.active {
            background: var(--bg-surface);
            color: var(--text-primary);
            font-weight: 500;
        }

        .folder-item.drag-over {
            background: rgba(129, 140, 248, 0.12);
            outline: 1px solid rgba(129, 140, 248, 0.35);
            outline-offset: -1px;
            color: var(--text-primary);
        }

        .folder-item.dragging {
            opacity: 0.4;
        }

        .folder-item.drop-above {
            border-top: 2px solid var(--accent-primary);
        }

        .folder-item.drop-below {
            border-bottom: 2px solid var(--accent-primary);
        }

        .meeting-item[draggable="true"] {
            cursor: grab;
        }

        .meeting-item[draggable="true"]:active {
            cursor: grabbing;
            opacity: 0.6;
        }

        .folder-icon {
            width: 15px;
            height: 15px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .folder-icon svg {
            width: 15px;
            height: 15px;
        }

        .folder-count {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 500;
            min-width: 18px;
            text-align: center;
            padding: 1px 5px;
            border-radius: 9px;
            background: var(--bg-elevated);
            line-height: 1.4;
        }

        .folder-item.active .folder-count {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .folder-actions {
            display: none;
        }

        .folder-add-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .folder-add-btn:hover {
            color: var(--text-secondary);
            background: var(--bg-elevated);
        }

        .folder-separator {
            height: 1px;
            background: var(--border-subtle);
            margin: 4px 16px 4px;
            opacity: 0.6;
        }

        /* Compact meeting line items */
        .meeting-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
            position: relative;
        }

        .meeting-delete {
            position: absolute;
            top: 50%;
            right: 6px;
            transform: translateY(-50%);
            background: var(--bg-surface);
            border: none;
            color: var(--text-muted);
            border-radius: 4px;
            padding: 2px 5px;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.15s;
            line-height: 1;
        }

        .meeting-item:hover .meeting-delete {
            opacity: 1;
        }

        .meeting-delete:hover {
            background: var(--recording-red);
            color: var(--text-primary);
        }

        .meeting-item:hover {
            background: var(--bg-elevated);
        }

        .meeting-item.active {
            background: var(--bg-surface);
        }

        .meeting-item.active .meeting-dot {
            background: var(--accent-primary);
            box-shadow: 0 0 6px var(--accent-glow);
        }

        /* Staggered fade-in animation for meeting items */
        .meeting-item {
            animation: fadeSlideIn 0.2s ease-out forwards;
            opacity: 0;
        }

        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .meeting-item:nth-child(1) { animation-delay: 0.02s; }
        .meeting-item:nth-child(2) { animation-delay: 0.04s; }
        .meeting-item:nth-child(3) { animation-delay: 0.06s; }
        .meeting-item:nth-child(4) { animation-delay: 0.08s; }
        .meeting-item:nth-child(5) { animation-delay: 0.10s; }
        .meeting-item:nth-child(6) { animation-delay: 0.12s; }
        .meeting-item:nth-child(7) { animation-delay: 0.14s; }
        .meeting-item:nth-child(8) { animation-delay: 0.16s; }
        .meeting-item:nth-child(9) { animation-delay: 0.18s; }
        .meeting-item:nth-child(10) { animation-delay: 0.20s; }

        .meeting-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
            flex-shrink: 0;
            opacity: 0.5;
        }

        .meeting-item.active .meeting-line-title {
            color: var(--text-primary);
            font-weight: 600;
        }

        .meeting-line-body {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meeting-line-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .meeting-line-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .meeting-line-date {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            min-width: 52px;
            text-align: right;
        }

        .meeting-line-badge {
            font-size: 10px;
            font-weight: 600;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            padding: 1px 5px;
            border-radius: 3px;
            line-height: 1.4;
        }

        /* Context menu */
        .context-menu {
            position: fixed;
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: 4px;
            min-width: 180px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 9999;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background 0.1s;
        }

        .context-menu-item:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .context-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--recording-red);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-subtle);
            margin: 4px 0;
        }

        .meeting-item.processing {
            opacity: 0.7;
            position: relative;
        }

        .meeting-item-spinner {
            width: 12px;
            height: 12px;
            border: 1.5px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        }

        .meeting-item.processing .processing-overlay {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: var(--bg-deep);
            border-radius: 4px;
            padding: 4px 8px;
        }

        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--warning-amber);
            font-size: 12px;
            font-weight: 500;
        }
        
        .processing-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--bg-surface);
            border-top: 2px solid var(--warning-amber);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Legacy styles kept for compatibility */
        
        /* Main content area */
        .content {
            flex: 1;
            background: var(--bg-deep);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            color: var(--text-muted);
            padding: 40px;
        }

        .content-empty-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.3;
            filter: grayscale(0.5);
        }

        .content-empty h3 {
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .content-empty p {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .shortcut-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 8px;
        }

        .shortcut-hint span {
            color: var(--text-muted);
            font-size: 13px;
        }

        .kbd {
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            border-bottom-width: 2px;
            padding: 4px 8px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        /* Calendar sidebar section */
        .calendar-sidebar {
            display: none;
            flex-direction: column;
            flex-shrink: 0;
            padding-bottom: 8px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .calendar-sidebar.show {
            display: flex;
        }

        .calendar-sidebar-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            padding: 0 0 4px;
        }

        .calendar-sidebar-header svg {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .calendar-refresh-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            transition: all 0.15s ease;
        }

        .calendar-refresh-btn:hover {
            color: var(--text-primary);
            background: var(--bg-surface);
        }

        .calendar-refresh-btn.spinning svg {
            animation: spin 0.6s ease;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .calendar-sidebar-item {
            display: flex;
            align-items: center;
            height: 32px;
            padding: 0 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
            gap: 8px;
        }

        .calendar-sidebar-item:hover {
            background: var(--bg-surface);
        }

        .calendar-sidebar-item.active {
            background: var(--bg-surface);
        }

        .calendar-sidebar-item .event-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-sidebar-item .event-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .calendar-sidebar-item .event-time {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            min-width: 52px;
            text-align: right;
        }

        .calendar-sidebar-separator {
            display: none;
        }

        /* Calendar event detail view */
        .calendar-event-detail {
            padding: 40px 48px;
            height: 100%;
            overflow-y: auto;
            display: none;
            flex-direction: column;
        }

        .calendar-event-detail.show {
            display: flex;
        }

        .calendar-detail-back {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            padding: 4px 0;
            margin-bottom: 20px;
            transition: color 0.15s ease;
        }

        .calendar-detail-back:hover {
            color: var(--text-primary);
        }

        .calendar-detail-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 16px;
        }

        .calendar-detail-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 28px;
        }

        .calendar-detail-meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .calendar-detail-meta-row svg {
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .calendar-detail-section {
            margin-bottom: 24px;
        }

        .calendar-detail-section h3 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin: 0 0 10px;
        }

        .calendar-detail-attendees {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .calendar-detail-attendee {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .calendar-detail-description {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .calendar-record-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
            align-self: flex-start;
        }

        .calendar-record-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-default);
            transform: translateY(-1px);
        }

        .calendar-record-btn .record-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #ef4444;
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.4);
        }

        /* Meeting detail view */
        .meeting-detail {
            padding: 32px;
            height: 100%;
            overflow-y: auto;
            display: none;
        }

        .meeting-detail.show {
            display: block;
        }
        
        .meeting-header {
            margin-bottom: 36px;
            padding-bottom: 28px;
            border-bottom: 1px solid var(--border-subtle);
        }
        
        .meeting-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .meeting-title {
            font-size: 26px;
            font-weight: 700;
            color: color-mix(in srgb, var(--text-primary) 40%, var(--text-secondary));
            margin: 0;
            flex: 1;
            letter-spacing: -0.02em;
            line-height: 1.3;
        }
        
        .reprocess-btn {
            background: var(--bg-surface);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 4px 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .reprocess-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .reprocess-btn:active {
            transform: translateY(0);
        }

        .reprocess-btn:disabled {
            background: var(--bg-surface);
            color: var(--text-muted);
            border-color: var(--border-subtle);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .reprocess-btn.processing {
            background: var(--warning-amber);
            color: var(--bg-deep);
            border-color: var(--warning-amber);
        }
        
        .reprocess-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .transcript-container {
            position: relative;
        }
        
        .copy-transcript-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
            z-index: 10;
        }
        
        .copy-transcript-btn:hover {
            background: var(--bg-elevated);
            opacity: 1;
            transform: translateY(-1px);
        }
        
        .copy-transcript-btn:active {
            transform: translateY(0);
        }
        
        .copy-transcript-btn.copied {
            background: var(--success-green);
            border-color: var(--success-green);
            opacity: 1;
        }

        .copy-notes-btn {
            background: var(--bg-surface);
            color: var(--text-secondary);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            padding: 4px 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .copy-notes-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .copy-notes-btn:active {
            transform: translateY(1px);
        }

        .copy-notes-btn.copied {
            background: var(--success-green);
            border-color: var(--success-green);
            color: var(--bg-primary);
        }

        .meeting-title-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0;
            max-width: fit-content;
        }

        .meeting-title {
            margin: 0;
            color: color-mix(in srgb, var(--text-primary) 40%, var(--text-secondary));
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 600px;
        }

        .meeting-title-input {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 24px;
            font-weight: 600;
            outline: none;
            flex: 1;
        }

        .meeting-title-input:focus {
            border-color: var(--text-muted);
            background: var(--bg-surface);
        }

        .edit-title-btn {
            background: transparent;
            border: 1px solid var(--border-default);
            color: var(--text-muted);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
        }

        .meeting-title-container:hover .edit-title-btn {
            opacity: 1;
        }

        .edit-title-btn:hover {
            background: var(--bg-surface);
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        .title-edit-actions {
            display: flex;
            gap: 8px;
        }

        .save-title-btn, .cancel-title-btn {
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            border: 1px solid;
        }

        .save-title-btn {
            background: var(--success-green);
            border-color: var(--success-green);
            color: var(--bg-primary);
        }

        .save-title-btn:hover {
            background: var(--success-green);
            filter: brightness(0.9);
        }

        .cancel-title-btn {
            background: transparent;
            border-color: var(--border-default);
            color: var(--text-muted);
        }

        .cancel-title-btn:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .meeting-info {
            display: flex;
            gap: 24px;
            align-items: center;
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 10px;
        }
        
        .meeting-section {
            margin-bottom: 36px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: -0.01em;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-content {
            color: var(--text-secondary);
            line-height: 1.7;
            font-size: 15px;
        }
        
        .key-points-list {
            list-style: none;
            padding: 0;
        }

        .key-points-list li {
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .key-points-list li:before {
            content: "";
            position: absolute;
            left: 0;
            top: 14px;
            width: 5px;
            height: 5px;
            background: var(--accent-primary);
            border-radius: 50%;
        }

        .action-items-list {
            list-style: none;
            padding: 0;
        }

        .action-items-list li {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--accent-primary);
            border-radius: 0 8px 8px 0;
            padding: 14px 16px;
            margin-bottom: 10px;
            color: var(--text-secondary);
            line-height: 1.6;
            transition: all 0.2s ease;
        }

        .action-items-list li:hover {
            background: var(--bg-surface);
            border-left-color: var(--success-green);
        }
        
        /* Transcript section */
        .transcript-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 24px;
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, monospace;
            font-size: 13px;
            line-height: 1.8;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* File drop area */
        .drop-zone {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .drop-zone.active {
            display: flex;
        }
        
        .drop-message {
            text-align: center;
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-default);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Announcement Banner */
        .announcement-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            color: white;
            padding: 12px 20px 12px 80px;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 1500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease-out;
            -webkit-app-region: no-drag;
        }

        .announcement-banner.type-info {
            background: linear-gradient(135deg, #0ea5e9, #06b6d4);
        }

        .announcement-banner.type-release {
            background: linear-gradient(135deg, #4F46E5, #7C3AED);
        }

        .announcement-banner.type-warning {
            background: linear-gradient(135deg, #d97706, #f59e0b);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromBottom {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideOutToBottom {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100%);
                opacity: 0;
            }
        }

        .announcement-banner.show {
            display: flex;
        }

        .announcement-info {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .announcement-icon {
            flex-shrink: 0;
            display: flex;
            align-items: center;
        }

        .announcement-icon svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .announcement-text {
            font-size: 14px;
            min-width: 0;
        }

        .announcement-text .announcement-title {
            font-weight: 600;
        }

        .announcement-text .announcement-message {
            opacity: 0.9;
            margin-left: 6px;
        }

        .announcement-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .announcement-btn {
            background: white;
            border: none;
            color: #4F46E5;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .type-info .announcement-btn {
            color: #0e7490;
        }

        .type-warning .announcement-btn {
            color: #92400e;
        }

        .announcement-btn:hover {
            background: #f3f4f6;
        }

        .dismiss-announcement {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            cursor: pointer;
            padding: 4px;
            border-radius: 2px;
            transition: color 0.2s;
        }

        .dismiss-announcement:hover {
            color: white;
        }

        /* Setup Modal - Redesigned */
        .setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-deep);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            overflow: hidden;
        }

        .setup-content {
            width: 100%;
            max-width: 560px;
            height: 100%;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 32px 24px;
            overflow: hidden;
        }

        /* Progress Indicator - Step circles */
        .setup-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .setup-progress-step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: var(--bg-surface);
            color: var(--text-muted);
            border: 2px solid var(--border-subtle);
        }

        .setup-progress-step.active {
            background: var(--bg-primary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        .setup-progress-step.completed {
            background: var(--success-green) !important;
            color: white !important;
            border-color: var(--success-green) !important;
        }

        .setup-progress-step.completed svg {
            width: 16px;
            height: 16px;
            stroke: white !important;
        }

        .setup-progress-line {
            width: 24px;
            height: 2px;
            background: var(--border-subtle);
            transition: background 0.3s ease;
        }

        .setup-progress-line.completed {
            background: var(--success-green);
        }

        /* Setup Header */
        .setup-header {
            text-align: center;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .setup-header h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .setup-header p {
            font-size: 15px;
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* Setup Steps Container - Scrollable */
        .setup-steps {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            margin-bottom: 20px;
        }

        /* Download Card Style */
        .setup-step {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .setup-step:last-child {
            margin-bottom: 0;
        }

        .step-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .step-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .step-text h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .step-text p {
            font-size: 13px;
            color: var(--text-muted);
        }

        .step-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .step-badge.waiting {
            background: var(--bg-surface);
            color: var(--text-muted);
        }

        .step-badge.active {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-amber);
        }

        .step-badge.completed {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success-green);
        }

        .step-badge.failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--recording-red);
        }

        /* Progress Bar */
        .step-progress {
            margin-top: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-surface);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), #a78bfa);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .setup-step.completed .progress-fill {
            background: var(--success-green);
            width: 100%;
        }

        .setup-step.failed .progress-fill {
            background: var(--recording-red);
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .progress-details .progress-percent {
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Ollama Download Prompt */
        .ollama-prompt {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(14, 165, 233, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .ollama-prompt h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .ollama-prompt p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .ollama-prompt .btn-download {
            background: linear-gradient(135deg, #6366f1, #0ea5e9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .ollama-prompt .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }

        .ollama-prompt .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-subtle);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s ease;
        }

        .ollama-prompt .btn-secondary:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        /* Error state with retry */
        .step-error {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .step-error p {
            font-size: 13px;
            color: var(--recording-red);
            margin-bottom: 8px;
        }

        .step-error .btn-retry {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .step-error .btn-retry:hover {
            background: var(--bg-elevated);
        }

        /* Debug Console - Collapsible */
        .setup-debug {
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .debug-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .debug-toggle:hover {
            background: var(--bg-surface);
        }

        .debug-toggle span {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .debug-toggle svg {
            transition: transform 0.2s ease;
        }

        .debug-toggle.open svg {
            transform: rotate(180deg);
        }

        .debug-console {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            line-height: 1.5;
            color: var(--text-muted);
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            display: none;
        }

        #tab-developer {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        #tab-developer.active {
            display: flex;
        }

        #tab-developer .settings-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
            min-height: 0;
        }

        #tab-developer #debug-console-panel {
            flex: 1;
            height: auto;
            border-radius: 8px;
            border-top: 1px solid var(--border-subtle);
            min-height: 0;
        }

        .debug-console.show {
            display: block;
        }

        /* Setup Actions */
        .setup-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
        }

        .setup-actions .btn-primary {
            width: 100%;
            padding: 14px 24px;
            font-size: 15px;
            font-weight: 600;
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .setup-actions .btn-primary:hover:not(:disabled) {
            background: var(--bg-elevated);
            transform: translateY(-1px);
        }

        .setup-actions .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .setup-actions .btn-primary.success {
            background: var(--success-green);
            border-color: var(--success-green);
            color: white;
        }

        .setup-footer {
            text-align: center;
            margin-top: 8px;
        }

        .setup-footer a {
            font-size: 12px;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .setup-footer a:hover {
            color: var(--text-secondary);
            text-decoration: underline;
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .setup-step {
            animation: fadeInUp 0.3s ease forwards;
        }

        .setup-step:nth-child(1) { animation-delay: 0s; }
        .setup-step:nth-child(2) { animation-delay: 0.05s; }
        .setup-step:nth-child(3) { animation-delay: 0.1s; }
        .setup-step:nth-child(4) { animation-delay: 0.15s; }
        .setup-step:nth-child(5) { animation-delay: 0.2s; }

        /* Spinner for loading states */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* AI Query Popup */
        .ai-query-popup {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1001;
            display: none;
            justify-content: center;
            padding: 24px;
            pointer-events: none;
        }

        .ai-query-popup.show {
            display: flex;
        }

        .ai-query-container {
            background: var(--bg-elevated);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.05);
            width: 100%;
            max-width: 600px;
            pointer-events: auto;
            animation: slideUp 0.2s ease-out;
            backdrop-filter: blur(12px);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .ai-query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .ai-query-header span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-query-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            line-height: 1;
        }

        .ai-query-close:hover {
            background: var(--bg-surface);
            color: var(--text-primary);
        }

        .ai-query-input-row {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
        }

        #ai-query-input {
            flex: 1;
            background: var(--bg-surface);
            border: 1px solid var(--border-default);
            color: var(--text-primary);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: all 0.2s ease;
        }

        #ai-query-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        #ai-query-input::placeholder {
            color: var(--text-muted);
        }

        .ai-query-submit {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-query-submit:hover {
            background: var(--accent-primary);
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        .ai-query-submit:active {
            transform: translateY(0);
        }

        .ai-query-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .ai-query-response {
            padding: 0 20px 20px;
            display: none;
        }

        .ai-query-response.show {
            display: block;
        }

        .ai-query-response-content {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 16px;
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .ai-query-response-content.loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-muted);
            padding: 24px;
        }

        .ai-query-response-content.error {
            color: var(--recording-red);
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }

        .ai-query-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-default);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ask AI Button */
        .ask-ai-btn {
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.15) 0%, rgba(99, 102, 241, 0.15) 100%);
            border: 1px solid rgba(129, 140, 248, 0.3);
            color: var(--accent-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .ask-ai-btn:hover {
            background: linear-gradient(135deg, rgba(129, 140, 248, 0.25) 0%, rgba(99, 102, 241, 0.25) 100%);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .ask-ai-btn kbd {
            background: rgba(129, 140, 248, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-family: inherit;
            margin-left: 4px;
        }

        /* Light mode specific overrides */
        [data-theme="light"] .brand h1 {
            background: linear-gradient(135deg, #4338ca, #6366f1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        [data-theme="light"] .brand svg rect:first-child {
            fill: #e0e7ff;
        }
        [data-theme="light"] .brand svg path {
            fill: #4338ca;
        }

        [data-theme="light"] body {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
        }

        [data-theme="light"] .announcement-banner.type-info {
            background: linear-gradient(135deg, #0284c7, #0891b2);
        }
        [data-theme="light"] .announcement-banner.type-release {
            background: linear-gradient(135deg, #4338ca, #6366f1);
        }
        [data-theme="light"] .announcement-banner.type-warning {
            background: linear-gradient(135deg, #c2410c, #d97706);
        }

        [data-theme="light"] .ai-query-container {
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.06);
        }

        [data-theme="light"] .setup-modal {
            background: var(--bg-deep);
        }

        [data-theme="light"] .setup-step {
            background: white;
            border-color: var(--border-subtle);
        }

        [data-theme="light"] .setup-step.completed {
            border-color: var(--success-green);
            background: rgba(25, 135, 84, 0.06);
        }

        [data-theme="light"] .setup-step.failed {
            border-color: var(--recording-red);
            background: rgba(220, 53, 69, 0.06);
        }

        [data-theme="light"] .step-icon {
            background: var(--bg-elevated);
        }

        [data-theme="light"] .ollama-prompt {
            background: linear-gradient(135deg, rgba(91, 95, 199, 0.08), rgba(14, 165, 233, 0.08));
            border-color: rgba(91, 95, 199, 0.2);
        }

        [data-theme="light"] .debug-toggle {
            background: white;
        }

        [data-theme="light"] .debug-console {
            background: var(--bg-elevated);
        }

        [data-theme="light"] .setup-progress-step {
            background: white;
        }

        [data-theme="light"] .setup-progress-step.active {
            background: white;
        }

        [data-theme="light"] ::-webkit-scrollbar-track {
            background: var(--bg-elevated);
        }
        [data-theme="light"] ::-webkit-scrollbar-thumb {
            background: var(--border-default);
        }

        /* Theme select dropdown */
        .theme-select {
            background: var(--bg-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            flex-shrink: 0;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2371717a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 26px;
        }

        .theme-select:hover {
            border-color: var(--accent-primary);
        }

        .theme-select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
    </style>
</head>
<body>
    <!-- Window drag area -->
    <div class="drag-area"></div>
    
    <!-- Announcement Banner -->
    <div class="announcement-banner" id="announcement-banner">
        <div class="announcement-info">
            <div class="announcement-icon" id="announcement-icon"></div>
            <div class="announcement-text">
                <span class="announcement-title" id="announcement-title"></span>
                <span class="announcement-message" id="announcement-message"></span>
            </div>
        </div>
        <div class="announcement-actions">
            <button class="announcement-btn" id="announcement-action-btn" style="display:none;">Learn More</button>
            <button class="dismiss-announcement" id="dismiss-announcement-btn" title="Dismiss">&#x2715;</button>
        </div>
    </div>

    <!-- Header with recording controls -->
    <div class="header">
        <div class="brand">
            <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="32" height="32" rx="8" fill="#0f172a"/>
                <rect width="30" height="30" x="1" y="1" rx="7" stroke="rgba(255,255,255,0.1)"/>
                <path d="M16 10c-1.1 0-2 .9-2 2v4c0 1.1.9 2 2 2s2-.9 2-2v-4c0-1.1-.9-2-2-2z" fill="white"/>
                <path d="M12 15v1c0 2.2 1.8 4 4 4s4-1.8 4-4v-1h1v1c0 2.7-1.9 4.9-4.5 5.4v1.6h2v1h-5v-1h2v-1.6c-2.6-.5-4.5-2.7-4.5-5.4v-1h1z" fill="white"/>
            </svg>
            <h1>StenoAI</h1>
        </div>
        
        <div class="record-controls">
            <div class="status" id="status-container">
                <div class="status-dot ready" id="status-dot"></div>
                <span id="status-text" style="font-size: 13px; color: var(--text-secondary);">Ready</span>
                <div class="waveform" id="waveform">
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                    <div class="waveform-bar"></div>
                </div>
            </div>
            
            <input type="text" class="session-input" id="session-name" placeholder="Name this session...">
            
            <button class="btn btn-primary" id="start-btn">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="5"/></svg> Record
            </button>

            <button class="btn btn-danger" id="stop-btn" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="1" y="1" width="10" height="10" rx="1.5"/></svg> Stop
            </button>

            <button class="btn" id="pause-btn" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="1.5" y="1" width="3" height="10" rx="1"/><rect x="7.5" y="1" width="3" height="10" rx="1"/></svg> Pause
            </button>
        </div>
        
        <div class="header-actions">
            <button class="settings-btn" id="settings-btn" title="Settings (Cmd+,)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Main content area -->
    <div class="main">
        <!-- Sidebar toggle (outside sidebar so it's always visible) -->
        <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
            <span class="sidebar-toggle-icon"></span>
        </button>

        <!-- Sidebar with meetings -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="calendar-sidebar" id="calendar-sidebar">
                    <div class="calendar-sidebar-header">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        Coming Up
                        <button class="calendar-refresh-btn" id="calendar-refresh-btn" onclick="refreshCalendarEvents()" title="Refresh">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        </button>
                    </div>
                    <div id="calendar-sidebar-list"></div>
                </div>
                <div class="sidebar-title">
                    <h2>Meetings</h2>
                </div>
                <div class="search-wrapper">
                    <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="search-input" id="search-input" placeholder="Search meetings...">
                </div>
            </div>

            <div class="folder-list" id="folder-list">
                <!-- Folders rendered here -->
            </div>
            <div class="folder-actions">
                <button class="folder-add-btn" id="add-folder-btn" onclick="createNewFolder()">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    New folder
                </button>
            </div>
            <div class="folder-separator"></div>
            <div class="meetings-list" id="meetings-list">
                <!-- Meetings will be loaded here -->
            </div>
        </div>

        <!-- Context menu for folders -->
        <div class="context-menu" id="folder-context-menu" onclick="event.stopPropagation()">
            <div class="context-menu-item danger" onclick="event.stopPropagation(); deleteContextFolder()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                Delete folder
            </div>
        </div>

        <!-- Context menu for meetings -->
        <div class="context-menu" id="meeting-context-menu" onclick="event.stopPropagation()">
            <div class="context-menu-item" onclick="event.stopPropagation(); showFolderPicker(event)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                Move to...
            </div>
            <div class="context-menu-separator"></div>
            <div class="context-menu-item danger" onclick="event.stopPropagation(); deleteContextMeeting()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                Delete
            </div>
        </div>

        <!-- Main content -->
        <div class="content">
            <!-- Empty state -->
            <div class="content-empty" id="empty-state">
                <h3>Ready to capture your meeting</h3>
                <p>Select a meeting from the sidebar or start recording</p>
                <div class="shortcut-hint">
                    <span>Quick start:</span>
                    <kbd class="kbd"></kbd>
                    <kbd class="kbd"></kbd>
                    <kbd class="kbd">R</kbd>
                    <span>anywhere</span>
                </div>
            </div>

            <!-- Calendar event detail view -->
            <div class="calendar-event-detail" id="calendar-event-detail">
                <button class="calendar-detail-back" id="calendar-detail-back">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    Back
                </button>
                <h2 class="calendar-detail-title" id="calendar-detail-title"></h2>
                <div class="calendar-detail-meta">
                    <div class="calendar-detail-meta-row" id="calendar-detail-time">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        <span></span>
                    </div>
                    <div class="calendar-detail-meta-row" id="calendar-detail-date">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        <span></span>
                    </div>
                </div>
                <div class="calendar-detail-section" id="calendar-detail-attendees-section" style="display: none;">
                    <h3>Attendees</h3>
                    <div class="calendar-detail-attendees" id="calendar-detail-attendees"></div>
                </div>
                <div class="calendar-detail-section" id="calendar-detail-description-section" style="display: none;">
                    <h3>Description</h3>
                    <div class="calendar-detail-description" id="calendar-detail-description"></div>
                </div>
                <button class="calendar-record-btn" id="calendar-record-btn">
                    <span class="record-dot"></span>
                    Record this meeting
                </button>
            </div>

            <!-- Meeting detail view -->
            <div class="meeting-detail" id="meeting-detail">
                <div class="meeting-header">
                    <div class="meeting-header-top">
                        <div class="meeting-title-container">
                            <h1 class="meeting-title" id="detail-title">Meeting Title</h1>
                            <button class="edit-title-btn" id="edit-title-btn" title="Edit meeting name">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button class="ask-ai-btn" id="ask-ai-btn" title="Ask Steno about this meeting">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                </svg>
Ask Steno
                            </button>
                            <button class="copy-notes-btn" id="copy-notes-btn" title="Copy meeting notes">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                            <button class="reprocess-btn" id="reprocess-btn" title="Reprocess meeting">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="meeting-info">
                        <span id="detail-date">Date</span>
                        <span id="detail-duration">Duration</span>
                    </div>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Summary
                    </h2>
                    <div class="section-content" id="detail-summary">
                        Meeting summary will appear here...
                    </div>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Participants
                    </h2>
                    <div class="section-content" id="detail-participants">
                        <!-- Participants will be loaded here -->
                    </div>
                </div>

                <div class="meeting-section" id="discussion-areas-section">
                    <h2 class="section-title">
                        <span></span> Key Topics
                    </h2>
                    <div class="discussion-areas-container" id="detail-discussion-areas">
                        <!-- Key topics will be loaded here -->
                    </div>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Key Points
                    </h2>
                    <ul class="key-points-list" id="detail-key-points">
                        <!-- Key points will be loaded here -->
                    </ul>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Action Items
                    </h2>
                    <ul class="action-items-list" id="detail-action-items">
                        <!-- Action items will be loaded here -->
                    </ul>
                </div>

                <div class="meeting-section">
                    <h2 class="section-title">
                        <span></span> Full Transcript
                    </h2>
                    <div class="transcript-container">
                        <div class="transcript-content" id="detail-transcript">
                            Full transcript will appear here...
                        </div>
                        <button class="copy-transcript-btn" id="copy-transcript-btn" title="Copy transcript to clipboard">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drop zone for files -->
    <div class="drop-zone" id="drop-zone">
        <div class="drop-message">
            Drop audio file to process
        </div>
    </div>

    <!-- AI Query Popup -->
    <div class="ai-query-popup" id="ai-query-popup">
        <div class="ai-query-container">
            <div class="ai-query-header">
                <span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Ask Steno about this meeting
                </span>
                <button class="ai-query-close" id="ai-query-close">&times;</button>
            </div>
            <div class="ai-query-input-row">
                <input type="text" id="ai-query-input" placeholder="What was discussed about...">
                <button class="ai-query-submit" id="ai-query-submit">
                    Ask
                </button>
            </div>
            <div class="ai-query-response" id="ai-query-response">
                <div class="ai-query-response-content" id="ai-query-response-content"></div>
            </div>
        </div>
    </div>

    <!-- Setup overlay - Redesigned -->
    <div class="setup-modal" id="setup-overlay" style="display: none;">
        <div class="setup-content">
            <!-- Progress Indicator -->
            <div class="setup-progress" id="setup-progress-indicator">
                <div class="setup-progress-step active" data-step="1">1</div>
                <div class="setup-progress-line"></div>
                <div class="setup-progress-step" data-step="2">2</div>
                <div class="setup-progress-line"></div>
                <div class="setup-progress-step" data-step="3">3</div>
            </div>

            <!-- Header -->
            <div class="setup-header">
                <h2 id="setup-title">Welcome to StenoAI</h2>
                <p id="setup-description">We'll help you set up everything needed for meeting intelligence.</p>
            </div>

            <!-- Steps Container -->
            <div class="setup-steps" id="setup-steps">
                <!-- Ollama Download Prompt (shown when Ollama not installed) -->
                <div class="ollama-prompt" id="ollama-prompt" style="display: none;">
                    <h3>Ollama Required</h3>
                    <p>StenoAI uses Ollama to run AI models locally on your device. It's free and keeps your data private.</p>
                    <button class="btn-download" onclick="openOllamaDownload()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download Ollama
                    </button>
                    <button class="btn-secondary" onclick="recheckOllama()">I've installed it - Check again</button>
                </div>

                <!-- Step 1: Permissions -->
                <div class="setup-step" id="step-microphone">
                    <div class="step-header">
                        <div class="step-info">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="23"></line>
                                    <line x1="8" y1="23" x2="16" y2="23"></line>
                                </svg>
                            </div>
                            <div class="step-text">
                                <h3>Microphone Access</h3>
                                <p>Required for recording meetings</p>
                            </div>
                        </div>
                        <span class="step-badge waiting" id="microphone-badge">Waiting</span>
                    </div>
                    <div class="step-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="microphone-progress"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Transcription Engine (Whisper) -->
                <div class="setup-step" id="step-whisper">
                    <div class="step-header">
                        <div class="step-info">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            <div class="step-text">
                                <h3>Transcription Engine</h3>
                                <p>Converts speech to text locally</p>
                            </div>
                        </div>
                        <span class="step-badge waiting" id="whisper-badge">Waiting</span>
                    </div>
                    <div class="step-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="whisper-progress"></div>
                        </div>
                        <div class="progress-details" id="whisper-details" style="display: none;">
                            <span class="progress-size">Installing dependencies...</span>
                            <span class="progress-percent">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Summarization Engine (Ollama + Model) -->
                <div class="setup-step" id="step-ollama">
                    <div class="step-header">
                        <div class="step-info">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                </svg>
                            </div>
                            <div class="step-text">
                                <h3>Summarization Engine</h3>
                                <p>AI-powered meeting summaries (~2GB)</p>
                            </div>
                        </div>
                        <span class="step-badge waiting" id="ollama-badge">Waiting</span>
                    </div>
                    <div class="step-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="ollama-progress"></div>
                        </div>
                        <div class="progress-details" id="ollama-details" style="display: none;">
                            <span class="progress-size">Downloading model...</span>
                            <span class="progress-percent">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Hidden steps for system checks (run silently) -->
                <div class="setup-step" id="step-system" style="display: none;">
                    <div class="step-header">
                        <div class="step-info">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                </svg>
                            </div>
                            <div class="step-text">
                                <h3>System Check</h3>
                                <p>Verifying requirements</p>
                            </div>
                        </div>
                        <span class="step-badge waiting" id="system-badge">Waiting</span>
                    </div>
                </div>

                <div class="setup-step" id="step-python" style="display: none;">
                    <div class="step-header">
                        <div class="step-info">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                                </svg>
                            </div>
                            <div class="step-text">
                                <h3>Python Dependencies</h3>
                                <p>Installing libraries</p>
                            </div>
                        </div>
                        <span class="step-badge waiting" id="python-badge">Waiting</span>
                    </div>
                </div>

                <div class="setup-step" id="step-ffmpeg" style="display: none;">
                    <div class="step-header">
                        <div class="step-info">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                </svg>
                            </div>
                            <div class="step-text">
                                <h3>Audio Processing</h3>
                                <p>Installing ffmpeg</p>
                            </div>
                        </div>
                        <span class="step-badge waiting" id="ffmpeg-badge">Waiting</span>
                    </div>
                </div>

                <div class="setup-step" id="step-test" style="display: none;">
                    <div class="step-header">
                        <div class="step-info">
                            <div class="step-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                            <div class="step-text">
                                <h3>System Test</h3>
                                <p>Verifying installation</p>
                            </div>
                        </div>
                        <span class="step-badge waiting" id="test-badge">Waiting</span>
                    </div>
                </div>
            </div>

            <!-- Debug Console - Collapsible -->
            <div class="setup-debug">
                <div class="debug-toggle" id="debug-toggle" onclick="toggleDebugConsole()">
                    <span>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                            <line x1="9" y1="4" x2="9" y2="20"></line>
                            <line x1="4" y1="10" x2="9" y2="10"></line>
                            <line x1="4" y1="16" x2="9" y2="16"></line>
                        </svg>
                        Debug Console
                    </span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                <div class="debug-console" id="debug-console">StenoAI Setup
Commands and output will appear here...

</div>
            </div>

            <!-- Actions -->
            <div class="setup-actions">
                <button class="btn-primary" id="setup-auto-start">Begin Setup</button>
                <button class="btn-primary success" id="setup-continue" style="display: none;">Continue to App</button>
            </div>

            <div class="setup-footer">
                <a href="https://github.com/ruzin/stenoai/issues" target="_blank">Report an issue</a>
            </div>
        </div>
    </div>

    <!-- Settings Backdrop -->
    <div class="settings-backdrop" id="settings-backdrop" onclick="toggleSettings()"></div>

    <!-- Unified Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="settings-close" onclick="toggleSettings()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="settings-body">
            <nav class="settings-nav">
                <button class="settings-nav-item active" data-tab="general">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    General
                </button>
                <button class="settings-nav-item" data-tab="ai">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a4 4 0 0 1 4 4c0 1.1-.9 2-2 2h-4c-1.1 0-2-.9-2-2a4 4 0 0 1 4-4z"></path>
                        <path d="M12 8v2"></path>
                        <path d="M8 14h8"></path>
                        <path d="M9 18h6"></path>
                        <path d="M10 22h4"></path>
                        <path d="M12 10v4"></path>
                    </svg>
                    AI
                </button>
                <button class="settings-nav-item" data-tab="developer" id="developer-nav-item" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="16 18 22 12 16 6"></polyline>
                        <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    Developer
                </button>
            </nav>
            <div class="settings-content">
                <!-- General Tab -->
                <div class="settings-tab active" id="tab-general">
                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Appearance</span>
                            <small>Choose light, dark, or match your system</small>
                        </div>
                        <select class="theme-select" id="theme-select">
                            <option value="system">System</option>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Google Calendar</span>
                            <small id="google-cal-status-text" style="color: var(--text-muted);">Checking...</small>
                        </div>
                        <button class="settings-action-btn" id="google-cal-btn" onclick="toggleGoogleCalendar()">Connect</button>
                    </div>

                    <div class="settings-row" style="flex-wrap: wrap;">
                        <div class="settings-row-text" style="flex: 1; min-width: 0;">
                            <span>Storage location</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                            <button class="settings-action-btn" id="choose-storage-btn" onclick="chooseStorageLocation()" style="margin-left: 0;">Choose...</button>
                            <button class="settings-action-btn" id="reset-storage-btn" onclick="resetStorageLocation()" style="display: none; margin-left: 0;">Reset</button>
                        </div>
                        <small id="storage-path-display" style="color: var(--text-muted); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: block; width: 100%; margin-top: 2px;">Default location</small>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Desktop notifications</span>
                            <small>Notify when meetings finish processing</small>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="notifications-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Check for updates</span>
                            <small>Updates and announcements</small>
                        </div>
                        <button class="settings-action-btn" id="test-update-btn" onclick="testUpdateCheck()">Check</button>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Setup wizard</span>
                            <small>Reinstall dependencies or fix configuration</small>
                        </div>
                        <button class="settings-action-btn" id="run-setup-btn" onclick="runSetupFromSettings()">Run</button>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Clear recording state</span>
                            <small>Fix stuck recordings or processing</small>
                        </div>
                        <button class="settings-action-btn" id="clear-state-btn" onclick="clearSystemState()">Clear</button>
                    </div>

                    <div class="settings-row">
                        <div class="settings-row-text">
                            <span>Developer mode</span>
                            <small>Show debug logs and developer tools</small>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="developer-mode-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="settings-row" style="flex-wrap: wrap;">
                        <div class="settings-row-text" style="flex: 1; min-width: 0;">
                            <span>Anonymous usage analytics</span>
                            <small>Help improve StenoAI -- no meeting content is ever sent</small>
                        </div>
                        <label class="settings-toggle">
                            <input type="checkbox" id="telemetry-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                        <small id="anonymous-id-display" style="color: var(--text-muted); font-size: 11px; width: 100%; margin-top: 4px; cursor: pointer; opacity: 0.6;" title="Click to copy" onclick="navigator.clipboard.writeText(this.textContent.replace('ID: ','')).then(()=>{this.textContent='Copied!';setTimeout(()=>loadTelemetryId(),1500)})"></small>
                    </div>

                    <div class="settings-version">
                        StenoAI <span id="app-version">Loading...</span>
                        <span style="margin: 0 6px; opacity: 0.3;"></span>
                        <a href="#" onclick="require('electron').shell.openExternal('https://discord.com/invite/DZ6vcQnxxu'); return false;" style="color: var(--text-muted); text-decoration: none; transition: color 0.2s;" onmouseover="this.style.color='var(--accent-primary)'" onmouseout="this.style.color='var(--text-muted)'">Report a bug</a>
                    </div>
                </div>

                <!-- AI Tab -->
                <div class="settings-tab" id="tab-ai">
                    <div class="settings-section">
                        <h3>Model</h3>
                        <div id="model-list" class="model-list">
                            <div class="model-list-loading">Loading models...</div>
                        </div>
                    </div>

                </div>

                <!-- Developer Tab -->
                <div class="settings-tab" id="tab-developer">
                    <div class="dev-tab-header">
                        <button class="dev-back-btn" id="dev-back-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Back
                        </button>
                        <h3 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0;">Debug Console</h3>
                    </div>
                    <div class="settings-section" style="margin-bottom: 0;">
                        <p>Real-time log output from the backend processes.</p>
                        <div class="debug-console show" id="debug-console-panel">StenoAI Debug Console
Session started - waiting for activity...

</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        // UI Elements
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const sessionNameInput = document.getElementById('session-name');

        // Sidebar toggle functionality
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');

        // Restore sidebar state from localStorage
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar.classList.add('collapsed');
            sidebarToggle.classList.add('collapsed');
        }

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            sidebarToggle.classList.toggle('collapsed');
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });

        // Brand click - return to home state
        document.querySelector('.brand').addEventListener('click', () => {
            selectedMeeting = null;
            selectedCalendarEvent = null;
            document.getElementById('empty-state').style.display = 'flex';
            document.getElementById('meeting-detail').classList.remove('show');
            document.getElementById('calendar-event-detail').classList.remove('show');
            document.querySelectorAll('.meeting-item').forEach(item => item.classList.remove('active'));
            renderCalendarSidebar();
        });

        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const meetingsList = document.getElementById('meetings-list');
        const emptyState = document.getElementById('empty-state');
        const meetingDetail = document.getElementById('meeting-detail');
        const dropZone = document.getElementById('drop-zone');
        
        // Announcement elements
        const announcementBanner = document.getElementById('announcement-banner');
        const announcementIcon = document.getElementById('announcement-icon');
        const announcementTitle = document.getElementById('announcement-title');
        const announcementMessage = document.getElementById('announcement-message');
        const announcementActionBtn = document.getElementById('announcement-action-btn');
        const dismissAnnouncementBtn = document.getElementById('dismiss-announcement-btn');
        
        // Detail elements
        const detailTitle = document.getElementById('detail-title');
        const detailDate = document.getElementById('detail-date');
        const detailDuration = document.getElementById('detail-duration');
        const detailSummary = document.getElementById('detail-summary');
        const detailParticipants = document.getElementById('detail-participants');
        const detailKeyPoints = document.getElementById('detail-key-points');
        const detailActionItems = document.getElementById('detail-action-items');
        const detailTranscript = document.getElementById('detail-transcript');
        const reprocessBtn = document.getElementById('reprocess-btn');
        const copyTranscriptBtn = document.getElementById('copy-transcript-btn');
        const copyNotesBtn = document.getElementById('copy-notes-btn');
        const editTitleBtn = document.getElementById('edit-title-btn');

        // AI Query elements
        const askAiBtn = document.getElementById('ask-ai-btn');
        const aiQueryPopup = document.getElementById('ai-query-popup');
        const aiQueryClose = document.getElementById('ai-query-close');
        const aiQueryInput = document.getElementById('ai-query-input');
        const aiQuerySubmit = document.getElementById('ai-query-submit');
        const aiQueryResponse = document.getElementById('ai-query-response');
        const aiQueryResponseContent = document.getElementById('ai-query-response-content');

        // Setup elements
        const setupOverlay = document.getElementById('setup-overlay');
        const setupAutoStart = document.getElementById('setup-auto-start');
        const setupContinue = document.getElementById('setup-continue');
        
        let uiState = 'ready'; // ready, recording, processing, setup-needed
        let meetings = [];
        let filteredMeetings = [];
        let selectedMeeting = null;
        let recordingProcess = null;
        let statusCheckInterval = null;
        let processingMeeting = null; // Track which meeting is currently being reprocessed
        let searchQuery = '';
        let recordingStartTime = null;
        let recordingTimer = null;
        let pausedElapsedTime = 0; // Track elapsed time when paused
        let processingMeetings = new Set();
        let meetingsLastLoaded = 0; // Cache timestamp
        
        // Announcement system variables
        let currentAnnouncement = null;
        let announcementCheckInterval = null;

        // Google Calendar state
        let calendarConnected = false;
        let calendarEvents = [];
        let selectedCalendarEvent = null;
        let calendarRefreshInterval = null;
        let calendarNotificationTimers = [];
        let notifiedEventIds = new Set();
        
        // Utility functions
        function log(message) {
            console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
        }
        
        function generateMeetingHash() {
            // Generate short hash for meeting names
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function setStatus(status, message) {
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = message;
            // Toggle waveform visibility for recording state
            const statusContainer = document.getElementById('status-container');
            if (status === 'recording') {
                statusContainer.classList.add('recording');
            } else {
                statusContainer.classList.remove('recording');
            }
            log(`Status: ${message}`);
        }
        
        function startRecordingTimer(resume = false) {
            // If resuming, adjust start time to account for already elapsed time
            if (resume && pausedElapsedTime > 0) {
                recordingStartTime = Date.now() - (pausedElapsedTime * 1000);
            } else {
                recordingStartTime = Date.now();
                pausedElapsedTime = 0;
            }
            recordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                setStatus('recording', `Recording... ${timeStr}`);
            }, 1000);
        }

        function pauseRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            // Save elapsed time before pausing
            if (recordingStartTime) {
                pausedElapsedTime = Math.floor((Date.now() - recordingStartTime) / 1000);
            }
        }

        function stopRecordingTimer() {
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            recordingStartTime = null;
            pausedElapsedTime = 0;
        }
        
        function setUIState(state) {
            uiState = state;
            log(`UI State: ${state}`);

            // Update UI elements based on state
            switch(state) {
                case 'ready':
                    startBtn.style.display = 'inline-flex';
                    stopBtn.style.display = 'none';
                    pauseBtn.style.display = 'none';
                    startBtn.disabled = false;
                    sessionNameInput.disabled = false;
                    stopRecordingTimer();
                    setStatus('ready', 'Ready');
                    break;

                case 'recording':
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-flex';
                    pauseBtn.style.display = 'inline-flex';
                    pauseBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><rect x="1.5" y="1" width="3" height="10" rx="1"/><rect x="7.5" y="1" width="3" height="10" rx="1"/></svg> Pause';
                    startBtn.disabled = true;
                    sessionNameInput.disabled = true;
                    stopBtn.disabled = false;
                    pauseBtn.disabled = false;
                    // Check if resuming from paused state (pausedElapsedTime > 0)
                    startRecordingTimer(pausedElapsedTime > 0);
                    break;

                case 'paused':
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-flex';
                    pauseBtn.style.display = 'inline-flex';
                    pauseBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><polygon points="2,1 11,6 2,11"/></svg> Resume';
                    startBtn.disabled = true;
                    sessionNameInput.disabled = true;
                    stopBtn.disabled = false;
                    pauseBtn.disabled = false;
                    pauseRecordingTimer();
                    // Show paused status with the frozen time
                    const minutes = Math.floor(pausedElapsedTime / 60);
                    const seconds = pausedElapsedTime % 60;
                    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    setStatus('recording', `Paused ${timeStr}`);
                    break;

                case 'processing':
                    startBtn.style.display = 'inline-flex';
                    stopBtn.style.display = 'none';
                    pauseBtn.style.display = 'none';
                    startBtn.disabled = true;
                    sessionNameInput.disabled = true;
                    stopRecordingTimer();
                    setStatus('processing', 'Processing...');
                    break;
            }
        }
        
        function startStatusMonitoring() {
            // Only check status when we think we're recording
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            
            statusCheckInterval = setInterval(async () => {
                if (uiState === 'recording') {
                    try {
                        // Check if microphone permission was revoked during recording
                        const micResult = await ipcRenderer.invoke('check-microphone-permission');
                        if (!micResult.success || micResult.status !== 'granted') {
                            log(' Microphone permission revoked during recording - stopping');
                            alert(' Microphone access was revoked! Recording stopped.\n\nPlease grant microphone permission to continue recording.');
                            setUIState('ready');
                            stopStatusMonitoring();
                            showSetupOverlay([]);
                            return;
                        }
                        
                        const result = await ipcRenderer.invoke('get-status');
                        if (result.success && !result.status.includes('RECORDING')) {
                            // Backend says not recording but UI thinks it is - sync up
                            log('Backend/UI state mismatch - syncing');
                            setUIState('ready');
                            stopStatusMonitoring();
                        }
                    } catch (error) {
                        log(`Status check failed: ${error.message}`);
                    }
                }
            }, 10000); // Check every 10 seconds only when recording
        }
        
        function stopStatusMonitoring() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
        }
        
        
        function formatDate(dateString) {
            if (!dateString) return 'Unknown date';
            try {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return 'Unknown date';
            }
        }
        
        function formatDuration(startTime, endTime) {
            if (!startTime || !endTime) return 'Unknown';
            try {
                const start = new Date(startTime);
                const end = new Date(endTime);
                const minutes = Math.round((end - start) / 60000);
                return `${minutes} min`;
            } catch {
                return 'Unknown';
            }
        }
        
        // Delete meeting function
        async function deleteMeeting(index, event) {
            if (event) event.stopPropagation(); // Prevent selecting the meeting
            
            const meeting = filteredMeetings[index];
            if (!meeting) return;
            
            const confirmed = confirm(`Delete meeting "${meeting.session_info?.name || 'Untitled Meeting'}"?\n\nThis will delete the transcript, summary, and all associated files.`);
            if (!confirmed) return;
            
            try {
                // Pass the entire meeting object to the backend
                const result = await ipcRenderer.invoke('delete-meeting', meeting);
                
                if (result.success) {
                    log(`Meeting deleted: ${result.message}`);
                    
                    // Remove meeting from local arrays
                    meetings = meetings.filter(m => m !== meeting);
                    filteredMeetings = filteredMeetings.filter(m => m !== meeting);
                    
                    // Re-render the meetings list
                    filterMeetings();
                    
                    // Clear selected meeting if it was deleted
                    if (selectedMeeting === meeting) {
                        selectedMeeting = null;
                        emptyState.style.display = 'flex';
                        meetingDetail.classList.remove('show');
                    }
                } else {
                    log(`Failed to delete meeting: ${result.error}`);
                    alert(`Failed to delete meeting: ${result.error}`);
                }
            } catch (error) {
                log(`Error deleting meeting: ${error.message}`);
                alert(`Error deleting meeting: ${error.message}`);
            }
        }
        
        // Filter meetings based on search query
        function filterMeetings() {
            const hasSearch = searchQuery.trim().length > 0;
            let source = [...meetings];
            // When searching, search across ALL meetings regardless of folder
            if (!hasSearch) {
                if (activeFolderId) {
                    source = source.filter(m => (m.folders || []).includes(activeFolderId));
                } else {
                    source = source.filter(m => (m.folders || []).length === 0);
                }
                filteredMeetings = source;
            } else {
                const query = searchQuery.toLowerCase();
                filteredMeetings = source.filter(meeting => {
                    const name = (meeting.session_info?.name || '').toLowerCase();
                    const summary = (meeting.summary || '').toLowerCase();
                    const keyPoints = (meeting.key_points || []).join(' ').toLowerCase();
                    const actionItems = (meeting.action_items || []).join(' ').toLowerCase();

                    return name.includes(query) ||
                           summary.includes(query) ||
                           keyPoints.includes(query) ||
                           actionItems.includes(query);
                });
            }
            renderFolderList();
            renderMeetingsList();
        }
        
        // Load meetings from backend with caching
        async function loadMeetings(forceRefresh = false) {
            const now = Date.now();
            
            // Use cache if data is less than 30 seconds old and not forced refresh
            if (!forceRefresh && meetings.length > 0 && (now - meetingsLastLoaded) < 30000) {
                log('Using cached meetings data');
                filterMeetings();
                return;
            }
            
            // Show loading state only if we don't have cached data
            if (meetings.length === 0) {
                meetingsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <div style="font-size: 24px; margin-bottom: 8px;"></div>
                        <p>Loading meetings...</p>
                    </div>
                `;
            }
            
            try {
                const result = await ipcRenderer.invoke('list-meetings');
                if (result.success) {
                    meetings = result.meetings || [];
                    meetingsLastLoaded = now;
                    await loadFolders();
                    filterMeetings(); // Apply current search filter and folder
                    log(`Loaded ${meetings.length} meetings`);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                log(`Failed to load meetings: ${error.message}`);
                // Only show error if we don't have cached data
                if (meetings.length === 0) {
                    meetingsList.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                            <div style="font-size: 24px; margin-bottom: 8px;"></div>
                            <p>Failed to load meetings</p>
                            <p style="font-size: 12px; margin-top: 4px;">Using cached data if available</p>
                        </div>
                    `;
                } else {
                    // We have cached data, just log the error
                    log('Using cached meetings data due to load failure');
                    filterMeetings();
                }
            }
        }
        
        // Render meetings list
        // --- Folder state ---
        let folders = [];
        let activeFolderId = null; // null = "All Meetings"
        let contextMeetingIndex = null;

        function formatShortDate(dateString) {
            if (!dateString) return '';
            try {
                const d = new Date(dateString);
                const now = new Date();
                if (now.getFullYear() === d.getFullYear()) return d.toLocaleDateString('en-US', { day: 'numeric', month: 'short' });
                return d.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: '2-digit' });
            } catch { return ''; }
        }

        async function loadFolders() {
            try {
                const result = await ipcRenderer.invoke('list-folders');
                if (result.success) {
                    folders = result.folders || [];
                    renderFolderList();
                }
            } catch (e) { console.error('Failed to load folders:', e); }
        }

        function renderFolderList() {
            const container = document.getElementById('folder-list');
            const allCount = meetings.filter(m => (m.folders || []).length === 0).length;
            let html = `<div class="folder-item ${activeFolderId === null ? 'active' : ''}" onclick="setActiveFolder(null)"
                ondragover="event.preventDefault(); this.classList.add('drag-over')"
                ondragleave="this.classList.remove('drag-over')"
                ondrop="handleAllMeetingsDrop(event)">
                ${folderIcon('#71717a')}
                All Meetings
                <span class="folder-count">${allCount}</span>
            </div>`;
            for (const f of folders) {
                const count = meetings.filter(m => (m.folders || []).includes(f.id)).length;
                html += `<div class="folder-item ${activeFolderId === f.id ? 'active' : ''}" onclick="setActiveFolder('${f.id}')" oncontextmenu="confirmDeleteFolder(event, '${f.id}')" ondblclick="event.stopPropagation(); renameFolderInline(event, '${f.id}')"
                    data-folder-id="${f.id}"
                    draggable="true"
                    ondragstart="handleFolderDragStart(event, '${f.id}')"
                    ondragend="handleFolderDragEnd(event)"
                    ondragover="handleFolderDragOver(event, '${f.id}')"
                    ondragleave="handleFolderDragLeave(event)"
                    ondrop="handleFolderOrMeetingDrop(event, '${f.id}')">
                    ${folderIcon(f.color)}
                    ${escapeHtml(f.name)}
                    <span class="folder-count">${count}</span>
                </div>`;
            }
            // Inline "New folder" as last item
            html += `<div class="folder-item" onclick="createNewFolder()" style="color: var(--text-muted); font-size: 12px; gap: 6px; padding: 4px 10px;">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.6;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                New folder
            </div>`;
            container.innerHTML = html;
        }

        function folderIcon(color, size = 14) {
            return `<span class="folder-icon"><svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="${color}" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" opacity="0.25"></path><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" fill="none" stroke="${color}" stroke-width="1.5"></path></svg></span>`;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function setActiveFolder(folderId) {
            activeFolderId = folderId;
            renderFolderList();
            filterMeetings();
        }

        async function createNewFolder() {
            // Show inline input in folder list
            const container = document.getElementById('folder-list');
            const inputHtml = `<div class="folder-item" id="new-folder-input-row" style="gap: 6px;">
                ${folderIcon('#6366f1')}
                <input type="text" id="new-folder-input" placeholder="Folder name" style="
                    flex: 1; background: var(--bg-deep); border: 1px solid var(--accent-primary);
                    border-radius: 4px; padding: 3px 6px; font-size: 12px; color: var(--text-primary);
                    outline: none; font-family: inherit; min-width: 0;
                " autofocus>
            </div>`;
            container.insertAdjacentHTML('beforeend', inputHtml);
            const input = document.getElementById('new-folder-input');
            input.focus();

            async function commitFolder() {
                const name = input.value.trim();
                const row = document.getElementById('new-folder-input-row');
                if (row) row.remove();
                if (!name) return;
                const colors = ['#6366f1', '#0ea5e9', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
                const color = colors[folders.length % colors.length];
                const result = await ipcRenderer.invoke('create-folder', name, color);
                if (result.success) {
                    await loadFolders();
                }
            }

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') commitFolder();
                if (e.key === 'Escape') {
                    const row = document.getElementById('new-folder-input-row');
                    if (row) row.remove();
                }
            });
            input.addEventListener('blur', commitFolder);
        }

        async function renameFolderInline(event, folderId) {
            event.preventDefault();
            event.stopPropagation();
            const folder = folders.find(f => f.id === folderId);
            if (!folder) return;

            const item = document.querySelector(`.folder-item[data-folder-id="${folderId}"]`);
            if (!item) return;

            item.innerHTML = `
                ${folderIcon(folder.color)}
                <input type="text" id="rename-folder-input" value="${escapeHtml(folder.name)}" style="
                    flex: 1; background: var(--bg-deep); border: 1px solid var(--accent-primary);
                    border-radius: 4px; padding: 3px 6px; font-size: 12px; color: var(--text-primary);
                    outline: none; font-family: inherit; min-width: 0;
                ">
            `;
            const input = document.getElementById('rename-folder-input');
            input.focus();
            input.select();

            async function commitRename() {
                const newName = input.value.trim();
                if (newName && newName !== folder.name) {
                    await ipcRenderer.invoke('rename-folder', folderId, newName);
                }
                await loadFolders();
            }
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') commitRename();
                if (e.key === 'Escape') loadFolders();
            });
            input.addEventListener('blur', commitRename);
        }

        let contextFolderId = null;

        function confirmDeleteFolder(event, folderId) {
            event.preventDefault();
            event.stopPropagation();
            contextFolderId = folderId;
            const menu = document.getElementById('folder-context-menu');
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            menu.classList.add('show');
        }

        function hideFolderContextMenu() {
            document.getElementById('folder-context-menu').classList.remove('show');
        }

        async function deleteContextFolder() {
            if (contextFolderId === null) return;
            hideFolderContextMenu();
            const folder = folders.find(f => f.id === contextFolderId);
            const name = folder ? folder.name : 'this folder';
            const count = meetings.filter(m => (m.folders || []).includes(contextFolderId)).length;
            const msg = count > 0
                ? `Delete folder "${name}"?\n\n${count} meeting${count === 1 ? '' : 's'} will be moved back to All Meetings. No recordings or transcripts will be deleted.`
                : `Delete folder "${name}"?\n\nNo recordings or transcripts will be deleted.`;
            if (!confirm(msg)) { contextFolderId = null; return; }
            await deleteFolder_(contextFolderId);
            contextFolderId = null;
        }

        async function deleteFolder_(folderId) {
            // Remove folder references from all meetings that were in this folder
            const affectedMeetings = meetings.filter(m => (m.folders || []).includes(folderId));
            for (const m of affectedMeetings) {
                const summaryFile = m.session_info?.summary_file;
                if (summaryFile) {
                    await ipcRenderer.invoke('remove-meeting-from-folder', summaryFile, folderId).catch(() => {});
                }
            }
            await ipcRenderer.invoke('delete-folder', folderId);
            if (activeFolderId === folderId) activeFolderId = null;
            await loadMeetings(true); // Reload to get updated folder references
            filterMeetings();
        }

        // Context menu for meetings
        function showMeetingContextMenu(event, index) {
            event.preventDefault();
            event.stopPropagation();
            restoreContextMenu();
            contextMeetingIndex = index;
            const menu = document.getElementById('meeting-context-menu');
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            menu.classList.add('show');
        }

        function hideMeetingContextMenu() {
            document.getElementById('meeting-context-menu').classList.remove('show');
        }

        let calendarDetailJustOpened = false;
        document.addEventListener('click', (e) => {
            hideMeetingContextMenu();
            hideFolderContextMenu();
            // Restore original menu items when clicking away
            if (typeof restoreContextMenu === 'function') restoreContextMenu();
            // Close calendar event detail when clicking outside it
            if (selectedCalendarEvent !== null) {
                if (calendarDetailJustOpened) { calendarDetailJustOpened = false; return; }
                const detail = document.getElementById('calendar-event-detail');
                if (!detail.contains(e.target)) {
                    hideCalendarEventDetail();
                }
            }
        });

        async function showFolderPicker(event) {
            if (event) { event.stopPropagation(); }
            if (contextMeetingIndex === null) return;
            const meeting = filteredMeetings[contextMeetingIndex];
            if (!meeting) return;
            // Replace context menu content with folder list + "All Meetings"
            const menu = document.getElementById('meeting-context-menu');
            const meetingFolders = meeting.folders || [];
            const isUnfiled = meetingFolders.length === 0;
            let html = '<div style="padding: 4px 10px; font-size: 11px; color: var(--text-muted); font-weight: 500;">Move to...</div>';
            html += `<div class="context-menu-item" onclick="event.stopPropagation(); moveToAllMeetings()">
                ${folderIcon('#71717a')}
                All Meetings ${isUnfiled ? '<span style="color: var(--text-muted); font-size: 11px;">(current)</span>' : ''}
            </div>`;
            for (const f of folders) {
                const inFolder = meetingFolders.includes(f.id);
                html += `<div class="context-menu-item" onclick="event.stopPropagation(); assignToFolder('${f.id}')">
                    ${folderIcon(f.color)}
                    ${escapeHtml(f.name)} ${inFolder ? '<span style="color: var(--text-muted); font-size: 11px;">(current)</span>' : ''}
                </div>`;
            }
            menu.innerHTML = html;
        }

        async function moveToAllMeetings() {
            hideMeetingContextMenu();
            if (contextMeetingIndex === null) return;
            const meeting = filteredMeetings[contextMeetingIndex];
            const summaryFile = meeting?.session_info?.summary_file;
            if (!summaryFile) { restoreContextMenu(); return; }
            const oldFolders = [...(meeting.folders || [])];
            meeting.folders = [];
            filterMeetings();
            restoreContextMenu();
            for (const fid of oldFolders) {
                ipcRenderer.invoke('remove-meeting-from-folder', summaryFile, fid);
            }
        }

        async function assignToFolder(folderId) {
            hideMeetingContextMenu();
            if (contextMeetingIndex === null) return;
            const meeting = filteredMeetings[contextMeetingIndex];
            const summaryFile = meeting?.session_info?.summary_file;
            if (!summaryFile) { restoreContextMenu(); return; }
            // Optimistic: move to new folder (replace, not append)
            const oldFolders = [...(meeting.folders || [])];
            meeting.folders = [folderId];
            filterMeetings();
            restoreContextMenu();
            // Persist: remove old folders, add new one
            for (const fid of oldFolders) {
                if (fid !== folderId) ipcRenderer.invoke('remove-meeting-from-folder', summaryFile, fid);
            }
            ipcRenderer.invoke('add-meeting-to-folder', summaryFile, folderId);
        }

        function restoreContextMenu() {
            document.getElementById('meeting-context-menu').innerHTML = `
                <div class="context-menu-item" onclick="event.stopPropagation(); showFolderPicker(event)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                    Move to...
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item danger" onclick="event.stopPropagation(); deleteContextMeeting()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Delete
                </div>
            `;
        }

        async function deleteContextMeeting() {
            hideMeetingContextMenu();
            if (contextMeetingIndex === null) return;
            deleteMeeting(contextMeetingIndex, null);
        }

        let draggedMeetingIndex = null;
        let draggedFolderId = null;

        function handleMeetingDragStart(event, index) {
            draggedMeetingIndex = index;
            draggedFolderId = null;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/meeting', index.toString());
            event.target.style.opacity = '0.5';
            setTimeout(() => { event.target.style.opacity = ''; }, 0);
        }

        function handleFolderDragStart(event, folderId) {
            draggedFolderId = folderId;
            draggedMeetingIndex = null;
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/folder', folderId);
            event.currentTarget.classList.add('dragging');
        }

        function handleFolderDragEnd(event) {
            event.currentTarget.classList.remove('dragging');
            draggedFolderId = null;
            // Clear all drop indicators
            document.querySelectorAll('.folder-item').forEach(el => {
                el.classList.remove('drop-above', 'drop-below', 'drag-over');
            });
        }

        function handleFolderDragOver(event, targetFolderId) {
            event.preventDefault();
            if (draggedFolderId && draggedFolderId !== targetFolderId) {
                // Folder reorder: show above/below indicator
                const rect = event.currentTarget.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                event.currentTarget.classList.remove('drop-above', 'drop-below', 'drag-over');
                if (event.clientY < midY) {
                    event.currentTarget.classList.add('drop-above');
                } else {
                    event.currentTarget.classList.add('drop-below');
                }
            } else if (draggedMeetingIndex !== null) {
                // Meeting drag onto folder
                event.currentTarget.classList.add('drag-over');
            }
        }

        function handleFolderDragLeave(event) {
            event.currentTarget.classList.remove('drag-over', 'drop-above', 'drop-below');
        }

        async function handleFolderOrMeetingDrop(event, targetFolderId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over', 'drop-above', 'drop-below');

            if (draggedFolderId && draggedFolderId !== targetFolderId) {
                // Folder reorder
                const rect = event.currentTarget.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                const dropAbove = event.clientY < midY;

                const dragIdx = folders.findIndex(f => f.id === draggedFolderId);
                if (dragIdx === -1) { draggedFolderId = null; return; }

                // Remove dragged folder from array
                const [dragged] = folders.splice(dragIdx, 1);

                // Find target index after removal
                let targetIdx = folders.findIndex(f => f.id === targetFolderId);
                if (targetIdx === -1) { folders.splice(dragIdx, 0, dragged); draggedFolderId = null; return; }

                // Insert above or below target
                if (!dropAbove) targetIdx++;
                folders.splice(targetIdx, 0, dragged);

                draggedFolderId = null;
                renderFolderList();

                // Persist new order
                const folderIds = folders.map(f => f.id);
                ipcRenderer.invoke('reorder-folders', folderIds);
                return;
            }

            // Fall through to meeting-to-folder drop
            handleFolderDrop(event, targetFolderId);
        }

        async function handleFolderDrop(event, folderId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            if (draggedMeetingIndex === null) return;
            const meeting = filteredMeetings[draggedMeetingIndex];
            const summaryFile = meeting?.session_info?.summary_file;
            if (!summaryFile) { draggedMeetingIndex = null; return; }
            // Optimistic: move to folder (replace, not append)
            const oldFolders = [...(meeting.folders || [])];
            meeting.folders = [folderId];
            filterMeetings();
            draggedMeetingIndex = null;
            // Persist: remove old folders, add new one
            for (const fid of oldFolders) {
                if (fid !== folderId) ipcRenderer.invoke('remove-meeting-from-folder', summaryFile, fid);
            }
            ipcRenderer.invoke('add-meeting-to-folder', summaryFile, folderId);
        }

        async function handleAllMeetingsDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            if (draggedMeetingIndex === null) return;
            const meeting = filteredMeetings[draggedMeetingIndex];
            const summaryFile = meeting?.session_info?.summary_file;
            if (!summaryFile) { draggedMeetingIndex = null; return; }
            // Remove from all folders optimistically
            const oldFolders = [...(meeting.folders || [])];
            meeting.folders = [];
            filterMeetings();
            draggedMeetingIndex = null;
            // Persist each removal in background
            for (const fid of oldFolders) {
                ipcRenderer.invoke('remove-meeting-from-folder', summaryFile, fid);
            }
        }

        function renameMeeting(index, titleEl) {
            const meeting = filteredMeetings[index];
            if (!meeting) return;
            const oldName = meeting.session_info?.name || 'Untitled Meeting';
            const summaryFile = meeting.session_info?.summary_file;
            if (!summaryFile) return;

            const input = document.createElement('input');
            input.type = 'text';
            input.value = oldName;
            input.className = 'meeting-line-title';
            input.style.cssText = 'background: var(--bg-deep); border: 1px solid var(--accent-primary); border-radius: 4px; padding: 1px 4px; outline: none; font-family: inherit; min-width: 0; width: 100%;';
            titleEl.replaceWith(input);
            input.focus();
            input.select();

            let committed = false;
            async function commit() {
                if (committed) return;
                committed = true;
                const newName = input.value.trim();
                if (newName && newName !== oldName) {
                    // Optimistic update
                    meeting.session_info.name = newName;
                    if (selectedMeeting === meeting) {
                        document.getElementById('detail-title').textContent = newName;
                    }
                    renderMeetingsList();
                    ipcRenderer.invoke('update-meeting', summaryFile, { name: newName });
                } else {
                    renderMeetingsList();
                }
            }

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); commit(); }
                if (e.key === 'Escape') { committed = true; renderMeetingsList(); }
            });
            input.addEventListener('blur', commit);
        }

        function renderMeetingsList() {
            if (filteredMeetings.length === 0 && searchQuery.trim()) {
                meetingsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <p style="font-size: 13px;">No meetings match "${searchQuery}"</p>
                    </div>
                `;
                return;
            }

            if (meetings.length === 0) {
                meetingsList.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        <p style="font-size: 13px;">No meetings yet</p>
                        <p style="font-size: 12px; margin-top: 4px;">Start recording to see your meetings here</p>
                    </div>
                `;
                return;
            }

            meetingsList.innerHTML = filteredMeetings.map((meeting, index) => {
                const isProcessing = processingMeetings.has(meeting.session_info?.name);
                const actionCount = (meeting.action_items || []).length;
                const title = meeting.session_info?.name || 'Untitled Meeting';
                const date = formatShortDate(meeting.session_info?.processed_at);
                return `
                <div class="meeting-item ${isProcessing ? 'processing' : ''}" data-index="${index}" draggable="true" oncontextmenu="showMeetingContextMenu(event, ${index})" ondragstart="handleMeetingDragStart(event, ${index})">
                    <span class="meeting-dot"></span>
                    <div class="meeting-line-body">
                        <span class="meeting-line-title" ondblclick="event.stopPropagation(); renameMeeting(${index}, this)">${escapeHtml(title)}</span>
                        ${isProcessing ? '<span class="meeting-item-spinner"></span>' : ''}
                        <span class="meeting-line-meta">
                            ${actionCount > 0 ? `<span class="meeting-line-badge">${actionCount}</span>` : ''}
                            <span class="meeting-line-date">${date}</span>
                        </span>
                    </div>
                    <button class="meeting-delete" onclick="deleteMeeting(${index}, event)" title="Delete meeting"></button>
                </div>
                `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.meeting-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    selectMeeting(index);
                });
            });
        }
        
        // Select and display meeting details
        function selectMeeting(index) {
            selectedMeeting = filteredMeetings[index];
            if (!selectedMeeting) return;

            // Deselect calendar event
            selectedCalendarEvent = null;
            document.getElementById('calendar-event-detail').classList.remove('show');
            renderCalendarSidebar();

            // Update active state
            document.querySelectorAll('.meeting-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });

            // Show meeting details
            emptyState.style.display = 'none';
            meetingDetail.classList.add('show');
            
            // Populate details
            detailTitle.textContent = selectedMeeting.session_info?.name || 'Untitled Meeting';
            detailDate.textContent = formatDate(selectedMeeting.session_info?.processed_at);
            const durationText = selectedMeeting.session_info?.duration_seconds ? 
                (() => {
                    const totalSecs = selectedMeeting.session_info.duration_seconds;
                    const hours = Math.floor(totalSecs / 3600);
                    const mins = Math.floor((totalSecs % 3600) / 60);
                    const secs = totalSecs % 60;
                    
                    if (hours > 0) return `Meeting Duration: ${hours}h ${mins}m`;
                    if (mins > 0) return `Meeting Duration: ${mins}m ${secs}s`;
                    return `Meeting Duration: ${secs}s`;
                })() :
                (selectedMeeting.session_info?.duration_minutes ?
                    `Meeting Duration: ${selectedMeeting.session_info.duration_minutes} minutes` : 'Processed');
            detailDuration.textContent = durationText;
            
            detailSummary.textContent = selectedMeeting.summary || 'No summary available';
            
            // Participants
            if (selectedMeeting.participants && selectedMeeting.participants.length > 0) {
                detailParticipants.textContent = selectedMeeting.participants.join(', ');
            } else {
                detailParticipants.innerHTML = '<span style="color: var(--text-muted);">No participants identified</span>';
            }

            // Key topics
            const detailDiscussionAreas = document.getElementById('detail-discussion-areas');
            const discussionAreasSection = document.getElementById('discussion-areas-section');
            detailDiscussionAreas.innerHTML = '';
            if (selectedMeeting.discussion_areas && selectedMeeting.discussion_areas.length > 0) {
                discussionAreasSection.style.display = 'block';
                selectedMeeting.discussion_areas.forEach(area => {
                    const areaDiv = document.createElement('div');
                    areaDiv.style.marginBottom = '15px';
                    areaDiv.style.padding = '12px';
                    areaDiv.style.background = 'var(--bg-elevated)';
                    areaDiv.style.borderRadius = '6px';
                    areaDiv.style.borderLeft = '3px solid var(--accent-primary)';

                    const title = document.createElement('h4');
                    title.textContent = area.title || 'Discussion Topic';
                    title.style.margin = '0 0 8px 0';
                    title.style.color = 'var(--accent-primary)';
                    title.style.fontSize = '14px';
                    title.style.fontWeight = '600';

                    const analysis = document.createElement('p');
                    analysis.textContent = area.analysis || '';
                    analysis.style.margin = '0';
                    analysis.style.color = 'var(--text-secondary)';
                    analysis.style.lineHeight = '1.5';

                    areaDiv.appendChild(title);
                    areaDiv.appendChild(analysis);
                    detailDiscussionAreas.appendChild(areaDiv);
                });
            } else {
                discussionAreasSection.style.display = 'none';
            }

            // Key points
            detailKeyPoints.innerHTML = '';
            if (selectedMeeting.key_points && selectedMeeting.key_points.length > 0) {
                selectedMeeting.key_points.forEach(point => {
                    const li = document.createElement('li');
                    li.textContent = point;
                    detailKeyPoints.appendChild(li);
                });
            } else {
                detailKeyPoints.innerHTML = '<li style="color: var(--text-muted);">No key points identified</li>';
            }
            
            // Action items
            detailActionItems.innerHTML = '';
            if (selectedMeeting.action_items && selectedMeeting.action_items.length > 0) {
                selectedMeeting.action_items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    detailActionItems.appendChild(li);
                });
            } else {
                detailActionItems.innerHTML = '<li style="color: var(--text-muted);">No action items identified</li>';
            }
            
            // Transcript
            detailTranscript.textContent = selectedMeeting.transcript || 'No transcript available';
            
            // Set reprocess button state based on whether this meeting is currently processing
            const isCurrentlyProcessing = processingMeeting && processingMeeting.session_info?.summary_file === selectedMeeting.session_info?.summary_file;
            
            if (isCurrentlyProcessing) {
                // Restore processing state
                reprocessBtn.disabled = true;
                reprocessBtn.classList.add('processing');
                reprocessBtn.innerHTML = '<div class="reprocess-spinner"></div>Processing...';
            } else {
                // Normal state
                reprocessBtn.disabled = false;
                reprocessBtn.classList.remove('processing');
                reprocessBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>';
            }
            
            // TEMPORARY: Show reprocess button for all meetings (for testing)
            reprocessBtn.style.display = 'flex';
            
            /* ORIGINAL LOGIC (commented out for testing):
            // Show/hide reprocess button based on meeting quality
            const hasFailedSummary = (
                !selectedMeeting.summary || 
                selectedMeeting.summary.includes('No transcript was generated') ||
                selectedMeeting.summary.includes('detailed analysis failed') ||
                selectedMeeting.summary.includes('not fully supported') ||
                (selectedMeeting.overview && (
                    selectedMeeting.overview.includes('No transcript was generated') ||
                    selectedMeeting.overview.includes('detailed analysis failed') ||
                    selectedMeeting.overview.includes('not fully supported')
                ))
            );
            
            const hasNoParticipants = !selectedMeeting.participants || selectedMeeting.participants.length === 0;
            const hasNoKeyPoints = !selectedMeeting.key_points || selectedMeeting.key_points.length === 0;
            
            // Show reprocess button if meeting appears to have failed summarization
            if (hasFailedSummary || (hasNoParticipants && hasNoKeyPoints && selectedMeeting.transcript && selectedMeeting.transcript.length > 100)) {
                reprocessBtn.style.display = 'flex';
            } else {
                reprocessBtn.style.display = 'none';
            }
            */
        }
        
        
        // Manual start/stop recording functions
        startBtn.addEventListener('click', async () => {
            // Check microphone permission before allowing recording
            try {
                const micResult = await ipcRenderer.invoke('check-microphone-permission');
                if (!micResult.success || micResult.status !== 'granted') {
                    log(' Cannot start recording - microphone permission denied');
                    
                    // Show clear error message
                    const micStatus = micResult.status || 'unknown';
                    alert(` Recording blocked: Microphone permission is ${micStatus}.\n\nStenoAI requires microphone access to record meetings. Please grant permission and try again.`);
                    
                    // Force show setup wizard to fix the issue
                    showSetupOverlay([]);
                    return;
                }
            } catch (error) {
                log(` Failed to check microphone permission: ${error.message}`);
                alert(' Cannot verify microphone permission. Please ensure the app has proper access.');
                return;
            }
            
            // Generate session name if empty or use Meeting-HASH format
            let sessionName = sessionNameInput.value.trim();
            if (!sessionName || sessionName === 'Meeting') {
                sessionName = `Meeting-${generateMeetingHash()}`;
                sessionNameInput.value = sessionName;
            }
            
            log(` Starting recording: ${sessionName}`);
            setUIState('recording');
            
            try {
                const result = await ipcRenderer.invoke('start-recording-ui', sessionName);
                if (result.success) {
                    log(`Recording started: ${result.message}`);
                    startStatusMonitoring();
                } else {
                    log(`Failed to start: ${result.error}`);
                    setUIState('ready');
                }
            } catch (error) {
                log(` Start error: ${error.message}`);
                setUIState('ready');
            }
        });
        
        stopBtn.addEventListener('click', async () => {
            log(' Stopping recording...');
            setUIState('processing');
            stopStatusMonitoring();
            
            // Add current session to processing list immediately
            const currentSessionName = sessionNameInput.value.trim() || 'Meeting';
            processingMeetings.add(currentSessionName);
            
            // Add a temporary meeting entry to show processing
            const tempMeeting = {
                session_info: {
                    name: currentSessionName,
                    processed_at: new Date().toISOString(),
                    duration_seconds: null
                },
                summary: 'Pending...',
                key_points: [],
                action_items: [],
                transcript: ''
            };
            
            // Add to beginning of meetings array temporarily
            meetings.unshift(tempMeeting);
            filterMeetings(); // Update UI to show processing state
            
            try {
                const result = await ipcRenderer.invoke('stop-recording-ui');
                if (result.success) {
                    log(`Recording stopped: ${result.message}`);
                    log(' Processing audio - transcription and summarization running in background');
                    log(' Meeting list will refresh automatically when processing completes');
                    
                    // Return to ready state quickly so user can start another recording if needed
                    setTimeout(() => {
                        setUIState('ready');
                        sessionNameInput.value = '';
                    }, 5000); // 5 seconds
                    
                } else {
                    log(`Failed to stop: ${result.error}`);
                    setUIState('ready');
                    processingMeetings.delete(currentSessionName);
                    renderMeetingsList();
                }
            } catch (error) {
                log(` Stop error: ${error.message}`);
                setUIState('ready');
                processingMeetings.delete(currentSessionName);
                renderMeetingsList();
            }
        });

        pauseBtn.addEventListener('click', async () => {
            if (uiState === 'recording') {
                // Pause recording
                log(' Pausing recording...');
                try {
                    const result = await ipcRenderer.invoke('pause-recording-ui');
                    if (result.success) {
                        setUIState('paused');
                    } else {
                        log(`Failed to pause: ${result.error}`);
                    }
                } catch (error) {
                    log(` Pause error: ${error.message}`);
                }
            } else if (uiState === 'paused') {
                // Resume recording
                log(' Resuming recording...');
                try {
                    const result = await ipcRenderer.invoke('resume-recording-ui');
                    if (result.success) {
                        setUIState('recording');
                    } else {
                        log(`Failed to resume: ${result.error}`);
                    }
                } catch (error) {
                    log(` Resume error: ${error.message}`);
                }
            }
        });

        // Search functionality
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value;
            filterMeetings();
        });
        
        
        // File drop handling (ignore internal meeting/folder drags)
        document.addEventListener('dragover', (e) => {
            e.preventDefault();
            // Only show drop zone for external file drops, not internal drags
            if (draggedMeetingIndex !== null || draggedFolderId !== null) return;
            dropZone.classList.add('active');
        });

        document.addEventListener('dragleave', (e) => {
            if (!e.relatedTarget) {
                dropZone.classList.remove('active');
            }
        });

        document.addEventListener('drop', async (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            // Ignore internal meeting/folder drags
            if (draggedMeetingIndex !== null) { draggedMeetingIndex = null; return; }
            if (draggedFolderId !== null) { draggedFolderId = null; return; }
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('audio/') || file.name.match(/\.(wav|mp3|m4a|aac)$/i)) {
                    log(`Processing dropped file: ${file.name}`);
                    setStatus('processing', 'Processing file...');
                    
                    try {
                        const sessionName = file.name.replace(/\.[^/.]+$/, ''); // Remove extension
                        processingMeetings.add(sessionName);
                        renderMeetingsList(); // Update UI to show processing state
                        const result = await ipcRenderer.invoke('process-recording', file.path, sessionName);
                        
                        if (result.success) {
                            log('File processed successfully');
                            setStatus('ready', 'Complete');
                            processingMeetings.delete(sessionName);
                            
                            // Force refresh meetings list after processing
                            setTimeout(() => {
                                loadMeetings(true);
                            }, 1000);
                        } else {
                            log(`Processing failed: ${result.error}`);
                            setStatus('ready', 'Processing failed');
                            processingMeetings.delete(sessionName);
                            renderMeetingsList();
                        }
                    } catch (error) {
                        log(`Processing error: ${error.message}`);
                        setStatus('ready', 'Error');
                        processingMeetings.delete(sessionName);
                        renderMeetingsList();
                    }
                } else {
                    log('Invalid file type. Please drop an audio file.');
                }
            }
        });
        
        // Check initial recording status once
        async function checkInitialStatus() {
            try {
                const result = await ipcRenderer.invoke('get-status');
                if (result.success && result.status.includes('RECORDING')) {
                    log('Found active recording session - syncing UI state');
                    setUIState('recording');
                    startStatusMonitoring();
                } else {
                    setUIState('ready');
                }
            } catch (error) {
                log(`Failed to check initial status: ${error.message}`);
                setUIState('ready');
            }
        }

        //  Google Calendar Functions 

        async function checkGoogleCalendarStatus() {
            try {
                const result = await ipcRenderer.invoke('google-auth-status');
                calendarConnected = result.success && result.connected;
                updateCalendarSettingsUI();
                if (calendarConnected) {
                    await loadCalendarEvents();
                    if (calendarRefreshInterval) clearInterval(calendarRefreshInterval);
                    calendarRefreshInterval = setInterval(loadCalendarEvents, 5 * 60 * 1000);
                } else {
                    renderCalendarSidebar();
                }
            } catch (error) {
                log(`Calendar status check failed: ${error.message}`);
                calendarConnected = false;
                updateCalendarSettingsUI();
                renderCalendarSidebar();
            }
        }

        async function refreshCalendarEvents() {
            const btn = document.getElementById('calendar-refresh-btn');
            btn.classList.add('spinning');
            await loadCalendarEvents();
            setTimeout(() => btn.classList.remove('spinning'), 600);
        }

        async function loadCalendarEvents() {
            try {
                const result = await ipcRenderer.invoke('get-calendar-events');
                if (result.needsAuth) {
                    calendarConnected = false;
                    calendarEvents = [];
                    updateCalendarSettingsUI();
                    renderCalendarSidebar();
                    return;
                }
                if (result.success) {
                    calendarEvents = result.events;
                } else {
                    calendarEvents = [];
                }
            } catch (error) {
                log(`Failed to load calendar events: ${error.message}`);
                calendarEvents = [];
            }
            renderCalendarSidebar();
            scheduleCalendarNotifications();
        }

        function fireCalendarNotification(event) {
            if (notifiedEventIds.has(event.id)) return;
            notifiedEventIds.add(event.id);

            const startStr = event.start?.dateTime || event.start?.date;
            const title = event.summary || 'Upcoming meeting';
            const timeStr = formatCalendarTime(startStr);
            const eventId = event.id;
            const notif = new Notification('Meeting in 5 minutes', {
                body: `${title} at ${timeStr}`,
                silent: false
            });
            notif.onclick = () => {
                ipcRenderer.send('focus-window');
                const idx = calendarEvents.findIndex(e => e.id === eventId);
                if (idx !== -1) showCalendarEventDetail(idx);
            };
        }

        function scheduleCalendarNotifications() {
            // Clear existing timers
            calendarNotificationTimers.forEach(t => clearTimeout(t));
            calendarNotificationTimers = [];

            const now = Date.now();
            const LEAD_TIME = 5 * 60 * 1000; // 5 minutes before

            for (const event of calendarEvents) {
                const startStr = event.start?.dateTime || event.start?.date;
                if (!startStr) continue;

                const startTime = new Date(startStr).getTime();
                const notifyAt = startTime - LEAD_TIME;
                const delay = notifyAt - now;

                // Skip if already past, or already notified
                if (delay < -LEAD_TIME || notifiedEventIds.has(event.id)) continue;

                if (delay <= 0) {
                    // Already within the notification window  fire immediately
                    fireCalendarNotification(event);
                } else {
                    const ev = event;
                    const timer = setTimeout(() => fireCalendarNotification(ev), delay);
                    calendarNotificationTimers.push(timer);
                }
            }
        }

        function renderCalendarSidebar() {
            const container = document.getElementById('calendar-sidebar');
            const list = document.getElementById('calendar-sidebar-list');

            if (!calendarConnected || calendarEvents.length === 0) {
                container.classList.remove('show');
                return;
            }

            container.classList.add('show');
            const eventsToShow = calendarEvents.slice(0, 3);
            list.innerHTML = eventsToShow.map((event, i) => {
                const title = event.summary || 'No title';
                const meta = formatCalendarMeta(event);
                const activeClass = selectedCalendarEvent === i ? ' active' : '';
                return `<div class="calendar-sidebar-item${activeClass}" data-cal-index="${i}">
                    <span class="event-title">${escapeHtml(title)}</span>
                    <span class="event-meta"><span class="event-time">${meta}</span></span>
                </div>`;
            }).join('');

            list.querySelectorAll('.calendar-sidebar-item').forEach(item => {
                item.addEventListener('click', () => {
                    const idx = parseInt(item.dataset.calIndex);
                    showCalendarEventDetail(idx);
                });
            });
        }

        function formatCalendarMeta(event) {
            const time = formatCalendarTime(event);
            const now = new Date();
            const start = event.start?.dateTime ? new Date(event.start.dateTime) : (event.start?.date ? new Date(event.start.date + 'T00:00:00') : null);
            if (!start) return time;

            const isToday = start.toDateString() === now.toDateString();
            const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1);
            const isTomorrow = start.toDateString() === tomorrow.toDateString();

            if (isToday) return `Today, ${time}`;
            const datePart = isTomorrow ? 'Tomorrow' : start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            return `${datePart}, ${time}`;
        }

        function formatCalendarTime(event) {
            if (event.start?.dateTime) {
                return new Date(event.start.dateTime).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            }
            if (event.start?.date) return 'All day';
            return '';
        }

        function formatCalendarDateFull(event) {
            const dt = event.start?.dateTime ? new Date(event.start.dateTime) : (event.start?.date ? new Date(event.start.date + 'T00:00:00') : null);
            if (!dt) return '';
            return dt.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatCalendarTimeRange(event) {
            if (event.start?.dateTime && event.end?.dateTime) {
                const fmt = { hour: 'numeric', minute: '2-digit' };
                return `${new Date(event.start.dateTime).toLocaleTimeString([], fmt)} - ${new Date(event.end.dateTime).toLocaleTimeString([], fmt)}`;
            }
            return 'All day';
        }

        function showCalendarEventDetail(index) {
            calendarDetailJustOpened = true;
            const event = calendarEvents[index];
            if (!event) return;

            selectedCalendarEvent = index;
            selectedMeeting = null;
            document.querySelectorAll('.meeting-item').forEach(item => item.classList.remove('active'));

            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('meeting-detail').classList.remove('show');

            document.getElementById('calendar-detail-title').textContent = event.summary || 'No title';
            document.getElementById('calendar-detail-time').querySelector('span').textContent = formatCalendarTimeRange(event);
            document.getElementById('calendar-detail-date').querySelector('span').textContent = formatCalendarDateFull(event);

            const attendeesSection = document.getElementById('calendar-detail-attendees-section');
            const attendeesContainer = document.getElementById('calendar-detail-attendees');
            if (event.attendees && event.attendees.length > 0) {
                attendeesSection.style.display = 'block';
                attendeesContainer.innerHTML = event.attendees.map(a => {
                    const name = a.displayName || a.email || 'Unknown';
                    return `<span class="calendar-detail-attendee">${escapeHtml(name)}</span>`;
                }).join('');
            } else {
                attendeesSection.style.display = 'none';
            }

            const descSection = document.getElementById('calendar-detail-description-section');
            const descContainer = document.getElementById('calendar-detail-description');
            if (event.description) {
                descSection.style.display = 'block';
                descContainer.textContent = event.description;
            } else {
                descSection.style.display = 'none';
            }

            document.getElementById('calendar-event-detail').classList.add('show');
            renderCalendarSidebar();
        }

        function hideCalendarEventDetail() {
            selectedCalendarEvent = null;
            document.getElementById('calendar-event-detail').classList.remove('show');
            document.getElementById('empty-state').style.display = 'flex';
            renderCalendarSidebar();
        }

        function recordCalendarEvent() {
            if (selectedCalendarEvent === null) return;
            const event = calendarEvents[selectedCalendarEvent];
            if (!event) return;
            document.getElementById('session-name').value = event.summary || 'Meeting';
            hideCalendarEventDetail();
            document.getElementById('start-btn').click();
        }

        async function toggleGoogleCalendar() {
            const btn = document.getElementById('google-cal-btn');
            if (calendarConnected) {
                btn.disabled = true;
                btn.textContent = 'Disconnecting...';
                await ipcRenderer.invoke('google-auth-disconnect');
                calendarConnected = false;
                calendarEvents = [];
                selectedCalendarEvent = null;
                if (calendarRefreshInterval) { clearInterval(calendarRefreshInterval); calendarRefreshInterval = null; }
                document.getElementById('calendar-event-detail').classList.remove('show');
                document.getElementById('empty-state').style.display = 'flex';
                updateCalendarSettingsUI();
                renderCalendarSidebar();
            } else {
                btn.disabled = true;
                btn.textContent = 'Connecting...';
                const result = await ipcRenderer.invoke('google-auth-start');
                if (!result.success) log(`Google Calendar connect failed: ${result.error}`);
                btn.disabled = false;
                updateCalendarSettingsUI();
            }
        }

        function updateCalendarSettingsUI() {
            const statusText = document.getElementById('google-cal-status-text');
            const btn = document.getElementById('google-cal-btn');
            if (calendarConnected) {
                statusText.textContent = 'Connected';
                statusText.style.color = '#22c55e';
                btn.textContent = 'Disconnect';
                btn.disabled = false;
            } else {
                statusText.textContent = 'Not connected';
                statusText.style.color = 'var(--text-muted)';
                btn.textContent = 'Connect';
                btn.disabled = false;
            }
        }

        ipcRenderer.on('google-auth-changed', () => { checkGoogleCalendarStatus(); });
        document.getElementById('calendar-detail-back').addEventListener('click', hideCalendarEventDetail);
        document.getElementById('calendar-record-btn').addEventListener('click', recordCalendarEvent);

        // Auto-clear state on startup
        async function initializeApp() {
            // Clear debug logs for fresh start
            clearDebugLog();
            
            log('Initializing Steno Recorder...');
            
            // Request notification permission early (non-blocking)
            if (Notification.permission === 'default') {
                Notification.requestPermission().catch(() => {}); // Don't wait for this
            }
            
            // Parallel startup: Load meetings first (user sees content immediately),
            // then clear state and check status in background
            const startTime = Date.now();
            
            try {
                // Start loading meetings immediately (most important for user experience)
                const meetingsPromise = loadMeetings();
                
                // Do maintenance tasks in parallel
                const maintenancePromise = Promise.all([
                    ipcRenderer.invoke('clear-state').catch(err =>
                        log(`State clear failed: ${err.message}`)
                    ),
                    checkInitialStatus().catch(err =>
                        log(`Status check failed: ${err.message}`)
                    ),
                    loadNotificationSettings().catch(err =>
                        log(`Notification settings load failed: ${err.message}`)
                    ),
                    loadTelemetrySettings().catch(err =>
                        log(`Telemetry settings load failed: ${err.message}`)
                    ),
                    loadStoragePath().catch(err =>
                        log(`Storage path load failed: ${err.message}`)
                    ),
                    checkGoogleCalendarStatus().catch(err =>
                        log(`Calendar status check failed: ${err.message}`)
                    )
                ]);
                
                // Wait for meetings to load (priority), maintenance can finish in background
                await meetingsPromise;
                log(`Meetings loaded (${Date.now() - startTime}ms)`);
                
                // Wait for maintenance to complete
                await maintenancePromise;
                
            } catch (error) {
                log(`Initialization error: ${error.message}`);
                // Continue anyway - app should still be usable
            }
            
            log(`Steno Recorder ready (${Date.now() - startTime}ms total)`);
        }

        // Startup setup flow
        let setupInProgress = false;
        
        setupAutoStart.addEventListener('click', async () => {
            if (setupInProgress) return;
            await runSetupProcess();
        });
        
        setupContinue.addEventListener('click', () => {
            setupOverlay.style.display = 'none';
            // Refresh meetings after setup completion to ensure fresh data
            loadMeetings(true);
        });
        
        // Settings button click handler
        settingsBtn.addEventListener('click', () => {
            toggleSettings();
        });
        
        // Reprocess button click handler
        reprocessBtn.addEventListener('click', async () => {
            if (!selectedMeeting) return;
            
            const summaryFile = selectedMeeting.session_info?.summary_file;
            if (!summaryFile) {
                log(' No summary file found for reprocessing');
                return;
            }
            
            // Track which meeting is being processed
            processingMeeting = selectedMeeting;
            const meetingName = selectedMeeting.session_info?.name;
            if (meetingName) {
                processingMeetings.add(meetingName);
                renderMeetingsList();
            }

            // Show processing state
            reprocessBtn.disabled = true;
            reprocessBtn.classList.add('processing');
            reprocessBtn.innerHTML = '<div class="reprocess-spinner"></div>Processing...';

            const meetingBeingProcessed = selectedMeeting; // Capture the meeting being processed
            log(` Reprocessing meeting: ${meetingBeingProcessed.session_info?.name}`);
            
            try {
                // Call main process to reprocess the meeting
                const result = await ipcRenderer.invoke('reprocess-meeting', summaryFile);
                
                if (result.success) {
                    log(' Meeting reprocessed successfully');
                    
                    // Send notification for reprocessing completion
                    showDesktopNotification('StenoAI - Reprocessing Complete', {
                        body: `"${meetingBeingProcessed.session_info?.name || 'Meeting'}" has been reanalyzed`,
                        requireInteraction: false
                    }, () => {
                        const idx = filteredMeetings.findIndex(m => m.session_info?.summary_file === summaryFile);
                        if (idx !== -1) selectMeeting(idx);
                    });
                    
                    // Reload meetings to show updated data
                    await loadMeetings(true);
                    // Re-select the current meeting to show updated content
                    const updatedMeetingIndex = filteredMeetings.findIndex(m => 
                        m.session_info?.summary_file === summaryFile
                    );
                    if (updatedMeetingIndex !== -1) {
                        selectMeeting(updatedMeetingIndex);
                    }
                } else {
                    log(` Reprocessing failed: ${result.error}`);
                }
            } catch (error) {
                log(` Reprocessing error: ${error.message}`);
            } finally {
                // Clear processing tracker
                processingMeeting = null;
                if (meetingName) {
                    processingMeetings.delete(meetingName);
                    renderMeetingsList();
                }
                
                // Reset button state only if we're still viewing the same meeting
                if (selectedMeeting && selectedMeeting.session_info?.summary_file === summaryFile) {
                    reprocessBtn.disabled = false;
                    reprocessBtn.classList.remove('processing');
                    reprocessBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>';
                }
            }
        });

        // AI Query functionality
        function showAiQueryPopup() {
            if (!selectedMeeting) {
                log('No meeting selected for AI query');
                return;
            }
            aiQueryPopup.classList.add('show');
            aiQueryInput.value = '';
            aiQueryResponse.classList.remove('show');
            aiQueryResponseContent.textContent = '';
            aiQueryResponseContent.classList.remove('loading', 'error');
            setTimeout(() => aiQueryInput.focus(), 100);
        }

        function hideAiQueryPopup() {
            aiQueryPopup.classList.remove('show');
            aiQueryInput.value = '';
            aiQueryResponse.classList.remove('show');
        }

        function formatAiResponse(text) {
            // Escape HTML
            const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Bold **text**
            let html = escaped.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Bullet points: lines starting with * or -
            html = html.replace(/^[\*\-]\s+(.+)$/gm, '<li>$1</li>');
            // Wrap consecutive <li> in <ul>
            html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            // Line breaks for remaining newlines
            html = html.replace(/\n/g, '<br>');
            // Clean up <br> inside/around <ul>
            html = html.replace(/<br><ul>/g, '<ul>');
            html = html.replace(/<\/ul><br>/g, '</ul>');
            html = html.replace(/<ul><br>/g, '<ul>');
            return html;
        }

        async function submitAiQuery() {
            const question = aiQueryInput.value.trim();
            if (!question) return;
            if (!selectedMeeting) {
                log('No meeting selected for AI query');
                return;
            }

            const summaryFile = selectedMeeting.session_info?.summary_file;
            if (!summaryFile) {
                log('No summary file found for AI query');
                return;
            }

            // Show loading state
            aiQuerySubmit.disabled = true;
            aiQueryResponse.classList.add('show');
            aiQueryResponseContent.classList.add('loading');
            aiQueryResponseContent.classList.remove('error');
            aiQueryResponseContent.innerHTML = '<div class="ai-query-spinner"></div>Thinking...';

            log(`Asking AI: ${question.substring(0, 50)}...`);

            try {
                const result = await ipcRenderer.invoke('query-transcript', summaryFile, question);

                if (result.success) {
                    aiQueryResponseContent.classList.remove('loading');
                    aiQueryResponseContent.innerHTML = formatAiResponse(result.answer);
                    log('AI response received');
                } else {
                    aiQueryResponseContent.classList.remove('loading');
                    aiQueryResponseContent.classList.add('error');
                    aiQueryResponseContent.textContent = result.error || 'Failed to get response from AI';
                    log(`AI query failed: ${result.error}`);
                }
            } catch (error) {
                aiQueryResponseContent.classList.remove('loading');
                aiQueryResponseContent.classList.add('error');
                aiQueryResponseContent.textContent = 'Failed to query AI: ' + error.message;
                log(`AI query error: ${error.message}`);
            } finally {
                aiQuerySubmit.disabled = false;
            }
        }

        // Ask AI button click handler
        askAiBtn.addEventListener('click', showAiQueryPopup);

        // AI Query close button
        aiQueryClose.addEventListener('click', hideAiQueryPopup);

        // AI Query submit button
        aiQuerySubmit.addEventListener('click', submitAiQuery);

        // AI Query input - submit on Enter
        aiQueryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                submitAiQuery();
            }
            if (e.key === 'Escape') {
                hideAiQueryPopup();
            }
        });

        // Global keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Cmd+K or Ctrl+K to open AI query
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                if (aiQueryPopup.classList.contains('show')) {
                    hideAiQueryPopup();
                } else if (selectedMeeting) {
                    showAiQueryPopup();
                }
            }
            // Cmd+, or Ctrl+, to toggle settings
            if ((e.metaKey || e.ctrlKey) && e.key === ',') {
                e.preventDefault();
                toggleSettings();
            }
            // Escape to close panels
            if (e.key === 'Escape') {
                if (aiQueryPopup.classList.contains('show')) {
                    hideAiQueryPopup();
                } else if (settingsVisible) {
                    toggleSettings();
                }
            }
        });

        // Close AI query popup when clicking outside
        aiQueryPopup.addEventListener('click', (e) => {
            if (e.target === aiQueryPopup) {
                hideAiQueryPopup();
            }
        });

        // Copy transcript to clipboard
        copyTranscriptBtn.addEventListener('click', async () => {
            try {
                const transcriptText = detailTranscript.textContent || '';
                if (!transcriptText || transcriptText === 'No transcript available') {
                    log(' No transcript available to copy');
                    return;
                }
                
                await navigator.clipboard.writeText(transcriptText);
                
                // Visual feedback
                copyTranscriptBtn.classList.add('copied');
                copyTranscriptBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                `;
                
                // Reset after 2 seconds
                setTimeout(() => {
                    copyTranscriptBtn.classList.remove('copied');
                    copyTranscriptBtn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    `;
                }, 2000);
                
                log(' Transcript copied to clipboard');
            } catch (error) {
                log(` Failed to copy transcript: ${error.message}`);
            }
        });

        // Copy all meeting notes to clipboard
        copyNotesBtn.addEventListener('click', async () => {
            try {
                if (!selectedMeeting) {
                    log(' No meeting selected to copy');
                    return;
                }

                // Format meeting notes as text
                const meetingName = selectedMeeting.session_info?.name || 'Untitled Meeting';
                const date = formatDate(selectedMeeting.session_info?.processed_at);
                const duration = selectedMeeting.session_info?.duration_seconds ?
                    `${Math.floor(selectedMeeting.session_info.duration_seconds / 60)}m ${selectedMeeting.session_info.duration_seconds % 60}s` :
                    'Unknown';

                let notesText = `${meetingName}\n`;
                notesText += `Date: ${date}\n`;
                notesText += `Duration: ${duration}\n`;
                notesText += `\n`;

                // Summary
                if (selectedMeeting.summary) {
                    notesText += `SUMMARY\n`;
                    notesText += `${selectedMeeting.summary}\n\n`;
                }

                // Participants
                if (selectedMeeting.participants && selectedMeeting.participants.length > 0) {
                    notesText += `PARTICIPANTS\n`;
                    selectedMeeting.participants.forEach(participant => {
                        notesText += `- ${participant}\n`;
                    });
                    notesText += `\n`;
                }

                // Key Topics (Discussion Areas)
                if (selectedMeeting.discussion_areas && selectedMeeting.discussion_areas.length > 0) {
                    notesText += `KEY TOPICS\n`;
                    selectedMeeting.discussion_areas.forEach(area => {
                        notesText += `\n${area.title}\n`;
                        notesText += `${area.analysis}\n`;
                    });
                    notesText += `\n`;
                }

                // Key Points
                if (selectedMeeting.key_points && selectedMeeting.key_points.length > 0) {
                    notesText += `KEY POINTS\n`;
                    selectedMeeting.key_points.forEach(point => {
                        notesText += `- ${point}\n`;
                    });
                    notesText += `\n`;
                }

                // Action Items
                if (selectedMeeting.action_items && selectedMeeting.action_items.length > 0) {
                    notesText += `ACTION ITEMS\n`;
                    selectedMeeting.action_items.forEach(item => {
                        notesText += `- ${item}\n`;
                    });
                }

                await navigator.clipboard.writeText(notesText);

                // Visual feedback
                copyNotesBtn.classList.add('copied');
                const originalHTML = copyNotesBtn.innerHTML;
                copyNotesBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20,6 9,17 4,12"></polyline>
                    </svg>
                    Copied!
                `;

                // Reset after 2 seconds
                setTimeout(() => {
                    copyNotesBtn.classList.remove('copied');
                    copyNotesBtn.innerHTML = originalHTML;
                }, 2000);

                log(' Meeting notes copied to clipboard');
            } catch (error) {
                log(` Failed to copy notes: ${error.message}`);
            }
        });

        // Edit meeting title - define as a reusable function
        function startEditingTitle() {
            if (!selectedMeeting) return;

            const titleElement = document.getElementById('detail-title');
            const editBtn = document.getElementById('edit-title-btn');
            const currentTitle = titleElement.textContent;

            // Hide title and edit button
            titleElement.style.display = 'none';
            editBtn.style.display = 'none';

            // Create input and buttons
            const titleContainer = document.querySelector('.meeting-title-container');
            const inputHTML = `
                <input type="text" class="meeting-title-input" id="title-input" value="${currentTitle}">
                <div class="title-edit-actions">
                    <button class="save-title-btn" id="save-title-btn">Save</button>
                    <button class="cancel-title-btn" id="cancel-title-btn">Cancel</button>
                </div>
            `;
            titleContainer.insertAdjacentHTML('beforeend', inputHTML);

            const titleInput = document.getElementById('title-input');
            const saveTitleBtn = document.getElementById('save-title-btn');
            const cancelTitleBtn = document.getElementById('cancel-title-btn');

            // Focus and select the input
            titleInput.focus();
            titleInput.select();

            // Save on Enter key
            titleInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    saveTitleBtn.click();
                } else if (e.key === 'Escape') {
                    cancelTitleBtn.click();
                }
            });

            // Cancel function
            const cancelEdit = () => {
                titleInput.remove();
                document.querySelector('.title-edit-actions').remove();
                titleElement.style.display = '';
                editBtn.style.display = '';
            };

            // Save function
            const saveTitle = async () => {
                const newTitle = titleInput.value.trim();
                if (!newTitle || newTitle === currentTitle) {
                    cancelEdit();
                    return;
                }

                try {
                    const result = await ipcRenderer.invoke('update-meeting',
                        selectedMeeting.session_info.summary_file,
                        { name: newTitle }
                    );

                    if (result.success) {
                        // Update local data
                        selectedMeeting.session_info.name = newTitle;

                        // Update the SAME title element (keeps detailTitle reference valid)
                        titleElement.textContent = newTitle;

                        // Remove input and show title again
                        titleInput.remove();
                        document.querySelector('.title-edit-actions').remove();
                        titleElement.style.display = '';
                        editBtn.style.display = '';

                        // Reload meetings list to show updated name
                        await loadMeetings(true);

                        log(` Meeting name updated to: ${newTitle}`);
                    } else {
                        log(` Failed to update meeting name: ${result.error}`);
                        cancelEdit();
                    }
                } catch (error) {
                    log(` Error updating meeting name: ${error.message}`);
                    cancelEdit();
                }
            };

            cancelTitleBtn.addEventListener('click', cancelEdit);
            saveTitleBtn.addEventListener('click', saveTitle);
        }

        // Attach the initial event listener
        editTitleBtn.addEventListener('click', startEditingTitle);

        // Listen for debug messages from backend
        ipcRenderer.on('debug-log', (event, message) => {
            debugLog(message);
        });

        // Listen for global hotkey toggle recording
        ipcRenderer.on('toggle-recording-hotkey', () => {
            log('Global hotkey received: toggle recording');
            if (uiState === 'recording') {
                // Stop recording
                stopBtn.click();
            } else if (uiState === 'ready') {
                // Start recording
                startBtn.click();
            }
            // Ignore if in 'processing' state
        });
        
        // Setup wizard state
        let currentSetupStep = 1;
        let ollamaInstalled = false;

        // Open Ollama download page
        function openOllamaDownload() {
            require('electron').shell.openExternal('https://ollama.com/download');
            debugLog('Opened Ollama download page in browser');
        }

        // Check if Ollama is installed
        async function checkOllamaInstalled() {
            try {
                const result = await ipcRenderer.invoke('check-ollama-installed');
                return result.success && result.installed;
            } catch (error) {
                return false;
            }
        }

        // Recheck Ollama installation
        async function recheckOllama() {
            const ollamaPrompt = document.getElementById('ollama-prompt');
            const stepOllama = document.getElementById('step-ollama');

            debugLog('Rechecking Ollama installation...');

            const installed = await checkOllamaInstalled();
            if (installed) {
                ollamaInstalled = true;
                ollamaPrompt.style.display = 'none';
                stepOllama.style.display = 'block';
                debugLog('Ollama detected! Ready to continue setup.');
                updateStepBadge('ollama', 'waiting', 'Ready');
            } else {
                debugLog('Ollama still not detected. Please install and try again.');
            }
        }

        // Update progress indicator
        function updateProgressIndicator(step) {
            const steps = document.querySelectorAll('.setup-progress-step');
            const lines = document.querySelectorAll('.setup-progress-line');

            steps.forEach((el, i) => {
                const stepNum = i + 1;
                el.classList.remove('active', 'completed');

                if (stepNum < step) {
                    el.classList.add('completed');
                    el.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                } else if (stepNum === step) {
                    el.classList.add('active');
                    el.textContent = stepNum;
                } else {
                    el.textContent = stepNum;
                }
            });

            lines.forEach((el, i) => {
                el.classList.toggle('completed', i < step - 1);
            });
        }

        // Update step badge
        function updateStepBadge(stepName, state, text) {
            const badge = document.getElementById(`${stepName}-badge`);
            if (badge) {
                badge.className = `step-badge ${state}`;
                badge.textContent = text || state.charAt(0).toUpperCase() + state.slice(1);
            }
        }

        // Update step progress bar
        function updateStepProgress(stepName, percent) {
            const progress = document.getElementById(`${stepName}-progress`);
            if (progress) {
                progress.style.width = `${percent}%`;
            }
            // Also update the percentage text
            const details = document.getElementById(`${stepName}-details`);
            if (details) {
                const percentEl = details.querySelector('.progress-percent');
                if (percentEl) {
                    percentEl.textContent = `${Math.round(percent)}%`;
                }
            }
        }

        // Toggle debug console
        function toggleDebugConsole() {
            const toggle = document.getElementById('debug-toggle');
            const console = document.getElementById('debug-console');
            toggle.classList.toggle('open');
            console.classList.toggle('show');
        }

        async function runSetupProcess() {
            setupInProgress = true;
            setupAutoStart.style.display = 'none';

            // Clear and initialize debug console
            const debugConsole = document.getElementById('debug-console');
            debugConsole.textContent = 'StenoAI Setup\n' + '='.repeat(40) + '\n';
            debugLog('Starting setup process...');

            // Update header for setup in progress
            document.getElementById('setup-title').textContent = 'Setting Up';
            document.getElementById('setup-description').textContent = 'Installing components. This may take a few minutes.';

            // Define visible steps (simplified from original)
            const visibleSteps = [
                { id: 'step-microphone', badge: 'microphone', handler: 'request-microphone-permission', name: 'Microphone Access', progressStep: 1 },
                { id: 'step-whisper', badge: 'whisper', handler: 'setup-whisper', name: 'Transcription Engine', progressStep: 2 },
                { id: 'step-ollama', badge: 'ollama', handler: 'setup-ollama-and-model', name: 'Summarization Engine', progressStep: 3 }
            ];

            // Hidden background steps
            const backgroundSteps = [
                { id: 'step-system', badge: 'system', handler: 'setup-system-check', name: 'System Check' },
                { id: 'step-python', badge: 'python', handler: 'setup-python', name: 'Python Dependencies' },
                { id: 'step-ffmpeg', badge: 'ffmpeg', handler: 'setup-ffmpeg', name: 'ffmpeg' },
                { id: 'step-test', badge: 'test', handler: 'setup-test', name: 'System Test' }
            ];

            // Run system check and python deps first (silently)
            debugLog('\nPreparing system...');
            for (const step of backgroundSteps.slice(0, 2)) {
                debugLog(`Running: ${step.name}`);
                try {
                    const result = await ipcRenderer.invoke(step.handler);
                    if (!result.success) {
                        debugLog(`Warning: ${step.name} - ${result.error}`);
                    }
                } catch (error) {
                    debugLog(`Warning: ${step.name} failed - ${error.message}`);
                }
            }

            // Run visible steps
            for (const step of visibleSteps) {
                const element = document.getElementById(step.id);

                // Update progress indicator
                updateProgressIndicator(step.progressStep);

                // Mark as active
                element.classList.remove('completed', 'failed');
                updateStepBadge(step.badge, 'active', 'Installing...');
                updateStepProgress(step.badge, 10);

                // Show progress details
                const details = document.getElementById(`${step.badge}-details`);
                if (details) details.style.display = 'flex';

                debugLog(`\n>>> ${step.name}`);

                try {
                    // Simulate progress during install
                    let progress = 10;
                    const progressInterval = setInterval(() => {
                        progress = Math.min(progress + Math.random() * 15, 85);
                        updateStepProgress(step.badge, progress);
                    }, 500);

                    const result = await ipcRenderer.invoke(step.handler);
                    clearInterval(progressInterval);

                    if (result.success) {
                        // For the last visible step (ollama), run system checks before marking complete
                        if (step.id === 'step-ollama') {
                            updateStepBadge(step.badge, 'active', 'Verifying...');
                            updateStepProgress(step.badge, 90);
                            for (const bgStep of backgroundSteps.slice(2)) {
                                try {
                                    await ipcRenderer.invoke(bgStep.handler);
                                } catch (error) {
                                    debugLog(`Warning: ${bgStep.name} - ${error.message}`);
                                }
                            }
                        }

                        element.classList.add('completed');
                        updateStepBadge(step.badge, 'completed', 'Done');
                        updateStepProgress(step.badge, 100);
                        // Hide progress details on completion
                        const details = document.getElementById(`${step.badge}-details`);
                        if (details) details.style.display = 'none';
                        debugLog(`Done: ${result.message || 'Success'}`);

                    } else {
                        element.classList.add('failed');
                        updateStepBadge(step.badge, 'failed', 'Failed');

                        debugLog(`Failed: ${result.error || 'Unknown error'}`);

                        // Show retry button
                        setupAutoStart.textContent = 'Retry Setup';
                        setupAutoStart.style.display = 'block';
                        setupInProgress = false;
                        return;
                    }
                } catch (error) {
                    element.classList.add('failed');
                    updateStepBadge(step.badge, 'failed', 'Error');

                    debugLog(`Error: ${error.message}`);

                    setupAutoStart.textContent = 'Retry Setup';
                    setupAutoStart.style.display = 'block';
                    setupInProgress = false;
                    return;
                }

                await new Promise(resolve => setTimeout(resolve, 300));
            }

            // Complete
            updateProgressIndicator(4); // All done
            document.getElementById('setup-title').textContent = 'Setup Complete';
            document.getElementById('setup-description').textContent = 'StenoAI is ready to transcribe your meetings.';

            debugLog('\n' + '='.repeat(40));
            debugLog('Setup completed successfully!');

            setupContinue.style.display = 'block';
            setupInProgress = false;
        }

        // Smooth startup with automatic setup detection
        async function runStartupCheck() {
            log('Checking system setup...');

            try {
                // Check microphone permission and system setup
                const micResult = await ipcRenderer.invoke('check-microphone-permission');
                const micGranted = micResult.success && micResult.status === 'granted';

                const result = await ipcRenderer.invoke('startup-setup-check');
                const systemReady = result.success && result.allGood;

                if (micGranted && systemReady) {
                    log('System ready!');
                    return;
                } else {
                    log('Setup needed');
                    showSetupOverlay(result.checks || []);
                }
            } catch (error) {
                log(`Setup check failed: ${error.message}`);
                showSetupOverlay([]);
            }
        }

        async function showSetupOverlay(checks) {
            setupOverlay.style.display = 'flex';

            // Reset progress indicator
            updateProgressIndicator(1);

            // Check if Ollama is installed
            ollamaInstalled = await checkOllamaInstalled();
            const ollamaPrompt = document.getElementById('ollama-prompt');
            const stepOllama = document.getElementById('step-ollama');

            if (!ollamaInstalled) {
                // Show Ollama download prompt
                ollamaPrompt.style.display = 'block';
                stepOllama.style.display = 'none';
                debugLog('Ollama not detected. Please download and install it.');
            } else {
                ollamaPrompt.style.display = 'none';
                stepOllama.style.display = 'block';
            }

            // Reset visible step states
            ['microphone', 'whisper', 'ollama'].forEach(step => {
                const element = document.getElementById(`step-${step}`);
                if (element) {
                    element.classList.remove('active', 'completed', 'failed');
                    updateStepBadge(step, 'waiting', 'Waiting');
                    updateStepProgress(step, 0);
                }
            });

            // Check microphone status
            try {
                const micResult = await ipcRenderer.invoke('check-microphone-permission');
                if (micResult.success && micResult.status === 'granted') {
                    document.getElementById('step-microphone').classList.add('completed');
                    updateStepBadge('microphone', 'completed', 'Granted');
                    updateStepProgress('microphone', 100);
                }
            } catch (error) {
                console.error('Mic check failed:', error);
            }

            // Update based on backend checks
            checks.forEach(check => {
                const [status, detail] = check;
                updateStepFromCheck(status, detail);
            });

            // Show appropriate button
            const hasFailures = checks.length === 0 || checks.some(([status]) => status.startsWith(''));
            if (hasFailures || checks.length === 0) {
                setupAutoStart.style.display = 'block';
                setupAutoStart.textContent = 'Begin Setup';
                setupContinue.style.display = 'none';
            } else {
                setupContinue.style.display = 'block';
                setupAutoStart.style.display = 'none';
            }
        }

        function updateStepFromCheck(status, detail) {
            // Only check model status, not package status
            if (status.includes('whisper-model')) {
                if (status.startsWith('')) {
                    document.getElementById('step-whisper').classList.add('completed');
                    updateStepBadge('whisper', 'completed', 'Installed');
                    updateStepProgress('whisper', 100);
                    const details = document.getElementById('whisper-details');
                    if (details) details.style.display = 'none';
                }
                // Don't mark as complete if warning or error
            } else if (status.includes('llm-model')) {
                if (status.startsWith('')) {
                    document.getElementById('step-ollama').classList.add('completed');
                    updateStepBadge('ollama', 'completed', 'Ready');
                    updateStepProgress('ollama', 100);
                    const details = document.getElementById('ollama-details');
                    if (details) details.style.display = 'none';
                }
                // Don't mark as complete if warning or error
            }
        }

        function updateStep(stepId, state, message) {
            const element = document.getElementById(stepId);
            if (element) {
                element.classList.remove('active', 'completed', 'failed');
                element.classList.add(state);
            }
        }

        // Listen for automatic meetings refresh from backend (legacy - kept for compatibility)
        ipcRenderer.on('meetings-refreshed', (event, meetingsData) => {
            log('Processing complete! Meeting list automatically refreshed');
            meetings = meetingsData || [];
            filterMeetings(); // Apply current search filter and render
        });
        
        // Listen for model pull progress
        ipcRenderer.on('model-pull-progress', (event, data) => {
            updateModelProgress(data.model, data.progress);
        });

        // Listen for model pull completion
        ipcRenderer.on('model-pull-complete', (event, data) => {
            hideModelDownloading(data.model);

            if (data.success) {
                showModelNotification(`Successfully downloaded ${data.model}!`, 'success');
                loadModels(); // Reload to show as installed
            } else {
                showModelNotification(`Failed to download ${data.model}: ${data.error}`, 'error');
            }
        });

        // Listen for processing completion events
        ipcRenderer.on('processing-complete', (event, data) => {
            log(`Processing complete for: ${data.sessionName}`);
            processingMeetings.delete(data.sessionName);
            
            if (data.success) {
                if (data.meetingData) {
                    // Update the specific meeting with processed data
                    const tempMeetingIndex = meetings.findIndex(meeting => 
                        meeting.session_info?.name === data.sessionName && meeting.summary === 'Pending...'
                    );
                    
                    if (tempMeetingIndex !== -1) {
                        // Replace temporary meeting with processed data
                        meetings[tempMeetingIndex] = data.meetingData;
                        meetingsLastLoaded = Date.now(); // Update cache timestamp
                    } else {
                        // Add new meeting if temp entry not found
                        meetings.unshift(data.meetingData);
                        meetingsLastLoaded = Date.now(); // Update cache timestamp
                    }
                    
                    // Re-render the meetings list with updated data
                    filterMeetings();
                } else {
                    // No meetingData provided - force refresh from backend
                    log('No meeting data in completion event - forcing refresh');
                    loadMeetings(true);
                }
                
                // Show native notification
                showDesktopNotification('StenoAI - Meeting Notes Ready', {
                    body: `"${data.sessionName}" has been transcribed and summarized`,
                    requireInteraction: false
                }, () => {
                    const idx = filteredMeetings.findIndex(m => m.session_info?.name === data.sessionName);
                    if (idx !== -1) selectMeeting(idx);
                });
                
                setStatus('ready', 'Processing complete');
                setTimeout(() => setStatus('ready', 'Ready'), 3000);
            } else {
                // Remove temporary meeting entry on failure
                meetings = meetings.filter(meeting =>
                    !(meeting.session_info?.name === data.sessionName && meeting.summary === 'Pending...')
                );

                setStatus('ready', 'Processing failed');
                setTimeout(() => setStatus('ready', 'Ready'), 5000);
                log(`Processing failed: ${data.error}`);
                filterMeetings();
            }
        });
        
        // Unified settings panel functionality
        let settingsVisible = false;

        function toggleSettings() {
            const settingsPanel = document.getElementById('settings-panel');
            const settingsBackdrop = document.getElementById('settings-backdrop');
            settingsVisible = !settingsVisible;

            if (settingsVisible) {
                // Prepare content before slide-in to avoid stagger
                switchSettingsTab('general');
                restoreDeveloperMode();
                // Force layout calc so tab state is committed before transition
                settingsPanel.offsetHeight;
                settingsPanel.classList.add('open');
                settingsBackdrop.classList.add('open');
                loadSettingsVersionInfo();
            } else {
                settingsPanel.classList.remove('open');
                settingsBackdrop.classList.remove('open');
            }
        }

        // Tab switching logic
        function switchSettingsTab(tabName) {
            // Update nav active state
            document.querySelectorAll('.settings-nav-item').forEach(n => n.classList.remove('active'));
            const navItem = document.querySelector(`.settings-nav-item[data-tab="${tabName}"]`);
            if (navItem) navItem.classList.add('active');
            // Update tab visibility
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            // Full-width mode for developer tab
            const settingsBody = document.querySelector('.settings-body');
            if (tabName === 'developer') {
                settingsBody.classList.add('developer-active');
            } else {
                settingsBody.classList.remove('developer-active');
            }
            // Load tab-specific data
            if (tabName === 'ai') {
                loadModels();
            }
        }

        document.querySelectorAll('.settings-nav-item').forEach(navItem => {
            navItem.addEventListener('click', () => switchSettingsTab(navItem.dataset.tab));
        });

        // Developer tab back button
        document.getElementById('dev-back-btn').addEventListener('click', () => {
            switchSettingsTab('general');
        });

        // Developer mode toggle
        function restoreDeveloperMode() {
            const devToggle = document.getElementById('developer-mode-toggle');
            const devNavItem = document.getElementById('developer-nav-item');
            const enabled = localStorage.getItem('developerMode') === 'true';
            devToggle.checked = enabled;
            devNavItem.style.display = enabled ? '' : 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const devToggle = document.getElementById('developer-mode-toggle');
            if (devToggle) {
                devToggle.addEventListener('change', (e) => {
                    const enabled = e.target.checked;
                    localStorage.setItem('developerMode', enabled);
                    const devNavItem = document.getElementById('developer-nav-item');
                    devNavItem.style.display = enabled ? '' : 'none';
                    // If disabling and currently on developer tab, switch to general
                    if (!enabled) {
                        const activeTab = document.querySelector('.settings-nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'developer') {
                            switchSettingsTab('general');
                        }
                    }
                });
            }
        });

        async function loadSettingsVersionInfo() {
            try {
                const versionInfo = await ipcRenderer.invoke('get-app-version');
                const versionElement = document.getElementById('app-version');
                if (versionInfo.success) {
                    versionElement.textContent = `v${versionInfo.version}`;
                } else {
                    versionElement.textContent = 'Unknown';
                }
            } catch (error) {
                document.getElementById('app-version').textContent = 'Unknown';
            }
        }
        

        // Model management functions
        async function loadModels() {
            try {
                const result = await ipcRenderer.invoke('list-models');

                if (result.success) {
                    displayModelList(result.supported_models, result.current_model);
                } else {
                    document.getElementById('model-list').innerHTML = '<div class="model-list-loading" style="color: var(--recording-red);">Failed to load models</div>';
                }
            } catch (error) {
                console.error('Error loading models:', error);
                document.getElementById('model-list').innerHTML = '<div class="model-list-loading" style="color: var(--recording-red);">Error loading models</div>';
            }
        }

        function displayCurrentModel(modelName) {
            // No longer a separate display - handled inline in model list
        }

        function displayModelList(models, currentModel) {
            const modelListDiv = document.getElementById('model-list');
            modelListDiv.innerHTML = '';

            for (const [modelName, modelInfo] of Object.entries(models)) {
                const isCurrentModel = modelName === currentModel;

                const modelItem = document.createElement('div');
                modelItem.className = 'model-item' + (isCurrentModel ? ' active' : '');
                modelItem.setAttribute('data-model-name', modelName);
                modelItem.setAttribute('data-model-size', modelInfo.size);

                const tagMatch = modelInfo.description.match(/\((default|recommended)\)/i);
                const tagHtml = tagMatch ? `<span class="model-tag">${tagMatch[1]}</span>` : '';
                const activeHtml = isCurrentModel ? '<span class="model-active-badge">Active</span>' : '';

                modelItem.innerHTML = `
                    <div class="model-item-info">
                        <div class="model-item-name">
                            ${modelName}${tagHtml}${activeHtml}
                        </div>
                        <div class="model-item-meta">${modelInfo.size} &middot; ${modelInfo.speed} speed &middot; ${modelInfo.quality} quality</div>
                        <div class="model-progress">
                            <div class="progress-text">Downloading...</div>
                        </div>
                    </div>
                    <div class="model-item-action">
                        ${isCurrentModel
                            ? ''
                            : '<button class="settings-action-btn" onclick="event.stopPropagation(); selectModel(\'' + modelName + '\')">Select</button>'
                        }
                    </div>
                `;

                if (!isCurrentModel) {
                    modelItem.addEventListener('click', () => selectModel(modelName));
                }

                modelListDiv.appendChild(modelItem);
            }
        }

        async function selectModel(modelName) {
            try {
                // Check if model is already installed
                const checkResult = await ipcRenderer.invoke('check-model-installed', modelName);

                if (!checkResult.success) {
                    alert(`Error checking model status: ${checkResult.error}`);
                    return;
                }

                const isInstalled = checkResult.installed;
                let confirmMsg;

                if (isInstalled) {
                    confirmMsg = `Switch to model: ${modelName}?\n\nThis model is already installed and ready to use.`;
                } else {
                    confirmMsg = `Switch to model: ${modelName}?\n\nThis model will be downloaded (${getModelSize(modelName)}).\n\n WARNING: Model downloads will pause any active summarization.\nWait for current processing to finish before downloading.`;
                }

                if (!confirm(confirmMsg)) {
                    return;
                }

                // Set the model preference
                const result = await ipcRenderer.invoke('set-model', modelName);

                if (!result.success) {
                    alert(`Failed to set model: ${result.error}`);
                    return;
                }

                // If already installed, just reload and show success
                if (isInstalled) {
                    showModelNotification(`Switched to ${modelName}!`, 'success');
                    loadModels();
                    return;
                }

                // Model needs to be downloaded - start non-blocking pull
                showModelDownloading(modelName);

                // Start download (non-blocking - returns immediately)
                ipcRenderer.invoke('pull-model', modelName).catch(error => {
                    console.error('Error starting model pull:', error);
                    hideModelDownloading(modelName);
                    showModelNotification(`Failed to start download: ${error.message}`, 'error');
                });

            } catch (error) {
                console.error('Error selecting model:', error);
                alert(`Error selecting model: ${error.message}`);
            }
        }

        function getModelSize(modelName) {
            const modelList = document.getElementById('model-list');
            const modelCards = modelList.querySelectorAll('[data-model-name]');
            for (const card of modelCards) {
                if (card.dataset.modelName === modelName) {
                    const sizeText = card.dataset.modelSize;
                    return sizeText || 'unknown size';
                }
            }
            return 'unknown size';
        }

        function showModelDownloading(modelName) {
            const modelCard = document.querySelector(`[data-model-name="${modelName}"]`);
            if (!modelCard) return;

            const progressDiv = modelCard.querySelector('.model-progress');
            if (progressDiv) {
                progressDiv.style.display = 'block';
                progressDiv.querySelector('.progress-text').textContent = 'Starting download...';
            }
        }

        function hideModelDownloading(modelName) {
            const modelCard = document.querySelector(`[data-model-name="${modelName}"]`);
            if (!modelCard) return;

            const progressDiv = modelCard.querySelector('.model-progress');
            if (progressDiv) {
                progressDiv.style.display = 'none';
            }
        }

        function updateModelProgress(modelName, progressText) {
            const modelCard = document.querySelector(`[data-model-name="${modelName}"]`);
            if (!modelCard) return;

            const progressDiv = modelCard.querySelector('.model-progress');
            if (progressDiv) {
                progressDiv.querySelector('.progress-text').textContent = progressText;
            }
        }

        function showModelNotification(message, type = 'info') {
            // In-app notification toast (bottom-right, matches app theme)
            const cs = getComputedStyle(document.documentElement);
            const bgColor = type === 'success'
                ? cs.getPropertyValue('--success-green').trim()
                : type === 'error'
                    ? cs.getPropertyValue('--recording-red').trim()
                    : cs.getPropertyValue('--accent-primary').trim();
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${bgColor};
                color: white;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                max-width: 350px;
                animation: slideInFromBottom 0.3s ease-out;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            const duration = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                notification.style.animation = 'slideOutToBottom 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, duration);
        }

        async function loadNotificationSettings() {
            try {
                const result = await ipcRenderer.invoke('get-notifications');
                const toggle = document.getElementById('notifications-toggle');

                if (result.success) {
                    toggle.checked = result.notifications_enabled;
                } else {
                    console.error('Failed to load notification settings:', result.error);
                    toggle.checked = true; // Default to enabled
                }
            } catch (error) {
                console.error('Error loading notification settings:', error);
                document.getElementById('notifications-toggle').checked = true;
            }
        }

        async function loadTelemetrySettings() {
            try {
                const result = await ipcRenderer.invoke('get-telemetry');
                const toggle = document.getElementById('telemetry-toggle');

                if (result.success) {
                    toggle.checked = result.telemetry_enabled;
                    loadTelemetryId(result.anonymous_id);
                } else {
                    console.error('Failed to load telemetry settings:', result.error);
                    toggle.checked = true; // Default to enabled
                }
            } catch (error) {
                console.error('Error loading telemetry settings:', error);
                document.getElementById('telemetry-toggle').checked = true;
            }
        }

        function loadTelemetryId(id) {
            const el = document.getElementById('anonymous-id-display');
            if (el && id) {
                el.textContent = 'ID: ' + id;
            }
        }

        async function showDesktopNotification(title, options, onClick) {
            // Check if desktop notifications are enabled in settings
            try {
                const result = await ipcRenderer.invoke('get-notifications');
                const notificationsEnabled = result.success ? result.notifications_enabled : true;

                if (Notification.permission === 'granted' && notificationsEnabled) {
                    const notification = new Notification(title, options);
                    if (onClick) {
                        notification.onclick = () => {
                            ipcRenderer.send('focus-window');
                            onClick();
                        };
                    }
                }
            } catch (error) {
                console.error('Error checking notification settings:', error);
                // Default to showing if error
                if (Notification.permission === 'granted') {
                    const notification = new Notification(title, options);
                    if (onClick) {
                        notification.onclick = () => {
                            ipcRenderer.send('focus-window');
                            onClick();
                        };
                    }
                }
            }
        }

        // Setup notification toggle event listener
        document.addEventListener('DOMContentLoaded', () => {
            const notificationsToggle = document.getElementById('notifications-toggle');
            if (notificationsToggle) {
                notificationsToggle.addEventListener('change', async (e) => {
                    try {
                        const enabled = e.target.checked;
                        const result = await ipcRenderer.invoke('set-notifications', enabled);

                        if (result.success) {
                            showModelNotification(
                                `Desktop notifications ${enabled ? 'enabled' : 'disabled'}`,
                                'success'
                            );
                        } else {
                            console.error('Failed to save notification setting:', result.error);
                            showModelNotification('Failed to save setting', 'error');
                            // Revert toggle
                            e.target.checked = !enabled;
                        }
                    } catch (error) {
                        console.error('Error saving notification setting:', error);
                        showModelNotification('Failed to save setting', 'error');
                        e.target.checked = !e.target.checked;
                    }
                });
            }

            const telemetryToggle = document.getElementById('telemetry-toggle');
            if (telemetryToggle) {
                telemetryToggle.addEventListener('change', async (e) => {
                    try {
                        const enabled = e.target.checked;
                        const result = await ipcRenderer.invoke('set-telemetry', enabled);

                        if (result.success) {
                            showModelNotification(
                                `Usage analytics ${enabled ? 'enabled' : 'disabled'}`,
                                'success'
                            );
                        } else {
                            console.error('Failed to save telemetry setting:', result.error);
                            showModelNotification('Failed to save setting', 'error');
                            e.target.checked = !enabled;
                        }
                    } catch (error) {
                        console.error('Error saving telemetry setting:', error);
                        showModelNotification('Failed to save setting', 'error');
                        e.target.checked = !e.target.checked;
                    }
                });
            }
        });

        async function runSetupFromSettings() {
            const btn = document.getElementById('run-setup-btn');
            btn.textContent = 'Running...';
            btn.disabled = true;

            try {
                // Show setup overlay in main window
                document.getElementById('setup-overlay').style.display = 'flex';

                // Run the setup process
                await runSetupProcess();

                btn.textContent = 'Done';
                setTimeout(() => {
                    btn.textContent = 'Run';
                    btn.disabled = false;
                }, 3000);
            } catch (error) {
                console.error('Setup failed:', error);
                btn.textContent = 'Failed';
                btn.disabled = false;
                setTimeout(() => { btn.textContent = 'Run'; }, 3000);
            }
        }
        
        function toggleDebugConsole() {
            const console = document.getElementById('debug-console');
            if (console.style.display === 'none') {
                console.style.display = 'block';
            } else {
                console.style.display = 'none';
            }
        }
        
        function clearDebugLog() {
            // Clear both debug consoles
            const setupConsole = document.getElementById('debug-console');
            if (setupConsole) {
                setupConsole.textContent = 'StenoAI Setup Debug Console\nCommands and output will appear here...\n\n';
            }
            
            const debugPanel = document.getElementById('debug-console-panel');
            if (debugPanel) {
                debugPanel.textContent = 'StenoAI Debug Console\nSession started - ready for activity...\n\n';
            }
        }

        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const formattedMessage = `[${timestamp}] ${message}\n`;
            
            // Log to setup wizard console if it exists (during setup)
            const setupConsole = document.getElementById('debug-console');
            if (setupConsole) {
                setupConsole.textContent += formattedMessage;
                setupConsole.scrollTop = setupConsole.scrollHeight;
            }
            
            // Always log to debug panel
            const debugPanel = document.getElementById('debug-console-panel');
            if (debugPanel) {
                debugPanel.textContent += formattedMessage;
                debugPanel.scrollTop = debugPanel.scrollHeight;
            }
        }
        
        
        async function clearSystemState() {
            const btn = document.getElementById('clear-state-btn');
            btn.textContent = 'Clearing...';
            btn.disabled = true;

            try {
                const result = await ipcRenderer.invoke('clear-state');
                if (result.success) {
                    btn.textContent = 'Done';
                    log('Manual state clear successful');
                } else {
                    btn.textContent = 'Failed';
                    log('Manual state clear failed: ' + result.error);
                }

                setTimeout(() => {
                    btn.textContent = 'Clear';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Clear state failed:', error);
                btn.textContent = 'Failed';
                btn.disabled = false;
                setTimeout(() => {
                    btn.textContent = 'Clear';
                }, 2000);
            }
        }
        
        async function loadStoragePath() {
            try {
                const result = await ipcRenderer.invoke('get-storage-path');
                const display = document.getElementById('storage-path-display');
                const resetBtn = document.getElementById('reset-storage-btn');
                if (result.success && result.storage_path) {
                    display.textContent = result.storage_path;
                    display.title = result.storage_path;
                    resetBtn.style.display = '';
                } else {
                    const defaultPath = require('path').join(require('os').homedir(), 'Library', 'Application Support', 'stenoai');
                    display.textContent = defaultPath;
                    display.title = 'Default location';
                    resetBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to load storage path:', error);
            }
        }

        async function chooseStorageLocation() {
            try {
                const folderResult = await ipcRenderer.invoke('select-storage-folder');
                if (!folderResult.success) return;

                const setResult = await ipcRenderer.invoke('set-storage-path', folderResult.folderPath);
                if (setResult.success) {
                    await loadStoragePath();
                    log('Storage location changed to: ' + folderResult.folderPath);
                } else {
                    log('Failed to set storage location: ' + (setResult.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Choose storage location failed:', error);
            }
        }

        async function resetStorageLocation() {
            try {
                const result = await ipcRenderer.invoke('set-storage-path', '');
                if (result.success) {
                    await loadStoragePath();
                    log('Storage location reset to default');
                }
            } catch (error) {
                console.error('Reset storage location failed:', error);
            }
        }

        async function testUpdateCheck() {
            const btn = document.getElementById('test-update-btn');
            btn.textContent = 'Checking...';
            btn.disabled = true;

            try {
                // Clear dismissals to force showing banner
                const keys = Object.keys(localStorage);
                keys.forEach(k => { if (k.startsWith('announcement-dismissed-')) localStorage.removeItem(k); });

                await runAnnouncementChecks();

                btn.textContent = 'Done';
                setTimeout(() => {
                    btn.textContent = 'Check';
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Announcement check test failed:', error);
                btn.textContent = 'Failed';
                btn.disabled = false;
                setTimeout(() => {
                    btn.textContent = 'Check';
                }, 2000);
            }
        }

        // Announcement system -- unified banner for updates + remote announcements

        const ANNOUNCEMENT_ICONS = {
            info: '<svg viewBox="0 0 20 20" fill="white"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/></svg>',
            release: '<svg viewBox="0 0 20 20" fill="white"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"/></svg>',
            warning: '<svg viewBox="0 0 20 20" fill="white"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>'
        };

        const ANNOUNCEMENT_PRIORITY = { warning: 3, release: 2, info: 1 };

        function compareVersions(a, b) {
            const pa = a.split('.').map(Number);
            const pb = b.split('.').map(Number);
            for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
                const na = pa[i] || 0;
                const nb = pb[i] || 0;
                if (na < nb) return -1;
                if (na > nb) return 1;
            }
            return 0;
        }

        async function fetchRemoteAnnouncements() {
            try {
                const result = await ipcRenderer.invoke('check-announcements');
                if (result.success) {
                    return { announcements: result.announcements, currentVersion: result.currentVersion };
                }
            } catch (error) {
                log(`Announcements fetch error: ${error.message}`);
            }
            return { announcements: [], currentVersion: null };
        }

        async function fetchUpdateAnnouncement() {
            try {
                log('Checking for updates...');
                const result = await ipcRenderer.invoke('check-for-updates');
                if (result.success && result.updateAvailable) {
                    log(`Update available: v${result.latestVersion}`);
                    return {
                        id: `update-${result.latestVersion}`,
                        type: 'release',
                        title: `Update available: v${result.latestVersion}`,
                        message: result.releaseName || 'A new version is available.',
                        action_url: result.releaseUrl || null,
                        action_label: 'Download Update',
                        min_version: null,
                        max_version: null,
                        created_at: new Date().toISOString(),
                        expires_at: null
                    };
                } else if (result.success) {
                    log(`Up to date: v${result.currentVersion}`);
                }
            } catch (error) {
                log(`Update check error: ${error.message}`);
            }
            return null;
        }

        function isAnnouncementDismissed(id) {
            return localStorage.getItem(`announcement-dismissed-${id}`) === 'true';
        }

        function dismissAnnouncement(id) {
            localStorage.setItem(`announcement-dismissed-${id}`, 'true');
        }

        function isAnnouncementExpired(ann) {
            if (!ann.expires_at) return false;
            return new Date(ann.expires_at) < new Date();
        }

        function isAnnouncementInVersionRange(ann, currentVersion) {
            if (!currentVersion) return true;
            if (ann.min_version && compareVersions(currentVersion, ann.min_version) < 0) return false;
            if (ann.max_version && compareVersions(currentVersion, ann.max_version) > 0) return false;
            return true;
        }

        function resolveAnnouncement(allAnnouncements, currentVersion) {
            const eligible = allAnnouncements.filter(ann => {
                if (isAnnouncementDismissed(ann.id)) return false;
                if (isAnnouncementExpired(ann)) return false;
                if (!isAnnouncementInVersionRange(ann, currentVersion)) return false;
                return true;
            });

            // Sort by priority (highest first), then by created_at (newest first)
            eligible.sort((a, b) => {
                const pa = ANNOUNCEMENT_PRIORITY[a.type] || 0;
                const pb = ANNOUNCEMENT_PRIORITY[b.type] || 0;
                if (pb !== pa) return pb - pa;
                return new Date(b.created_at) - new Date(a.created_at);
            });

            return eligible.length > 0 ? eligible[0] : null;
        }

        function showAnnouncementBanner(ann) {
            currentAnnouncement = ann;

            // Set type class
            announcementBanner.className = 'announcement-banner show type-' + ann.type;

            // Set icon
            announcementIcon.innerHTML = ANNOUNCEMENT_ICONS[ann.type] || ANNOUNCEMENT_ICONS.info;

            // Set text
            announcementTitle.textContent = ann.title;
            announcementMessage.textContent = ann.message;

            // Set action button
            if (ann.action_url) {
                announcementActionBtn.textContent = ann.action_label || 'Learn More';
                announcementActionBtn.style.display = '';
            } else {
                announcementActionBtn.style.display = 'none';
            }

            document.querySelector('.header').classList.add('with-announcement-banner');
            document.body.classList.add('announcement-visible');
            log(`Showing announcement: [${ann.type}] ${ann.title}`);
        }

        function hideAnnouncementBanner() {
            announcementBanner.className = 'announcement-banner';
            document.querySelector('.header').classList.remove('with-announcement-banner');
            document.body.classList.remove('announcement-visible');

            if (currentAnnouncement) {
                dismissAnnouncement(currentAnnouncement.id);
            }
            currentAnnouncement = null;
        }

        async function runAnnouncementChecks() {
            const [remoteData, updateAnn] = await Promise.all([
                fetchRemoteAnnouncements(),
                fetchUpdateAnnouncement()
            ]);

            const allAnnouncements = [...remoteData.announcements];
            // Only use auto-detected update if no eligible remote announcements
            const hasEligibleRemote = remoteData.announcements.some(a =>
                !isAnnouncementDismissed(a.id) && !isAnnouncementExpired(a)
            );
            if (updateAnn && !hasEligibleRemote) {
                allAnnouncements.push(updateAnn);
            }

            const winner = resolveAnnouncement(allAnnouncements, remoteData.currentVersion);
            if (winner) {
                showAnnouncementBanner(winner);
            } else {
                hideAnnouncementBanner();
            }
        }

        function startPeriodicAnnouncementCheck() {
            announcementCheckInterval = setInterval(runAnnouncementChecks, 6 * 60 * 60 * 1000);
        }

        function stopPeriodicAnnouncementCheck() {
            if (announcementCheckInterval) {
                clearInterval(announcementCheckInterval);
                announcementCheckInterval = null;
            }
        }

        // Announcement button event listeners
        announcementActionBtn.addEventListener('click', async () => {
            if (currentAnnouncement && currentAnnouncement.action_url) {
                try {
                    await ipcRenderer.invoke('open-release-page', currentAnnouncement.action_url);
                    log('Opened announcement action URL');
                    hideAnnouncementBanner();
                } catch (error) {
                    log(`Failed to open announcement URL: ${error.message}`);
                }
            }
        });

        dismissAnnouncementBtn.addEventListener('click', () => {
            hideAnnouncementBanner();
            log('Announcement dismissed');
        });

        // Theme functions
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(pref) {
            const eff = pref === 'system' ? getSystemTheme() : pref;
            if (eff === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }

        function initTheme() {
            const saved = localStorage.getItem('theme') || 'system';
            const themeSelect = document.getElementById('theme-select');
            if (themeSelect) {
                themeSelect.value = saved;
                themeSelect.addEventListener('change', (e) => {
                    const value = e.target.value;
                    localStorage.setItem('theme', value);
                    applyTheme(value);
                });
            }
            applyTheme(saved);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if ((localStorage.getItem('theme') || 'system') === 'system') {
                    applyTheme('system');
                }
            });
        }

        // Initialize theme early
        initTheme();

        // Initialize
        initializeApp().then(() => {
            runStartupCheck().then(() => {
                // Check for announcements and updates after app initialization
                setTimeout(() => {
                    runAnnouncementChecks();
                }, 2000);

                // Start periodic checks
                startPeriodicAnnouncementCheck();
            });
        });
    </script>
</body>
</html>
